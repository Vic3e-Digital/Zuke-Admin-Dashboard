<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add New Service | Model Playground</title>
  <link rel="stylesheet" href="../../css/formStyle.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
</head>

<body>
    <div class="container">
      
      <!-- Header -->
      <div class="header">
        <h1>Add New Service</h1>
        <p>Create service listing with AI-powered content generation</p>
      </div>
  
      <!-- 1. Service Details -->
      <div class="section">
        <div class="section-title">Service Information</div>
        
        <div class="form-group">
          <label for="serviceName">Service Name *</label>
          <input type="text" id="serviceName" placeholder="e.g., Professional Hair Styling" required>
        </div>
  
        <div class="form-group">
          <label for="serviceCategory">Category *</label>
          <select id="serviceCategory" required>
            <option value="">Loading categories...</option>
          </select>
        </div>
  
        <div class="form-group">
          <label>Pricing Structure (Select all that apply)</label>
          <div class="price-checkbox-group">
            <label class="price-checkbox-option" id="priceFixedOption">
              <input type="checkbox" id="priceFixedCheckbox">
              <span class="price-checkbox-label">Fixed Price</span>
            </label>
            <label class="price-checkbox-option" id="priceHourlyOption">
              <input type="checkbox" id="priceHourlyCheckbox">
              <span class="price-checkbox-label">Per Hour</span>
            </label>
            <label class="price-checkbox-option" id="priceRangeOption">
              <input type="checkbox" id="priceRangeCheckbox">
              <span class="price-checkbox-label">Price Range</span>
            </label>
            <label class="price-checkbox-option" id="priceDisabledOption">
              <input type="checkbox" id="priceDisabledCheckbox">
              <span class="price-checkbox-label">Disabled</span>
            </label>
          </div>
          <p class="field-note">Select pricing options or mark as disabled if pricing is not applicable</p>
        </div>
  
        <!-- Price Input Fields -->
        <div class="form-group hidden" id="priceFixedGroup">
          <label for="priceFixed">Fixed Price</label>
          <input type="number" id="priceFixed" placeholder="299.99" min="0" step="0.01">
        </div>
  
        <div class="form-group hidden" id="priceHourlyGroup">
          <label for="priceHourly">Hourly Rate</label>
          <input type="number" id="priceHourly" placeholder="Per hour rate" min="0" step="0.01">
        </div>
  
        <div class="form-group hidden" id="priceRangeGroup">
          <label>Price Range</label>
          <div class="price-inputs">
            <input type="number" id="priceMin" placeholder="Min" min="0" step="0.01">
            <input type="number" id="priceMax" placeholder="Max" min="0" step="0.01">
          </div>
        </div>
  
        <div class="form-group">
          <label>Service Delivery *</label>
          <div class="delivery-inline">
            <label class="checkbox-option" id="deliveryOnsite">
              <input type="checkbox" id="onSite">
              <div class="checkbox-label">
                <div class="checkbox-title">On-site / In-person</div>
                <div class="checkbox-desc">At customer location or premises</div>
              </div>
            </label>
  
            <label class="checkbox-option" id="deliveryRemote">
              <input type="checkbox" id="remote">
              <div class="checkbox-label">
                <div class="checkbox-title">Remote / Online</div>
                <div class="checkbox-desc">Virtual or online service</div>
              </div>
            </label>
          </div>
          <p class="field-note">Select all that apply</p>
        </div>
      </div>
  
      <!-- 2. Description with AI -->
      <div class="section">
        <div class="section-title">Service Description</div>
        
        <div class="form-group">
          <div class="description-header">
            <label for="serviceDescription">Description *</label>
            <button class="ai-enhance-btn" id="aiEnhanceBtn">
              <svg class="ai-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
              </svg>
              AI Enhance
            </button>
          </div>
          <textarea 
            id="serviceDescription" 
            placeholder="Describe your service in detail..."
            rows="5"
            required
          ></textarea>
          <p class="field-note">AI will enhance this based on your business information</p>
          
          <!-- AI Suggestions Dropdown -->
          <div class="suggestions-dropdown" id="suggestionsDropdown">
            <div class="suggestions-loading" id="suggestionsLoading">
              <div class="spinner"></div>
              <p style="margin-top: 8px;">Generating AI suggestions...</p>
            </div>
            <div id="suggestionsContent" class="hidden"></div>
          </div>
        </div>
  
        <div class="form-group">
          <label for="serviceIncludes">What's Included</label>
          <textarea 
            id="serviceIncludes" 
            placeholder="List what's included in this service (e.g., consultation, materials, follow-up, etc.)"
            rows="3"
          ></textarea>
        </div>
  
        <div class="form-group">
          <label for="serviceRequirements">Requirements / Preparation</label>
          <textarea 
            id="serviceRequirements" 
            placeholder="What does the customer need to prepare or bring? (optional)"
            rows="2"
          ></textarea>
        </div>
      </div>
  
      <!-- 3. Service Images -->
      <div class="section">
        <div class="section-title">Service Images</div>
  
        <div class="form-group">
          <label>Image Generation Mode</label>
          <div class="image-mode-toggle">
            <div class="image-mode-option">
              <input type="radio" id="modeUpload" name="imageMode" value="upload" checked>
              <label for="modeUpload" class="image-mode-label">
                <div class="image-mode-title">üì§ Upload & Enhance</div>
                <div class="image-mode-desc">Upload base image + generate variants</div>
              </label>
            </div>
            <div class="image-mode-option">
              <input type="radio" id="modeGenerate" name="imageMode" value="generate">
              <label for="modeGenerate" class="image-mode-label">
                <div class="image-mode-title">‚ú® Generate from Text</div>
                <div class="image-mode-desc">Create images from description only</div>
              </label>
            </div>
          </div>
        </div>
  
        <!-- Upload Mode -->
        <div id="uploadModeSection">
          <div class="form-group">
            <label>Upload Base Image (Optional)</label>
            <div class="upload-box" id="uploadBox">
              <div id="uploadPlaceholder">
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                </svg>
                <p style="font-weight: 600; margin-bottom: 5px; font-size: 14px;">Click or drag image here</p>
                <p style="color: var(--text-secondary); font-size: 12px;">JPG, PNG (max 10MB)</p>
              </div>
              <img id="uploadPreview" class="upload-preview" alt="Upload preview">
              <button id="removeImageBtn" class="remove-image-btn" style="display: none;">Remove</button>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            <p class="field-note">Upload a base image to enhance, or leave empty to generate from text below</p>
          </div>
  
          <div class="context-field">
            <label>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
              </svg>
              Image Generation Context *
            </label>
            <textarea 
              id="imageContext" 
              placeholder="Describe what you want in the images. E.g., 'Professional hair salon in Johannesburg, stylist working with client, modern interior, natural lighting, warm atmosphere, African clientele'..."
              rows="3"
            ></textarea>
            <p class="field-note">This will be used to enhance uploaded image or generate from scratch if no image is uploaded</p>
          </div>
        </div>
  
        <!-- Generate Mode -->
        <div id="generateModeSection" class="hidden">
          <div class="form-group">
            <label for="generationPrompt">Image Generation Prompt *</label>
            <textarea 
              id="generationPrompt" 
              placeholder="Describe the images you want to generate in detail. E.g., 'Professional hair salon in Johannesburg, modern interior, stylist working with client, natural lighting, warm atmosphere, African clientele, high-end commercial photography style'..."
              rows="5"
            ></textarea>
            <p class="field-note">Be specific about setting, people, mood, and style. AI will generate 3 variations per model.</p>
          </div>
        </div>
  
        <!-- AI Model Selection -->
        <div class="form-group">
          <label>AI Image Model *</label>
          <div class="model-selection">
            <label class="model-checkbox checked" id="fluxCheckbox">
              <input type="checkbox" id="useFlux" checked>
              <div class="model-checkbox-label">
                <div class="model-checkbox-title">FLUX Pro</div>
                <div class="model-checkbox-desc">Creative & Artistic</div>
              </div>
            </label>
            <label class="model-checkbox checked" id="dalleCheckbox">
              <input type="checkbox" id="useDalle" checked>
              <div class="model-checkbox-label">
                <div class="model-checkbox-title">DALL-E 3</div>
                <div class="model-checkbox-desc">Photorealistic</div>
              </div>
            </label>
          </div>
          <p class="field-note">Select one or both models. More models = more variants.</p>
        </div>
  
        <!-- Generate Button -->
        <button class="btn" id="generateVariantsBtn" disabled style="margin-top: 12px;">
          Generate Images (R10.00)
        </button>
        
        <!-- Progress -->
        <div class="progress" id="imageProgress">
          <p class="progress-text" id="imageProgressText">Generating images...</p>
          <div class="progress-bar">
            <div class="progress-fill" id="imageProgressFill"></div>
          </div>
        </div>
        
        <div class="status" id="imageStatus"></div>
        
        <!-- Variants Section -->
        <div id="variantsSection" class="hidden" style="margin-top: 16px;">
          
          <!-- Header with Download Button -->
          <div class="variants-header">
            <label style="margin: 0; font-weight: 600;">Generated Images</label>
            <button class="download-all-btn" id="downloadAllBtn" type="button">
              <svg class="download-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
              </svg>
              Download Selected
            </button>
          </div>
        
          <!-- Select All / Deselect All Controls -->
          <div class="variants-controls" id="variantsControls" style="display: none;">
            <div class="select-controls">
              <button class="select-btn" id="selectAllBtn" type="button">Select All</button>
              <button class="select-btn" id="deselectAllBtn" type="button">Deselect All</button>
            </div>
            <div class="selected-count">
              <span id="selectedCount">0</span> of <span id="totalCount">0</span> images selected
            </div>
          </div>
        
          <!-- Variants Grid -->
          <div class="variants-grid" id="variantsGrid"></div>
          
        </div>
      </div>
  
      <!-- 4. Additional Options -->
      <div class="section">
        <div class="section-title">Additional Options</div>
  
        <div class="checkbox-group">
          <label class="checkbox-option" id="videoOption">
            <input type="checkbox" id="generateVideo">
            <div class="checkbox-label">
              <div class="checkbox-title">Generate Service Video</div>
              <div class="checkbox-desc">Create promotional video with Veo AI</div>
            </div>
            <div class="checkbox-cost">+R80.00</div>
          </label>
  
          <label class="checkbox-option" id="socialOption">
            <input type="checkbox" id="postToSocials">
            <div class="checkbox-label">
              <div class="checkbox-title">Post to Social Media</div>
              <div class="checkbox-desc">Share on connected platforms</div>
            </div>
            <div class="checkbox-cost">+R10/platform</div>
          </label>
        </div>
      </div>
  
      <!-- 5. Review & Submit -->
      <div class="section">
        <div class="section-title">Review & Submit</div>
  
        <div class="cost-summary">
          <div style="font-weight: 600; margin-bottom: 8px; color: var(--dark-neutral);">Cost Summary</div>
          <div class="cost-line">
            <span>Service listing</span>
            <strong style="color: #28A745;">FREE</strong>
          </div>
          <div class="cost-line">
            <span>Image generation</span>
            <span id="costImages">R0.00</span>
          </div>
          <div class="cost-line">
            <span>Video generation</span>
            <span id="costVideo">R0.00</span>
          </div>
          <div class="cost-line">
            <span>Social media posting</span>
            <span id="costSocial">R0.00</span>
          </div>
          <hr class="cost-divider">
          <div class="cost-line">
            <strong>Total</strong>
            <span class="cost-total" id="costTotal">R0.00</span>
          </div>
        </div>
  
        <button class="btn" id="submitServiceBtn" disabled>
          Add Service to Catalog
        </button>
  
        <!-- Progress -->
        <div class="progress" id="submitProgress">
          <p class="progress-text" id="submitProgressText">Adding service...</p>
          <div class="progress-bar">
            <div class="progress-fill" id="submitProgressFill"></div>
          </div>
        </div>
  
        <div class="status" id="submitStatus"></div>
      </div>
  
    </div>


  <!-- Scripts -->
  <script src="/js/dataManager.js"></script>
  <script src="/js/wordpress-api.js"></script>
  <script src="/js/ai-generator.js"></script>
  
  <script>
    // ========== GLOBAL VARIABLES ==========
    let auth0Client = null;
    let currentBusiness = null;
    let openAIConfig = null;
    let wpAPI = null;
    let aiGenerator = null;
    
    let uploadedImage  = null;
    let generatedVariants = [];
    let wordpressImageIds = [];
    
    const urlParams = new URLSearchParams(window.location.search);
    const userEmail = urlParams.get('email');
    const businessId = urlParams.get('businessId');
    // const businessName = urlParams.get('businessName');
    
    // Parse business case data from URL
    let businessCase = {};
    let storeInfo = {};
    let businessName = '';

    
    
   // Try to get from parent window (if in iframe)
try {
  if (window.parent && window.parent.dataManager) {
    currentBusiness = window.parent.dataManager.getSelectedBusinessOrFirst();
    if (currentBusiness) {
      businessCase = currentBusiness.initial_business_case || {};
      storeInfo = currentBusiness.store_info || {};
      businessName = storeInfo.name || '';
      console.log('‚úÖ Loaded business data from parent dataManager');
    }
  }
} catch (e) {
  console.warn('Could not access parent dataManager:', e);
}

// Fallback: Try own window's dataManager
if (!businessName && window.dataManager) {
  currentBusiness = window.dataManager.getSelectedBusinessOrFirst();
  if (currentBusiness) {
    businessCase = currentBusiness.initial_business_case || {};
    storeInfo = currentBusiness.store_info || {};
    businessName = storeInfo.name || '';
    console.log('‚úÖ Loaded business data from own dataManager');
  }
}

// Final fallback: Fetch from backend if needed
if (!businessName && businessId && userEmail) {
  console.log('‚ö†Ô∏è Fetching business data from backend...');
  fetchBusinessDataFromBackend();
}

async function fetchBusinessDataFromBackend() {
  try {
    const response = await fetch(`/api/businesses/${businessId}?userEmail=${encodeURIComponent(userEmail)}`);
    if (response.ok) {
      const data = await response.json();
      currentBusiness = data.business;
      businessCase = currentBusiness.initial_business_case || {};
      storeInfo = currentBusiness.store_info || {};
      businessName = storeInfo.name || '';
      console.log('‚úÖ Loaded business data from backend');
    }
  } catch (error) {
    console.error('Error fetching business data:', error);
  }
}
  
    // Cloudinary config
    const CLOUDINARY_UPLOAD_PRESET = 'n8n-ai-preset';
    const CLOUDINARY_CLOUD_NAME = 'vic-3e';
  
    // Costs
    const COSTS = {
      AI_IDEAS: 1,
      IMAGE_VARIANTS: 10,
      VIDEO: 80,
      SOCIAL_PER_PLATFORM: 10
    };
  
    // ========== DOM ELEMENTS ==========
    const serviceNameInput = document.getElementById('serviceName');
    const serviceCategorySelect = document.getElementById('serviceCategory');
    const serviceDescriptionInput = document.getElementById('serviceDescription');
    const serviceIncludesInput = document.getElementById('serviceIncludes');
    const serviceRequirementsInput = document.getElementById('serviceRequirements');
    
    // Price checkboxes
    const priceFixedCheckbox = document.getElementById('priceFixedCheckbox');
    const priceHourlyCheckbox = document.getElementById('priceHourlyCheckbox');
    const priceRangeCheckbox = document.getElementById('priceRangeCheckbox');
    const priceDisabledCheckbox = document.getElementById('priceDisabledCheckbox');
    
    const priceFixedInput = document.getElementById('priceFixed');
    const priceHourlyInput = document.getElementById('priceHourly');
    const priceMinInput = document.getElementById('priceMin');
    const priceMaxInput = document.getElementById('priceMax');
    
    const onSiteCheckbox = document.getElementById('onSite');
    const remoteCheckbox = document.getElementById('remote');
    
    // Image mode
    const modeUploadRadio = document.getElementById('modeUpload');
    const modeGenerateRadio = document.getElementById('modeGenerate');
    const uploadModeSection = document.getElementById('uploadModeSection');
    const generateModeSection = document.getElementById('generateModeSection');
    
    const uploadBox = document.getElementById('uploadBox');
    const fileInput = document.getElementById('fileInput');
    const uploadPreview = document.getElementById('uploadPreview');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const removeImageBtn = document.getElementById('removeImageBtn');
    
    const imageContextInput = document.getElementById('imageContext');
    const generationPromptInput = document.getElementById('generationPrompt');
    
    const generateVariantsBtn = document.getElementById('generateVariantsBtn');
    const variantsSection = document.getElementById('variantsSection');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    
    const generateVideoCheckbox = document.getElementById('generateVideo');
    const postToSocialsCheckbox = document.getElementById('postToSocials');
    
    const submitServiceBtn = document.getElementById('submitServiceBtn');
    
    const aiEnhanceBtn = document.getElementById('aiEnhanceBtn');
    const suggestionsDropdown = document.getElementById('suggestionsDropdown');
    const suggestionsLoading = document.getElementById('suggestionsLoading');
    const suggestionsContent = document.getElementById('suggestionsContent');
    
    const useFluxCheckbox = document.getElementById('useFlux');
    const useDalleCheckbox = document.getElementById('useDalle');
  
    // ========== AUTH0 INITIALIZATION ==========
    async function getAuth0Client() {
      if (window.auth0Client) return window.auth0Client;
      
      try {
        const response = await fetch("/auth_config.json");
        const config = await response.json();
        auth0Client = await auth0.createAuth0Client({
          domain: config.domain,
          clientId: config.clientId,
          cacheLocation: 'localstorage',
          useRefreshTokens: true
        });
        window.auth0Client = auth0Client;
        return auth0Client;
      } catch (error) {
        console.error("Error configuring Auth0:", error);
        return null;
      }
    }
  
    // ========== FETCH OPENAI CONFIG ==========
    async function getOpenAIConfig() {
      if (openAIConfig) return openAIConfig;
      
      try {
        const response = await fetch('/api/get-openai-config');
        if (!response.ok) throw new Error('Failed to get OpenAI config');
        openAIConfig = await response.json();
        return openAIConfig;
      } catch (error) {
        console.error('Error fetching OpenAI config:', error);
        return null;
      }
    }
  
    // ========== LOAD BUSINESS INFO ==========
    async function loadBusinessInfo() {
      const auth0 = await getAuth0Client();
      if (!auth0) return;
  
      try {
        const isAuthenticated = await auth0.isAuthenticated();
        if (!isAuthenticated) {
          showStatus('Please log in to continue', 'error', document.getElementById('submitStatus'));
          return;
        }
  
        if (!businessCase.business_name) {
          currentBusiness = window.dataManager?.getSelectedBusinessOrFirst();
          if (currentBusiness) {
            businessCase = currentBusiness.initial_business_case || {};
            storeInfo = currentBusiness.store_info || {};
          }
        }
  
        wpAPI = await WordPressAPI.initialize();
        console.log('‚úÖ WordPress API initialized');
  
        const config = await getOpenAIConfig();
        if (config) {
          aiGenerator = new AIGenerator(config);
          console.log('‚úÖ AI Generator initialized');
        }
  
        await loadCategories();
  
      } catch (error) {
        console.error('Error loading business:', error);
      }
    }
  
    // ========== LOAD SERVICE CATEGORIES FROM WORDPRESS ==========
    async function loadCategories() {
  try {
    const categories = await wpAPI.getListingCategories();

    serviceCategorySelect.innerHTML = '<option value="">Select a category</option>';

    // ‚úÖ Find the main "Services" category
    const servicesParent = categories.find(
      cat => cat.name.toLowerCase() === 'services' && cat.parent === 0
    );

    if (!servicesParent) {
      console.warn("‚ö†Ô∏è 'Services' category not found in WordPress.");
      return;
    }

    // Add the main "Services" category
    const option = document.createElement('option');
    option.value = servicesParent.id;
    option.textContent = servicesParent.name;
    serviceCategorySelect.appendChild(option);

    // Add only the subcategories under "Services"
    const children = categories.filter(cat => cat.parent === servicesParent.id);
    children.forEach(child => {
      const childOption = document.createElement('option');
      childOption.value = child.id;
      childOption.textContent = `  ‚îî‚îÄ ${child.name}`;
      serviceCategorySelect.appendChild(childOption);
    });

    console.log('‚úÖ Service categories loaded:', children.length);

  } catch (error) {
    console.error('Error loading service categories:', error);
    serviceCategorySelect.innerHTML = `
      <option value="">Select a category</option>
      <option value="3">Services</option>
      <option value="4">Professional Services</option>
    `;
  }
}

    // ========== IMAGE MODE TOGGLE ==========
    [modeUploadRadio, modeGenerateRadio].forEach(radio => {
      radio.addEventListener('change', () => {
        if (modeUploadRadio.checked) {
          uploadModeSection.classList.remove('hidden');
          generateModeSection.classList.add('hidden');
          generationPromptInput.required = false;
          imageContextInput.required = true;
        } else {
          uploadModeSection.classList.add('hidden');
          generateModeSection.classList.remove('hidden');
          imageContextInput.required = false;
          generationPromptInput.required = true;
        }
        validateForm();
      });
    });
  
    // ========== IMAGE UPLOAD HANDLERS ==========
    uploadBox.addEventListener('click', () => {
      if (!uploadedImage) {
        fileInput.click();
      }
    });
  
    fileInput.addEventListener('change', (e) => {
      handleFileUpload(e.target.files[0]);
    });
  
    uploadBox.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadBox.style.borderColor = 'var(--primary-orange)';
      uploadBox.style.background = '#FFF8F0';
    });
  
    uploadBox.addEventListener('dragleave', () => {
      uploadBox.style.borderColor = 'var(--border-color)';
      uploadBox.style.background = 'var(--light-bg)';
    });
  
    uploadBox.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadBox.style.borderColor = 'var(--border-color)';
      uploadBox.style.background = 'var(--light-bg)';
      handleFileUpload(e.dataTransfer.files[0]);
    });
  
    function handleFileUpload(file) {
      if (!file || !file.type.startsWith('image/')) {
        showStatus('Please select an image file', 'error', document.getElementById('imageStatus'));
        return;
      }
  
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        showStatus('Image file is too large. Maximum size is 10MB.', 'error', document.getElementById('imageStatus'));
        return;
      }
  
      uploadedImage = file;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        uploadPreview.src = e.target.result;
        uploadPreview.style.display = 'block';
        uploadPlaceholder.style.display = 'none';
        removeImageBtn.style.display = 'inline-block';
        uploadBox.classList.add('has-image');
      };
      reader.readAsDataURL(file);
  
      validateForm();
    }
  
    removeImageBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      uploadedImage = null;
      generatedVariants = [];
      uploadPreview.style.display = 'none';
      uploadPreview.src = '';
      uploadPlaceholder.style.display = 'block';
      removeImageBtn.style.display = 'none';
      uploadBox.classList.remove('has-image');
      fileInput.value = '';
      variantsSection.classList.add('hidden');
      validateForm();
    });
  
    // ========== PRICE CHECKBOX HANDLERS ==========
    const priceCheckboxes = [priceFixedCheckbox, priceHourlyCheckbox, priceRangeCheckbox, priceDisabledCheckbox];
    const priceOptions = [
      document.getElementById('priceFixedOption'),
      document.getElementById('priceHourlyOption'),
      document.getElementById('priceRangeOption'),
      document.getElementById('priceDisabledOption')
    ];
    
    priceCheckboxes.forEach((checkbox, index) => {
      checkbox.addEventListener('change', () => {
        const option = priceOptions[index];
        
        if (checkbox.checked) {
          option.classList.add('checked');
          
          // If disabled is checked, uncheck and hide all others
          if (checkbox === priceDisabledCheckbox) {
            priceCheckboxes.forEach((cb, i) => {
              if (cb !== priceDisabledCheckbox) {
                cb.checked = false;
                priceOptions[i].classList.remove('checked');
              }
            });
            
            document.getElementById('priceFixedGroup').classList.add('hidden');
            document.getElementById('priceHourlyGroup').classList.add('hidden');
            document.getElementById('priceRangeGroup').classList.add('hidden');
          } else {
            // If any price option is checked, uncheck disabled
            priceDisabledCheckbox.checked = false;
            priceOptions[3].classList.remove('checked');
            
            // Show corresponding input
            if (checkbox === priceFixedCheckbox) {
              document.getElementById('priceFixedGroup').classList.remove('hidden');
            } else if (checkbox === priceHourlyCheckbox) {
              document.getElementById('priceHourlyGroup').classList.remove('hidden');
            } else if (checkbox === priceRangeCheckbox) {
              document.getElementById('priceRangeGroup').classList.remove('hidden');
            }
          }
        } else {
          option.classList.remove('checked');
          
          // Hide corresponding input
          if (checkbox === priceFixedCheckbox) {
            document.getElementById('priceFixedGroup').classList.add('hidden');
          } else if (checkbox === priceHourlyCheckbox) {
            document.getElementById('priceHourlyGroup').classList.add('hidden');
          } else if (checkbox === priceRangeCheckbox) {
            document.getElementById('priceRangeGroup').classList.add('hidden');
          }
        }
        
        validateForm();
      });
    });
  
    // ========== CHECKBOX STYLING ==========
    document.querySelectorAll('.checkbox-option').forEach(option => {
      const checkbox = option.querySelector('input[type="checkbox"]');
      checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
          option.classList.add('checked');
        } else {
          option.classList.remove('checked');
        }
        updateCostSummary();
        validateForm();
      });
    });
  
    // ========== MODEL CHECKBOX STYLING ==========
    [useFluxCheckbox, useDalleCheckbox].forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const parent = checkbox.closest('.model-checkbox');
        if (checkbox.checked) {
          parent.classList.add('checked');
        } else {
          parent.classList.remove('checked');
        }
        
        // Ensure at least one is selected
        if (!useFluxCheckbox.checked && !useDalleCheckbox.checked) {
          checkbox.checked = true;
          parent.classList.add('checked');
        }
      });
    });
  
    // ========== AI ENHANCE ==========
    aiEnhanceBtn.addEventListener('click', async () => {
      await fetchAIEnhancements();
    });
  
    async function fetchAIEnhancements() {
      suggestionsDropdown.classList.add('show');
      suggestionsLoading.style.display = 'block';
      suggestionsContent.classList.add('hidden');
  
      try {
        await deductCost(COSTS.AI_IDEAS, 'AI description enhancement');
  
        const serviceName = serviceNameInput.value || 'service';
        const currentDescription = serviceDescriptionInput.value || '';
        
        const location = storeInfo.address || businessCase.location || 'South Africa';
        const targetCustomers = businessCase.your_customers || 'general consumers';
        const businessProblem = businessCase.the_challenge || '';
        const solution = businessCase.your_solution || '';
        const whatYouDo = businessCase.what_you_do || '';
        
        const enhancedPrompt = `You are an expert service marketing copywriter. Enhance this service description using business context.
  
  **Business Context:**
  - Company: ${businessCase.business_name || businessName}
  - What they do: ${whatYouDo}
  - Target customers: ${targetCustomers}
  - Location: ${location}
  - Challenge they solve: ${businessProblem}
  - Their solution: ${solution}
  
  **Service Information:**
  - Service name: ${serviceName}
  - Current description: ${currentDescription || 'Not provided - create from scratch'}
  
  **Task:** Generate 3 enhanced service descriptions that:
  1. Incorporate the target demographic from business context
  2. Reference the location/region appropriately  
  3. Align with the business's mission and solution
  4. Are SEO-optimized and compelling
  5. Highlight benefits and outcomes for customers
  6. Build trust and credibility
  7. Are 2-3 paragraphs long and ready to use
  
  Return ONLY valid JSON:
  {
    "suggestions": [
      {
        "title": "Description Style (e.g., 'Results-Focused', 'Professional & Trustworthy', 'Personal Touch')",
        "description": "Full enhanced service description (2-3 paragraphs)"
      }
    ]
  }`;
  
        const config = await getOpenAIConfig();
        const url = `${config.endpoint}openai/deployments/${config.deployment}/chat/completions?api-version=2025-01-01-preview`;
  
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'api-key': config.apiKey
          },
          body: JSON.stringify({
            messages: [
              {
                role: "system",
                content: "You are an expert service marketing copywriter. Return valid JSON only."
              },
              {
                role: "user",
                content: enhancedPrompt
              }
            ],
            max_tokens: 1000,
            temperature: 0.7,
            response_format: { type: "json_object" }
          })
        });
  
        if (!response.ok) {
          throw new Error(`AI API error: ${response.status}`);
        }
  
        const data = await response.json();
        const content = data.choices[0].message.content;
        
        let result;
        try {
          result = JSON.parse(content);
        } catch (e) {
          const jsonMatch = content.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            result = JSON.parse(jsonMatch[0]);
          } else {
            throw new Error('Invalid JSON response');
          }
        }
        
        const suggestions = result.suggestions || [];
        
        if (suggestions.length === 0) {
          throw new Error('No suggestions generated');
        }
  
        suggestionsContent.innerHTML = '';
  
        suggestions.forEach((suggestion) => {
          const item = document.createElement('div');
          item.className = 'suggestion-item';
          
          item.innerHTML = `
            <div class="suggestion-item-title">${suggestion.title}</div>
            <div class="suggestion-item-preview">${suggestion.description.substring(0, 150)}...</div>
          `;
          
          item.addEventListener('click', () => {
            document.querySelectorAll('.suggestion-item').forEach(i =>               i.classList.remove('selected')
            );
            
            item.classList.add('selected');
            serviceDescriptionInput.value = suggestion.description;
            
            validateForm();
            
            setTimeout(() => {
              suggestionsDropdown.classList.remove('show');
            }, 500);
          });
          
          suggestionsContent.appendChild(item);
        });
        
        suggestionsLoading.style.display = 'none';
        suggestionsContent.classList.remove('hidden');
  
      } catch (error) {
        console.error('Error fetching AI enhancements:', error);
        suggestionsDropdown.classList.remove('show');
        showStatus(error.message, 'error', document.getElementById('imageStatus'));
      }
    }
  
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!suggestionsDropdown.contains(e.target) && e.target !== aiEnhanceBtn && !aiEnhanceBtn.contains(e.target)) {
        suggestionsDropdown.classList.remove('show');
      }
    });
  
    // ========== GENERATE IMAGE VARIANTS ==========
    generateVariantsBtn.addEventListener('click', async () => {
      await generateImageVariants();
    });
  
    async function generateImageVariants() {
      if (!aiGenerator) return;
  
      const useFlux = useFluxCheckbox.checked;
      const useDalle = useDalleCheckbox.checked;
      
      if (!useFlux && !useDalle) {
        showStatus('Please select at least one AI model', 'error', document.getElementById('imageStatus'));
        return;
      }
  
      const isUploadMode = modeUploadRadio.checked;
      const promptText = isUploadMode ? imageContextInput.value.trim() : generationPromptInput.value.trim();
      
      if (!promptText) {
        showStatus('Please provide context or prompt for image generation', 'error', document.getElementById('imageStatus'));
        return;
      }
      
      // In upload mode, check if we have image OR context
      if (isUploadMode && !uploadedImage && !promptText) {
        showStatus('Please upload an image or provide context for generation', 'error', document.getElementById('imageStatus'));
        return;
      }
  
      generateVariantsBtn.disabled = true;
      document.getElementById('imageProgress').style.display = 'block';
      document.getElementById('imageStatus').style.display = 'none';
      variantsSection.classList.remove('hidden');
      
      const variantsGrid = document.getElementById('variantsGrid');
      variantsGrid.innerHTML = '';
      generatedVariants = [];
  
      try {
        await deductCost(COSTS.IMAGE_VARIANTS, 'Image generation');
  
        const serviceName = serviceNameInput.value || 'service';
        const variantTypes = ['hero', 'action', 'results'];
        
        const location = storeInfo.address || businessCase.location || 'South Africa';
        const targetCustomers = businessCase.your_customers || '';
        const businessDescription = businessCase.what_you_do || '';
        
        // Build contextual prompts
        const contextualPrompts = {
          hero: `Professional service hero image for ${serviceName}. ${promptText}. Clean, inviting composition showing service quality and professionalism. ${location} setting, warm lighting, high-end commercial photography style.`,
          
          action: `Service in action: professional providing ${serviceName}. ${promptText}. ${targetCustomers ? `Working with ${targetCustomers}` : 'Interacting with client'}. Authentic ${location} setting, natural professional environment, expert at work, engaging composition.`,
          
          results: `Results showcase for ${serviceName}. ${promptText}. ${location} setting, satisfied customer or visible improvements, testimonial-worthy moment, professional documentation style.`
        };
        
        document.getElementById('imageProgressText').textContent = 'Generating images with AI...';
        document.getElementById('imageProgressFill').style.width = '10%';
  
        const modelsToUse = [];
        if (useFlux) modelsToUse.push('flux');
        if (useDalle) modelsToUse.push('dalle');
        
        let totalVariants = variantTypes.length * modelsToUse.length;
        let completedVariants = 0;
  
        let variantIndex = 0;
  
        // Generate progressively
        for (const model of modelsToUse) {
          for (const variantType of variantTypes) {
            const cardId = `variant_${variantType}_${model}_${Date.now()}_${variantIndex}`;
            const card = createVariantCard(cardId, variantType, model, 'generating');
  
            card.dataset.variantIndex = variantIndex;
  
            variantsGrid.appendChild(card);
            
            try {
              const prompt = contextualPrompts[variantType];
              
              document.getElementById('imageProgressText').textContent = 
                `Generating ${variantType} with ${model.toUpperCase()}... (${completedVariants + 1}/${totalVariants})`;
              
              let imageData;
              
              // If upload mode with image, use edit. Otherwise, generate from scratch
              if (isUploadMode && uploadedImage) {
                imageData = await aiGenerator.generateImageWithEdit(
                  uploadedImage,
                  prompt,
                  model
                );
              } else {
                // Generate from scratch
                imageData = await aiGenerator.generateImage(prompt, model);
              }
              
              updateVariantCard(cardId, imageData, 'generated');
              
              generatedVariants.push({
                type: `${variantType}_${model}`,
                displayType: variantType,
                model: model,
                imageData: imageData,
                prompt: prompt
              });
              
              completedVariants++;
              const progress = 10 + (completedVariants / totalVariants) * 85;
              document.getElementById('imageProgressFill').style.width = `${progress}%`;
              
              updateSelectedCount();
              
            } catch (error) {
              console.error(`Failed to generate ${variantType} with ${model}:`, error);
              updateVariantCard(cardId, null, 'failed');
            }
            variantIndex++;
          }
        }
  
        document.getElementById('imageProgressFill').style.width = '100%';
        
        showStatus(
          `Images generated!\n${generatedVariants.length} total images created\nCost: R${COSTS.IMAGE_VARIANTS.toFixed(2)}`,
          'success',
          document.getElementById('imageStatus')
        );
  
        updateCostSummary();
        validateForm();
  
      } catch (error) {
        console.error('Error generating images:', error);
        showStatus(error.message, 'error', document.getElementById('imageStatus'));
      } finally {
        document.getElementById('imageProgress').style.display = 'none';
        generateVariantsBtn.disabled = false;
      }
    }
  
    // ========== CREATE VARIANT CARD WITH CHECKBOX ==========
    function createVariantCard(cardId, variantType, model, state = 'generating') {
      const card = document.createElement('div');
      card.className = `variant-card ${state}`;
      card.id = cardId;
      card.dataset.selected = 'true';
      
      card.innerHTML = `
        <div class="variant-checkbox-container">
          <input 
            type="checkbox" 
            class="variant-checkbox" 
            checked
            ${state === 'generating' ? 'disabled' : ''}
          >
        </div>
        <div class="variant-image-container">
          ${state === 'generating' ? '<div class="variant-spinner"></div>' : ''}
          <img class="variant-image" alt="${variantType} ${model}">
        </div>
        <div class="variant-label">${capitalizeFirst(variantType)} - ${model.toUpperCase()}</div>
        <div class="variant-status">${state === 'generating' ? 'Generating...' : 'Pending'}</div>
      `;
      
      const checkbox = card.querySelector('.variant-checkbox');
      checkbox.addEventListener('change', (e) => {
        e.stopPropagation();
        toggleVariantSelection(cardId, checkbox.checked);
      });
      
      card.addEventListener('click', () => {
        if (state !== 'generating') {
          checkbox.checked = !checkbox.checked;
          toggleVariantSelection(cardId, checkbox.checked);
        }
      });
      
      return card;
    }
  
    // ========== UPDATE VARIANT CARD ==========
    function updateVariantCard(cardId, imageData, state) {
      const card = document.getElementById(cardId);
      if (!card) return;
      
      const img = card.querySelector('.variant-image');
      const status = card.querySelector('.variant-status');
      const spinner = card.querySelector('.variant-spinner');
      const checkbox = card.querySelector('.variant-checkbox');
      
      if (spinner) {
        spinner.remove();
      }
      
      card.className = `variant-card ${state}`;
      
      if (state === 'generated' && imageData) {
        const imageDataUrl = imageData.startsWith('http') 
          ? imageData 
          : `data:image/png;base64,${imageData}`;
        
        img.src = imageDataUrl;
        img.style.display = 'block';
        status.textContent = '‚úì Generated';
        
        checkbox.disabled = false;
        
        if (checkbox.checked) {
          card.classList.add('selected');
        }
        
      } else if (state === 'failed') {
        status.textContent = '‚úó Failed';
        card.style.borderColor = '#DC3545';
        card.style.background = '#FFF0F0';
        checkbox.disabled = true;
        checkbox.checked = false;
        card.dataset.selected = 'false';
      }
    }
  
    // ========== TOGGLE VARIANT SELECTION ==========
    function toggleVariantSelection(cardId, isSelected) {
      const card = document.getElementById(cardId);
      if (!card) return;
      
      card.dataset.selected = isSelected.toString();
      
      if (isSelected) {
        card.classList.add('selected');
        card.classList.remove('unselected');
      } else {
        card.classList.remove('selected');
        card.classList.add('unselected');
      }
      
      updateSelectedCount();
      validateForm();
    }
  
    // ========== UPDATE SELECTED COUNT ==========
    function updateSelectedCount() {
      const allCards = document.querySelectorAll('.variant-card[data-selected]');
      const selectedCards = document.querySelectorAll('.variant-card[data-selected="true"]');
      
      document.getElementById('selectedCount').textContent = selectedCards.length;
      document.getElementById('totalCount').textContent = allCards.length;
      
      const controls = document.getElementById('variantsControls');
      if (allCards.length > 0) {
        controls.style.display = 'flex';
      }
    }
  
    // ========== SELECT ALL ==========
    document.getElementById('selectAllBtn')?.addEventListener('click', () => {
      document.querySelectorAll('.variant-checkbox').forEach(checkbox => {
        if (!checkbox.disabled) {
          checkbox.checked = true;
          const card = checkbox.closest('.variant-card');
          toggleVariantSelection(card.id, true);
        }
      });
    });
  
    // ========== DESELECT ALL ==========
    document.getElementById('deselectAllBtn')?.addEventListener('click', () => {
      document.querySelectorAll('.variant-checkbox').forEach(checkbox => {
        if (!checkbox.disabled) {
          checkbox.checked = false;
          const card = checkbox.closest('.variant-card');
          toggleVariantSelection(card.id, false);
        }
      });
    });
  
    // ========== HELPER: CAPITALIZE FIRST LETTER ==========
    function capitalizeFirst(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }
  
    // ========== DOWNLOAD SELECTED IMAGES ==========
    downloadAllBtn.addEventListener('click', async () => {
      try {
        const selectedCards = document.querySelectorAll('.variant-card[data-selected="true"]');
        
        if (selectedCards.length === 0) {
          showStatus('No images selected', 'error', document.getElementById('imageStatus'));
          return;
        }
        
        const imagesToDownload = [];
        
        // Add original image if uploaded
        if (uploadedImage) {
          imagesToDownload.push({
            name: `0_original_${serviceNameInput.value || 'service'}.png`,
            blob: uploadedImage
          });
        }
        
        // Add selected variants
        selectedCards.forEach((card, index) => {
          const variantIndex = parseInt(card.dataset.variantIndex);
          const variant = generatedVariants[variantIndex];
          
          if (variant && variant.imageData) {
            const imageDataUrl = variant.imageData.startsWith('http') 
              ? variant.imageData 
              : `data:image/png;base64,${variant.imageData}`;
            
            imagesToDownload.push({
              name: `${uploadedImage ? index + 1 : index}_${variant.displayType}_${variant.model}_${serviceNameInput.value || 'service'}.png`,
              dataUrl: imageDataUrl
            });
          }
        });
        
        showStatus(`Downloading ${imagesToDownload.length} selected images...`, 'info', document.getElementById('imageStatus'));
        
        for (let i = 0; i < imagesToDownload.length; i++) {
          const img = imagesToDownload[i];
          
          let blob;
          if (img.blob) {
            blob = img.blob;
          } else {
            const response = await fetch(img.dataUrl);
            blob = await response.blob();
          }
          
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = img.name;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          await new Promise(resolve => setTimeout(resolve, 300));
        }
        
        showStatus(`${imagesToDownload.length} selected images downloaded!`, 'success', document.getElementById('imageStatus'));
        
      } catch (error) {
        console.error('Error downloading images:', error);
        showStatus('Failed to download images', 'error', document.getElementById('imageStatus'));
      }
    });
  
    // ========== UPLOAD ONLY SELECTED IMAGES ==========
    async function uploadImagesToCloudinaryAndWordPress() {
      const uploadedImages = [];
      
      // Upload original image if exists
      if (uploadedImage) {
        const originalCloudinaryUrl = await uploadFileToCloudinary(uploadedImage);
        const originalWpImage = await wpAPI.uploadImageFromUrl(
          originalCloudinaryUrl,
          'service-main.png',
          serviceNameInput.value || 'Service image'
        );
        
        uploadedImages.push({
          cloudinaryUrl: originalCloudinaryUrl,
          wordpressId: originalWpImage.id,
          wordpressUrl: originalWpImage.url
        });
      }
      
      // Get only selected variants
      const selectedVariants = generatedVariants.filter((variant, index) => {
        const cardId = document.querySelector(`[data-variant-index="${index}"]`)?.id;
        const card = document.getElementById(cardId);
        return card && card.dataset.selected === 'true';
      });
      
      // Upload selected variants
      for (let i = 0; i < selectedVariants.length; i++) {
        const variant = selectedVariants[i];
        const cloudinaryUrl = await uploadBase64ToCloudinary(variant.imageData);
        
        const wpImageName = `service-variant-${i + 1}.png`;
        const wpImage = await wpAPI.uploadImageFromUrl(
          cloudinaryUrl,
          wpImageName,
          `${serviceNameInput.value || 'Service'} - ${variant.displayType}`
        );
        
        uploadedImages.push({
          cloudinaryUrl: cloudinaryUrl,
          wordpressId: wpImage.id,
          wordpressUrl: wpImage.url
        });
      }
      
      return uploadedImages;
    }
  
    async function uploadBase64ToCloudinary(base64Data) {
      const byteCharacters = atob(base64Data);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray], { type: 'image/png' });
  
      return await uploadFileToCloudinary(blob);
    }
  
    async function uploadFileToCloudinary(file) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
      formData.append('folder', 'service-images');
  
      const response = await fetch(
        `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
        {
          method: 'POST',
          body: formData
        }
      );
  
      if (!response.ok) {
        throw new Error('Failed to upload to Cloudinary');
      }
  
      const data = await response.json();
      return data.secure_url;
    }
  
    // ========== DEDUCT COST FROM WALLET ==========
    async function deductCost(amount, description) {
      try {
        const response = await fetch('/api/social-post/post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            businessId: businessId,
            userEmail: userEmail,
            platforms: [],
            postContent: { text: description },
            totalCost: amount,
            skipPosting: true
          })
        });
  
        if (!response.ok) {
          const error = await response.json();
          
          if (response.status === 402) {
            throw new Error(
              `Insufficient funds!\n\nRequired: R${amount.toFixed(2)}\nBalance: ${error.formatted_balance}\n\nPlease add credits to continue.`
            );
          }
          
          throw new Error(error.error || 'Payment failed');
        }
  
        const result = await response.json();
        console.log(`‚úÖ ${description} cost deducted: R${amount.toFixed(2)}`);
        return result;
  
      } catch (error) {
        throw error;
      }
    }
  
    // ========== UPDATE COST SUMMARY ==========
    function updateCostSummary() {
      let imagesCost = generatedVariants.length > 0 ? COSTS.IMAGE_VARIANTS : 0;
      let videoCost = generateVideoCheckbox.checked ? COSTS.VIDEO : 0;
      let socialCost = postToSocialsCheckbox.checked ? COSTS.SOCIAL_PER_PLATFORM * 3 : 0;
      
      document.getElementById('costImages').textContent = `R${imagesCost.toFixed(2)}`;
      document.getElementById('costVideo').textContent = `R${videoCost.toFixed(2)}`;
      document.getElementById('costSocial').textContent = `R${socialCost.toFixed(2)}`;
      
      const total = imagesCost + videoCost + socialCost;
      document.getElementById('costTotal').textContent = `R${total.toFixed(2)}`;
    }
  
    // ========== VALIDATE FORM ==========
    function validateForm() {
      const hasName = serviceNameInput.value.trim().length > 0;
      const hasCategory = serviceCategorySelect.value !== '';
      const hasDescription = serviceDescriptionInput.value.trim().length > 20;
      
      // Check if at least one variant is selected
      const hasSelectedVariants = document.querySelectorAll('.variant-card[data-selected="true"]').length > 0;
      
      // Check delivery method
      const hasDeliveryMethod = onSiteCheckbox.checked || remoteCheckbox.checked;
      
      // Validate pricing - either disabled OR at least one valid price
      const isPriceDisabled = priceDisabledCheckbox.checked;
      let hasValidPrice = isPriceDisabled;
      
      if (!isPriceDisabled) {
        // Check if at least one pricing option is selected and valid
        if (priceFixedCheckbox.checked) {
          hasValidPrice = priceFixedInput.value && parseFloat(priceFixedInput.value) > 0;
        }
        
        if (priceHourlyCheckbox.checked && !hasValidPrice) {
          hasValidPrice = priceHourlyInput.value && parseFloat(priceHourlyInput.value) > 0;
        }
        
        if (priceRangeCheckbox.checked && !hasValidPrice) {
          const min = parseFloat(priceMinInput.value);
          const max = parseFloat(priceMaxInput.value);
          hasValidPrice = min > 0 && max > 0 && max > min;
        }
        
        // If no price options selected and not disabled, invalid
        if (!priceFixedCheckbox.checked && !priceHourlyCheckbox.checked && !priceRangeCheckbox.checked) {
          hasValidPrice = false;
        }
      }
      
      // Check image generation readiness
      const imageMode = modeUploadRadio.checked ? 'upload' : 'generate';
      let canGenerateImages = false;
      
      if (imageMode === 'upload') {
        // Can generate if we have context (with or without uploaded image)
        canGenerateImages = imageContextInput.value.trim().length > 0;
      } else {
        // Generate mode needs prompt
        canGenerateImages = generationPromptInput.value.trim().length > 0;
      }
      
      // Enable generate button if we can generate
      generateVariantsBtn.disabled = !canGenerateImages;
      
      const isValid = hasName && hasCategory && hasDescription && hasSelectedVariants && hasValidPrice && hasDeliveryMethod;
      
      submitServiceBtn.disabled = !isValid;
      
      return isValid;
    }
  
    [serviceNameInput, serviceCategorySelect, serviceDescriptionInput, serviceIncludesInput, serviceRequirementsInput, priceFixedInput, priceHourlyInput, priceMinInput, priceMaxInput, imageContextInput, generationPromptInput].forEach(input => {
      input.addEventListener('input', validateForm);
      input.addEventListener('change', validateForm);
    });
  
    // ========== SUBMIT SERVICE ==========
    submitServiceBtn.addEventListener('click', async () => {
      await submitService();
    });
  
    async function submitService() {
      if (!validateForm()) {
        showStatus('Please fill in all required fields', 'error', document.getElementById('submitStatus'));
        return;
      }
  
      submitServiceBtn.disabled = true;
      document.getElementById('submitProgress').style.display = 'block';
      document.getElementById('submitStatus').style.display = 'none';
      document.getElementById('submitProgressFill').style.width = '10%';
  
      try {
        // ========== 1. UPLOAD IMAGES TO CLOUDINARY & WORDPRESS ==========
        document.getElementById('submitProgressText').textContent = 'Uploading images to WordPress...';
        document.getElementById('submitProgressFill').style.width = '20%';
  
        const uploadedImages = await uploadImagesToCloudinaryAndWordPress();
        wordpressImageIds = uploadedImages.map(img => img.wordpressId);
  
        console.log('‚úÖ Images uploaded. WordPress IDs:', wordpressImageIds);
  
        document.getElementById('submitProgressFill').style.width = '40%';
  
        // ========== 2. GENERATE VIDEO (OPTIONAL) ==========
        let videoUrl = null;
        if (generateVideoCheckbox.checked) {
          document.getElementById('submitProgressText').textContent = 'Generating service video...';
          document.getElementById('submitProgressFill').style.width = '50%';
          
          await deductCost(COSTS.VIDEO, 'Service video generation');
          
          console.log('Video generation not yet implemented');
          
          document.getElementById('submitProgressFill').style.width = '60%';
        }
  
        // ========== 3. PREPARE SERVICE DATA ==========
        document.getElementById('submitProgressText').textContent = 'Preparing service data...';
        document.getElementById('submitProgressFill').style.width = '70%';
  
        // Build pricing data
        const pricingData = [];
        
        if (priceDisabledCheckbox.checked) {
          pricingData.push({ type: 'disabled', display: 'Price on request' });
        } else {
          if (priceFixedCheckbox.checked && priceFixedInput.value) {
            const value = parseFloat(priceFixedInput.value);
            pricingData.push({
              type: 'fixed',
              value: value,
              display: `R${value.toFixed(2)}`
            });
          }
          
          if (priceHourlyCheckbox.checked && priceHourlyInput.value) {
            const value = parseFloat(priceHourlyInput.value);
            pricingData.push({
              type: 'hourly',
              value: value,
              display: `R${value.toFixed(2)}/hour`
            });
          }
          
          if (priceRangeCheckbox.checked && priceMinInput.value && priceMaxInput.value) {
            const min = parseFloat(priceMinInput.value);
            const max = parseFloat(priceMaxInput.value);
            pricingData.push({
              type: 'range',
              min: min,
              max: max,
              display: `R${min.toFixed(2)} - R${max.toFixed(2)}`
            });
          }
        }
  
        // Get delivery methods
        const deliveryMethods = [];
        if (onSiteCheckbox.checked) deliveryMethods.push('on-site');
        if (remoteCheckbox.checked) deliveryMethods.push('remote');
  
        // ========== 4. BUILD WEBHOOK PAYLOAD ==========
        const webhookPayload = {
          businessId: businessId,
          userEmail: userEmail,
          serviceData: {
            name: serviceNameInput.value,
            description: serviceDescriptionInput.value,
            includes: serviceIncludesInput.value,
            requirements: serviceRequirementsInput.value,
            category: serviceCategorySelect.options[serviceCategorySelect.selectedIndex].text,
            categoryId: parseInt(serviceCategorySelect.value),
            
            pricing: pricingData,
            deliveryMethods: deliveryMethods,
            
            // WordPress Image IDs
            wordpressImageIds: wordpressImageIds,
            featuredImageId: wordpressImageIds[0],
            galleryImageIds: wordpressImageIds.slice(1),
            
            // Image URLs
            images: uploadedImages.map(img => ({
              cloudinaryUrl: img.cloudinaryUrl,
              wordpressId: img.wordpressId,
              wordpressUrl: img.wordpressUrl
            })),
            
            videoUrl: videoUrl,
            hasVideo: generateVideoCheckbox.checked,
            postedToSocials: postToSocialsCheckbox.checked,
            
            aiModelsUsed: {
              flux: useFluxCheckbox.checked,
              dalle: useDalleCheckbox.checked
            },
            imageGenerationMode: modeUploadRadio.checked ? 'upload' : 'generate',
            imageContext: modeUploadRadio.checked ? imageContextInput.value.trim() : generationPromptInput.value.trim()
          },
          
          businessContext: {
            businessName: businessCase.business_name,
            location: storeInfo.address,
            targetCustomers: businessCase.your_customers
          },
          
          timestamp: new Date().toISOString(),
          
          generationCosts: {
            aiIdeas: COSTS.AI_IDEAS,
            images: generatedVariants.length > 0 ? COSTS.IMAGE_VARIANTS : 0,
            video: generateVideoCheckbox.checked ? COSTS.VIDEO : 0,
            social: postToSocialsCheckbox.checked ? COSTS.SOCIAL_PER_PLATFORM * 3 : 0,
            total: calculateTotalCost()
          }
        };
  
        document.getElementById('submitProgressFill').style.width = '80%';
  
        // ========== 5. POST TO SOCIALS (OPTIONAL) ==========
        if (postToSocialsCheckbox.checked) {
          document.getElementById('submitProgressText').textContent = 'Posting to social media...';
          
          const socialCost = COSTS.SOCIAL_PER_PLATFORM * 3;
          await deductCost(socialCost, 'Social media posting');
        }
  
        document.getElementById('submitProgressFill').style.width = '85%';
  
        // ========== 6. SEND TO WEBHOOK ==========
        document.getElementById('submitProgressText').textContent = 'Sending to webhook...';
        
        console.log('üì§ Sending webhook payload:', JSON.stringify(webhookPayload, null, 2));
        console.log('üì§ Payload size:', JSON.stringify(webhookPayload).length, 'bytes');
        
        const webhookResponse = await fetch('/api/webhook/service-created', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(webhookPayload)
        });
  
        console.log('üì• Webhook response status:', webhookResponse.status);
        
        const webhookData = await webhookResponse.json().catch(() => ({ error: 'No JSON response' }));
        console.log('üì• Webhook response data:', webhookData);
  
        if (!webhookResponse.ok) {
          throw new Error('Webhook failed');
        }
  
        document.getElementById('submitProgressFill').style.width = '90%';
  
        // ========== 7. LOG TO DATABASE ==========
        document.getElementById('submitProgressText').textContent = 'Saving to database...';
        
        await fetch('/api/services/log', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(webhookPayload)
        });
  
        document.getElementById('submitProgressFill').style.width = '100%';
  
        // ========== 8. SUCCESS ==========
        const pricingDisplay = pricingData.map(p => p.display).join(', ');
        
        showStatus(
          `Service data sent successfully!\n\n` +
          `Service: ${serviceNameInput.value}\n` +
          `Images uploaded: ${uploadedImages.length}\n` +
          `WordPress Image IDs: ${wordpressImageIds.join(', ')}\n` +
          `Pricing: ${pricingDisplay}\n` +
          `Delivery methods: ${deliveryMethods.join(', ')}\n\n` +
          `Data sent to webhook for listing creation.`,
          'success',
          document.getElementById('submitStatus')
        );
  
        setTimeout(() => {
          if (confirm('Service data sent successfully! Add another service?')) {
            resetForm();
          } else {
            window.location.href = `/dashboard.html?email=${userEmail}&businessId=${businessId}`;
          }
        }, 50000);
  
      } catch (error) {
        console.error('Error submitting service:', error);
        showStatus(error.message, 'error', document.getElementById('submitStatus'));
      } finally {
        document.getElementById('submitProgress').style.display = 'none';
        submitServiceBtn.disabled = false;
      }
    }
  
    // ========== CALCULATE TOTAL COST ==========
    function calculateTotalCost() {
      let total = 0;
      
      if (generatedVariants.length > 0) {
        total += COSTS.IMAGE_VARIANTS;
      }
      
      if (generateVideoCheckbox.checked) {
        total += COSTS.VIDEO;
      }
      
      if (postToSocialsCheckbox.checked) {
        total += COSTS.SOCIAL_PER_PLATFORM * 3;
      }
      
      return total;
    }
  
    // ========== SHOW STATUS ==========
    function showStatus(message, type, targetElement) {
      targetElement.textContent = message;
      targetElement.className = `status ${type}`;
      targetElement.style.display = 'block';
    }
  
    // ========== RESET FORM ==========
    function resetForm() {
      serviceNameInput.value = '';
      serviceCategorySelect.value = '';
      serviceDescriptionInput.value = '';
      serviceIncludesInput.value = '';
      serviceRequirementsInput.value = '';
      imageContextInput.value = '';
      generationPromptInput.value = '';
      
      // Reset price checkboxes
      priceCheckboxes.forEach((checkbox, index) => {
        checkbox.checked = false;
        priceOptions[index].classList.remove('checked');
      });
      
      document.getElementById('priceFixedGroup').classList.add('hidden');
      document.getElementById('priceHourlyGroup').classList.add('hidden');
      document.getElementById('priceRangeGroup').classList.add('hidden');
      
      priceFixedInput.value = '';
      priceHourlyInput.value = '';
      priceMinInput.value = '';
      priceMaxInput.value = '';
      
      onSiteCheckbox.checked = false;
      remoteCheckbox.checked = false;
      document.getElementById('deliveryOnsite').classList.remove('checked');
      document.getElementById('deliveryRemote').classList.remove('checked');
      
      uploadedImage = null;
      generatedVariants = [];
      wordpressImageIds = [];
      
      uploadPreview.style.display = 'none';
      uploadPreview.src = '';
      uploadPlaceholder.style.display = 'block';
      removeImageBtn.style.display = 'none';
      uploadBox.classList.remove('has-image');
      fileInput.value = '';
      
      generateVariantsBtn.disabled = true;
      variantsSection.classList.add('hidden');
      
      const variantsGrid = document.getElementById('variantsGrid');
      if (variantsGrid) {
        variantsGrid.innerHTML = '';
      }
      
      generateVideoCheckbox.checked = false;
      postToSocialsCheckbox.checked = false;
      
      useFluxCheckbox.checked = true;
      useDalleCheckbox.checked = true;
      document.getElementById('fluxCheckbox').classList.add('checked');
      document.getElementById('dalleCheckbox').classList.add('checked');
      
      document.querySelectorAll('.checkbox-option').forEach(option => {
        option.classList.remove('checked');
      });
      
      // Reset to upload mode
      modeUploadRadio.checked = true;
      uploadModeSection.classList.remove('hidden');
      generateModeSection.classList.add('hidden');
      
      suggestionsDropdown.classList.remove('show');
      
      document.getElementById('submitStatus').style.display = 'none';
      document.getElementById('imageStatus').style.display = 'none';
      
      updateCostSummary();
      validateForm();
    }
  
    // ========== INITIALIZE ON PAGE LOAD ==========
    document.addEventListener('DOMContentLoaded', async () => {
      await loadBusinessInfo();
      validateForm();
      updateCostSummary();
      
      // Log business context for debugging
      console.log('üìä Business Context:', {
        businessName: businessCase.business_name,
        location: storeInfo.address,
        targetCustomers: businessCase.your_customers,
        whatYouDo: businessCase.what_you_do
      });
    });
  </script>
</body>
</html>
