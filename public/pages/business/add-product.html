<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add New Product</title>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary-orange: #FF8B00;
      --alt-orange: #FF7B00;
      --dark-neutral: #2F2F2F;
      --darker-neutral: #2D2D2D;
      --light-bg: #FAFAFA;
      --border-color: #E0E0E0;
      --text-primary: #2F2F2F;
      --text-secondary: #666;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 20px;
      background: var(--light-bg);
      color: var(--text-primary);
    }
    
    .container { 
      max-width: 700px; 
      margin: 0 auto; 
    }
    
    /* Header */
    .header {
      background: white;
      border-radius: 8px;
      padding: 20px 24px;
      margin-bottom: 16px;
      border-left: 4px solid var(--primary-orange);
    }
    
    .header h1 {
      font-size: 20px;
      font-weight: 600;
      color: var(--dark-neutral);
      margin-bottom: 4px;
    }
    
    .header p {
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    /* Section */
    .section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 12px;
      border: 1px solid var(--border-color);
    }
    
    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--dark-neutral);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Form Groups */
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 13px;
      color: var(--text-primary);
    }
    
    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    textarea {
      resize: vertical;
      min-height: 90px;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary-orange);
      box-shadow: 0 0 0 3px rgba(255, 139, 0, 0.1);
    }
    
    .field-note {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    
    /* AI Button in Description */
    .description-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .ai-enhance-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, var(--primary-orange), var(--alt-orange));
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .ai-enhance-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 139, 0, 0.3);
    }
    
    .ai-enhance-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .ai-icon {
      width: 14px;
      height: 14px;
    }
    
    /* AI Suggestions Dropdown */
    .suggestions-dropdown {
      display: none;
      margin-top: 8px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: white;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .suggestions-dropdown.show {
      display: block;
      animation: slideDown 0.2s ease;
    }
    
    .suggestion-item {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-item:hover {
      background: #FFF8F0;
    }
    
    .suggestion-item.selected {
      background: #FFF0E0;
      border-left: 3px solid var(--primary-orange);
    }
    
    .suggestion-item-title {
      font-weight: 600;
      font-size: 13px;
      color: var(--dark-neutral);
      margin-bottom: 4px;
    }
    
    .suggestion-item-preview {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.4;
    }
    
    .suggestions-loading {
      padding: 20px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 13px;
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      border-top: 2px solid var(--primary-orange);
      border-radius: 50%;
      display: inline-block;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Price Type Toggle */
    .price-type-toggle {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .price-type-option {
      position: relative;
    }
    
    .price-type-option input[type="radio"] {
      position: absolute;
      opacity: 0;
    }
    
    .price-type-label {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      font-weight: 500;
    }
    
    .price-type-option input[type="radio"]:checked + .price-type-label {
      border-color: var(--primary-orange);
      background: #FFF8F0;
      color: var(--primary-orange);
    }
    
    .price-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .price-inputs.single {
      grid-template-columns: 1fr;
    }
    
    /* Upload Box */
    .upload-box {
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      background: var(--light-bg);
      transition: all 0.2s;
    }
    
    .upload-box:hover {
      border-color: var(--primary-orange);
      background: #FFF8F0;
    }
    
    .upload-box.has-image {
      padding: 12px;
      border-style: solid;
    }
    
    .upload-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      opacity: 0.4;
    }
    
    .upload-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: 6px;
      margin-bottom: 12px;
      display: none;
      object-fit: contain;
      background: #f5f5f5;
    }
    
    .remove-image-btn {
      padding: 6px 12px;
      background: #DC3545;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
    }
    
    /* Image Variants */
    .variants-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .download-all-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--dark-neutral);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .download-all-btn:hover {
      background: var(--darker-neutral);
    }
    
    .download-icon {
      width: 14px;
      height: 14px;
    }
    
    .variants-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 12px;
    }
    
    /* .variant-card {
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px;
      text-align: center;
      background: var(--light-bg);
    }
    
    .variant-card.generated {
      border-color: #28A745;
      background: #F0FFF4;
    } */
    
    .variant-image-container {
        width: 100%;
        height: 150px; /* Fixed height like the preview */
        border-radius: 4px;
        overflow: hidden;
        background: #f5f5f5; /* Light background like the preview */
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        }

    
        .variant-image {
        max-width: 100%;
        max-height: 100%;
        width: auto; /* ✅ Let it size naturally */
        height: auto; /* ✅ Let it size naturally */
        object-fit: contain; /* ✅ CONTAIN instead of COVER - shows full image */
        display: none;
        }

        .variant-card {
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 8px;
        text-align: center;
        background: var(--light-bg);
        min-width: 160px; /* Slightly wider to accommodate images */
        max-width: 160px;
        flex-shrink: 0;
        transition: all 0.3s ease;
        cursor: pointer;
        }   

    .variant-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .variant-status {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    
    .variant-card.generating {
  cursor: default;
}

    .variant-checkbox-container {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
    pointer-events: auto;
    }

    .variant-checkbox {
    width: 24px;
    height: 24px;
    cursor: pointer;
    accent-color: var(--primary-orange);
    }

    .variant-card.selected {
    border: 2px solid var(--primary-orange);
    box-shadow: 0 4px 12px rgba(255, 111, 15, 0.3);
    }

    .variant-card.unselected {
    opacity: 0.6;
    filter: grayscale(30%);
    }

    /* Select All Controls */
    .variants-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px;
    background: var(--light-bg);
    border-radius: 8px;
    }

    .select-controls {
    display: flex;
    gap: 10px;
    }

    .select-btn {
    padding: 8px 16px;
    border: 1px solid var(--border-color);
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    }

    .select-btn:hover {
    background: var(--primary-orange);
    color: white;
    border-color: var(--primary-orange);
    }

    .selected-count {
    color: var(--text-secondary);
    font-size: 14px;
    }
    
    /* Checkboxes */
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .checkbox-option {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .checkbox-option:hover {
      border-color: var(--primary-orange);
      background: #FFF8F0;
    }
    
    .checkbox-option input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 12px;
      cursor: pointer;
      accent-color: var(--primary-orange);
    }
    
    .checkbox-option.checked {
      border-color: var(--primary-orange);
      background: #FFF8F0;
    }
    
    .checkbox-label {
      display: flex;
      flex-direction: column;
      flex: 1;
    }
    
    .checkbox-title {
      font-weight: 600;
      font-size: 13px;
      color: var(--dark-neutral);
      margin-bottom: 2px;
    }
    
    .checkbox-desc {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .checkbox-cost {
      font-weight: 600;
      color: var(--primary-orange);
      margin-left: auto;
      font-size: 13px;
    }
    
    /* Buttons */
    .btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, var(--primary-orange), var(--alt-orange));
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 139, 0, 0.3);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Cost Summary */
    .cost-summary {
      background: #FFF8F0;
      border: 1px solid var(--primary-orange);
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .cost-summary strong {
      color: var(--primary-orange);
    }
    
    .cost-line {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 13px;
      color: var(--text-primary);
    }
    
    .cost-divider {
      margin: 8px 0;
      border: none;
      border-top: 1px solid var(--primary-orange);
      opacity: 0.3;
    }
    
    .cost-total {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary-orange);
    }
    
    /* Progress & Status */
    .progress {
      display: none;
      margin-top: 12px;
    }
    
    .progress-text {
      color: var(--primary-orange);
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 13px;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border-color);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-orange), var(--alt-orange));
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .status {
      margin-top: 12px;
      padding: 12px;
      border-radius: 6px;
      display: none;
      font-size: 13px;
      white-space: pre-wrap;
    }
    
    .status.success { background: #D4EDDA; color: #155724; border: 1px solid #28A745; }
    .status.error { background: #F8D7DA; color: #721C24; border: 1px solid #DC3545; }
    .status.info { background: #D1ECF1; color: #0C5460; border: 1px solid #17A2B8; }
    
    .hidden { display: none !important; }

    .model-selection {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .model-checkbox {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      flex: 1;
    }
    
    .model-checkbox:hover {
      border-color: var(--primary-orange);
      background: #FFF8F0;
    }
    
    .model-checkbox.checked {
      border-color: var(--primary-orange);
      background: #FFF8F0;
    }
    
    .model-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      cursor: pointer;
      accent-color: var(--primary-orange);
    }
    
    .model-checkbox-label {
      flex: 1;
    }
    
    .model-checkbox-title {
      font-weight: 600;
      font-size: 13px;
      color: var(--dark-neutral);
    }
    
    .model-checkbox-desc {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    
    .context-field {
      margin-bottom: 16px;
      padding: 12px;
      background: #F9F9F9;
      border-radius: 6px;
      border: 1px dashed var(--border-color);
    }
    
    .context-field label {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .context-field textarea {
      min-height: 60px;
      font-size: 13px;
    }
    /* Horizontal Scrollable Variants */
.variants-section-wrapper {
  margin-top: 16px;
}

.variants-grid {
  display: flex;
  gap: 12px;
  overflow-x: auto;
  padding-bottom: 12px;
  scroll-behavior: smooth;
}

.variants-grid::-webkit-scrollbar {
  height: 8px;
}

.variants-grid::-webkit-scrollbar-track {
  background: var(--light-bg);
  border-radius: 4px;
}

.variants-grid::-webkit-scrollbar-thumb {
  background: var(--primary-orange);
  border-radius: 4px;
}

.variants-grid::-webkit-scrollbar-thumb:hover {
  background: var(--alt-orange);
}

.variant-card {
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 8px;
  text-align: center;
  background: var(--light-bg);
  min-width: 180px;
  flex-shrink: 0;
  transition: all 0.3s ease;
}

.variant-card.generating {
  opacity: 0.6;
}

.variant-card.generated {
  border-color: #28A745;
  background: #F0FFF4;
  opacity: 1;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.variant-image-container {
  width: 100%;
  aspect-ratio: 1;
  border-radius: 4px;
  overflow: hidden;
  background: #e0e0e0;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.variant-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: none;
}

.variant-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-primary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.variant-status {
  font-size: 10px;
  color: var(--text-secondary);
  margin-top: 4px;
}

/* Loading spinner for generating variants */
.variant-spinner {
  width: 30px;
  height: 30px;
  border: 3px solid var(--border-color);
  border-top: 3px solid var(--primary-orange);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  position: absolute;
}

  </style>
</head>
<body>
  <div class="container">
    
    <!-- Header -->
    <div class="header">
      <h1>Add New Product</h1>
      <p>Create product listing with AI-powered content generation</p>
    </div>

    <!-- 1. Product Details -->
    <div class="section">
      <div class="section-title">Product Information</div>
      
      <div class="form-group">
        <label for="productName">Product Name *</label>
        <input type="text" id="productName" placeholder="Enter product name" required>
      </div>

      <div class="form-group">
        <label for="productCategory">Category *</label>
        <select id="productCategory" required>
          <option value="">Loading categories...</option>
        </select>
      </div>

      <div class="form-group">
        <label>Price Type *</label>
        <div class="price-type-toggle">
          <div class="price-type-option">
            <input type="radio" id="priceTypeFixed" name="priceType" value="fixed" checked>
            <label for="priceTypeFixed" class="price-type-label">Fixed Price</label>
          </div>
          <div class="price-type-option">
            <input type="radio" id="priceTypeRange" name="priceType" value="range">
            <label for="priceTypeRange" class="price-type-label">Price Range</label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>Price *</label>
        <div class="price-inputs" id="priceInputs">
          <input type="number" id="priceFixed" placeholder="299.99" min="0" step="0.01">
        </div>
        <div class="price-inputs hidden" id="priceRangeInputs">
          <input type="number" id="priceMin" placeholder="Min" min="0" step="0.01">
          <input type="number" id="priceMax" placeholder="Max" min="0" step="0.01">
        </div>
      </div>
    </div>

    <!-- 2. Description with AI -->
    <div class="section">
      <div class="section-title">Product Description</div>
      
      <div class="form-group">
        <div class="description-header">
          <label for="productDescription">Description *</label>
          <button class="ai-enhance-btn" id="aiEnhanceBtn">
            <svg class="ai-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
            </svg>
            AI Enhance
          </button>
        </div>
        <textarea 
          id="productDescription" 
          placeholder="Describe your product in detail..."
          rows="5"
          required
        ></textarea>
        <p class="field-note">AI will enhance this based on your business information</p>
        
        <!-- AI Suggestions Dropdown -->
        <div class="suggestions-dropdown" id="suggestionsDropdown">
          <div class="suggestions-loading" id="suggestionsLoading">
            <div class="spinner"></div>
            <p style="margin-top: 8px;">Generating AI suggestions...</p>
          </div>
          <div id="suggestionsContent" class="hidden"></div>
        </div>
      </div>
    </div>

    <!-- 3. Product Images (UPDATED) -->
    <div class="section">
      <div class="section-title">Product Images</div>

      <div class="form-group">
        <label>Upload Base Image *</label>
        <div class="upload-box" id="uploadBox">
          <div id="uploadPlaceholder">
            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
            </svg>
            <p style="font-weight: 600; margin-bottom: 5px; font-size: 14px;">Click or drag image here</p>
            <p style="color: var(--text-secondary); font-size: 12px;">JPG, PNG (max 10MB)</p>
          </div>
          <img id="uploadPreview" class="upload-preview" alt="Upload preview">
          <button id="removeImageBtn" class="remove-image-btn" style="display: none;">Remove</button>
        </div>
        <input type="file" id="fileInput" accept="image/*" style="display: none;">
      </div>

      <!-- AI Model Selection -->
      <div class="form-group">
        <label>AI Image Model</label>
        <div class="model-selection">
          <label class="model-checkbox" id="fluxCheckbox">
            <input type="checkbox" id="useFlux" checked>
            <div class="model-checkbox-label">
              <div class="model-checkbox-title">FLUX Pro</div>
              <div class="model-checkbox-desc">Creative & Artistic</div>
            </div>
          </label>
          <label class="model-checkbox" id="dalleCheckbox">
            <input type="checkbox" id="useDalle" checked>
            <div class="model-checkbox-label">
              <div class="model-checkbox-title">DALL-E 3</div>
              <div class="model-checkbox-desc">Photorealistic</div>
            </div>
          </label>
        </div>
        <p class="field-note">Select one or both models. More models = more variants.</p>
      </div>

      <!-- Image Generation Context -->
      <div class="context-field">
        <label>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
          </svg>
          Additional Context for AI (Optional)
        </label>
        <textarea 
          id="imageContext" 
          placeholder="E.g., 'Show the product with and without a model', 'Include lifestyle shots in African setting', 'Focus on texture and details'..."
          rows="2"
        ></textarea>
      </div>


      <!-- Generate Variants Button -->
<button class="btn" id="generateVariantsBtn" disabled style="margin-top: 12px;">
    Generate Image Variants (R10.00)
  </button>
  
  <!-- Progress -->
  <div class="progress" id="imageProgress">
    <p class="progress-text" id="imageProgressText">Generating image variants...</p>
    <div class="progress-bar">
      <div class="progress-fill" id="imageProgressFill"></div>
    </div>
  </div>
  
  <div class="status" id="imageStatus"></div>
  
  <!-- ✅ SINGLE Variants Section -->
  <div id="variantsSection" class="hidden" style="margin-top: 16px;">
    
    <!-- Header with Download Button -->
    <div class="variants-header">
      <label style="margin: 0; font-weight: 600;">Generated Variants</label>
      <button class="download-all-btn" id="downloadAllBtn" type="button">
        <svg class="download-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
        </svg>
        Download Selected
      </button>
    </div>
  
    <!-- Select All / Deselect All Controls -->
    <div class="variants-controls" id="variantsControls" style="display: none;">
      <div class="select-controls">
        <button class="select-btn" id="selectAllBtn" type="button">Select All</button>
        <button class="select-btn" id="deselectAllBtn" type="button">Deselect All</button>
      </div>
      <div class="selected-count">
        <span id="selectedCount">0</span> of <span id="totalCount">0</span> images selected
      </div>
    </div>
  
    <!-- Variants Grid (Horizontal Scroll) -->
    <div class="variants-grid" id="variantsGrid">
      <!-- Variants will be dynamically added here by JavaScript -->
    </div>
    
  </div>

    <!-- 4. Additional Options -->
    <div class="section">
      <div class="section-title">Additional Options</div>

      <div class="checkbox-group">
        <label class="checkbox-option" id="videoOption">
          <input type="checkbox" id="generateVideo">
          <div class="checkbox-label">
            <div class="checkbox-title">Generate Product Video</div>
            <div class="checkbox-desc">Create promotional video with Veo AI</div>
          </div>
          <div class="checkbox-cost">+R80.00</div>
        </label>

        <label class="checkbox-option" id="socialOption">
          <input type="checkbox" id="postToSocials">
          <div class="checkbox-label">
            <div class="checkbox-title">Post to Social Media</div>
            <div class="checkbox-desc">Share on connected platforms</div>
          </div>
          <div class="checkbox-cost">+R10/platform</div>
        </label>
      </div>
    </div>

    <!-- 5. Review & Submit -->
    <div class="section">
      <div class="section-title">Review & Submit</div>

      <div class="cost-summary">
        <div style="font-weight: 600; margin-bottom: 8px; color: var(--dark-neutral);">Cost Summary</div>
        <div class="cost-line">
          <span>Product listing</span>
          <strong style="color: #28A745;">FREE</strong>
        </div>
        <div class="cost-line">
          <span>Image variants</span>
          <span id="costImages">R0.00</span>
        </div>
        <div class="cost-line">
          <span>Video generation</span>
          <span id="costVideo">R0.00</span>
        </div>
        <div class="cost-line">
          <span>Social media posting</span>
          <span id="costSocial">R0.00</span>
        </div>
        <hr class="cost-divider">
        <div class="cost-line">
          <strong>Total</strong>
          <span class="cost-total" id="costTotal">R0.00</span>
        </div>
      </div>

      <button class="btn" id="submitProductBtn" disabled>
        Add Product to Catalog
      </button>

      <!-- Progress -->
      <div class="progress" id="submitProgress">
        <p class="progress-text" id="submitProgressText">Adding product...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="submitProgressFill"></div>
        </div>
      </div>

      <div class="status" id="submitStatus"></div>
    </div>

  </div>

  <!-- Scripts -->
  <script src="/js/dataManager.js"></script>
  <script src="/js/wordpress-api.js"></script>
  <script src="/js/ai-generator.js"></script>
  
  <script>
    // ========== GLOBAL VARIABLES ==========
    let auth0Client = null;
    let currentBusiness = null;
    let openAIConfig = null;
    let wpAPI = null;
    let aiGenerator = null;
    
    let uploadedImage = null;
    let generatedVariants = [];
    let wordpressImageIds = [];
    
    const urlParams = new URLSearchParams(window.location.search);
    const userEmail = urlParams.get('email');
    const businessId = urlParams.get('businessId');
    const businessName = urlParams.get('businessName');
    
    // ✅ Parse business case data from URL
    let businessCase = {};
    let storeInfo = {};
    
    try {
      const businessCaseParam = urlParams.get('businessCase');
      const storeInfoParam = urlParams.get('storeInfo');
      
      if (businessCaseParam) {
        businessCase = JSON.parse(decodeURIComponent(businessCaseParam));
      }
      if (storeInfoParam) {
        storeInfo = JSON.parse(decodeURIComponent(storeInfoParam));
      }
    } catch (e) {
      console.warn('Could not parse business data from URL:', e);
    }
  
    // Cloudinary config
    const CLOUDINARY_UPLOAD_PRESET = 'n8n-ai-preset';
    const CLOUDINARY_CLOUD_NAME = 'vic-3e';
  
    // Costs
    const COSTS = {
      AI_IDEAS: 1,
      IMAGE_VARIANTS: 10,
      VIDEO: 80,
      SOCIAL_PER_PLATFORM: 10
    };
  
    // ========== DOM ELEMENTS ==========
    const productNameInput = document.getElementById('productName');
    const productCategorySelect = document.getElementById('productCategory');
    const productDescriptionInput = document.getElementById('productDescription');
    const priceFixedInput = document.getElementById('priceFixed');
    const priceMinInput = document.getElementById('priceMin');
    const priceMaxInput = document.getElementById('priceMax');
    
    const uploadBox = document.getElementById('uploadBox');
    const fileInput = document.getElementById('fileInput');
    const uploadPreview = document.getElementById('uploadPreview');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const removeImageBtn = document.getElementById('removeImageBtn');
    
    const generateVariantsBtn = document.getElementById('generateVariantsBtn');
    const variantsSection = document.getElementById('variantsSection');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    
    const generateVideoCheckbox = document.getElementById('generateVideo');
    const postToSocialsCheckbox = document.getElementById('postToSocials');
    
    const submitProductBtn = document.getElementById('submitProductBtn');
    
    const aiEnhanceBtn = document.getElementById('aiEnhanceBtn');
    const suggestionsDropdown = document.getElementById('suggestionsDropdown');
    const suggestionsLoading = document.getElementById('suggestionsLoading');
    const suggestionsContent = document.getElementById('suggestionsContent');
    
    const imageContextInput = document.getElementById('imageContext');
    const useFluxCheckbox = document.getElementById('useFlux');
    const useDalleCheckbox = document.getElementById('useDalle');
  
    // ========== AUTH0 INITIALIZATION ==========
    async function getAuth0Client() {
      if (window.auth0Client) return window.auth0Client;
      
      try {
        const response = await fetch("/auth_config.json");
        const config = await response.json();
        auth0Client = await auth0.createAuth0Client({
          domain: config.domain,
          clientId: config.clientId,
          cacheLocation: 'localstorage',
          useRefreshTokens: true
        });
        window.auth0Client = auth0Client;
        return auth0Client;
      } catch (error) {
        console.error("Error configuring Auth0:", error);
        return null;
      }
    }
  
    // ========== FETCH OPENAI CONFIG ==========
    async function getOpenAIConfig() {
      if (openAIConfig) return openAIConfig;
      
      try {
        const response = await fetch('/api/get-openai-config');
        if (!response.ok) throw new Error('Failed to get OpenAI config');
        openAIConfig = await response.json();
        return openAIConfig;
      } catch (error) {
        console.error('Error fetching OpenAI config:', error);
        return null;
      }
    }
  
    // ========== LOAD BUSINESS INFO ==========
    async function loadBusinessInfo() {
      const auth0 = await getAuth0Client();
      if (!auth0) return;
  
      try {
        const isAuthenticated = await auth0.isAuthenticated();
        if (!isAuthenticated) {
          showStatus('Please log in to continue', 'error', document.getElementById('submitStatus'));
          return;
        }
  
        // If business case not in URL, get from dataManager
        if (!businessCase.business_name) {
          currentBusiness = window.dataManager?.getSelectedBusinessOrFirst();
          if (currentBusiness) {
            businessCase = currentBusiness.initial_business_case || {};
            storeInfo = currentBusiness.store_info || {};
          }
        }
  
        wpAPI = await WordPressAPI.initialize();
        console.log('✅ WordPress API initialized');
  
        const config = await getOpenAIConfig();
        if (config) {
          aiGenerator = new AIGenerator(config);
          console.log('✅ AI Generator initialized');
        }
  
        await loadCategories();
  
      } catch (error) {
        console.error('Error loading business:', error);
      }
    }
  
    // ========== LOAD CATEGORIES FROM WORDPRESS ==========
    async function loadCategories() {
      try {
        const categories = await wpAPI.getListingCategories();
        
        productCategorySelect.innerHTML = '<option value="">Select a category</option>';
        
        const parentCategories = categories.filter(cat => cat.parent === 0);
        
        parentCategories.forEach(parent => {
          const option = document.createElement('option');
          option.value = parent.id;
          option.textContent = parent.name;
          productCategorySelect.appendChild(option);
          
          const children = categories.filter(cat => cat.parent === parent.id);
          children.forEach(child => {
            const childOption = document.createElement('option');
            childOption.value = child.id;
            childOption.textContent = `  └─ ${child.name}`;
            productCategorySelect.appendChild(childOption);
          });
        });
        
        console.log('✅ Categories loaded:', categories.length);
        
      } catch (error) {
        console.error('Error loading categories:', error);
        productCategorySelect.innerHTML = `
          <option value="">Select a category</option>
          <option value="1">General</option>
          <option value="2">Products</option>
          <option value="3">Services</option>
        `;
      }
    }
  
    // ========== IMAGE UPLOAD HANDLERS ==========
    uploadBox.addEventListener('click', () => {
      if (!uploadedImage) {
        fileInput.click();
      }
    });
  
    fileInput.addEventListener('change', (e) => {
      handleFileUpload(e.target.files[0]);
    });
  
    uploadBox.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadBox.style.borderColor = 'var(--primary-orange)';
      uploadBox.style.background = '#FFF8F0';
    });
  
    uploadBox.addEventListener('dragleave', () => {
      uploadBox.style.borderColor = 'var(--border-color)';
      uploadBox.style.background = 'var(--light-bg)';
    });
  
    uploadBox.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadBox.style.borderColor = 'var(--border-color)';
      uploadBox.style.background = 'var(--light-bg)';
      handleFileUpload(e.dataTransfer.files[0]);
    });
  
    function handleFileUpload(file) {
      if (!file || !file.type.startsWith('image/')) {
        showStatus('Please select an image file', 'error', document.getElementById('imageStatus'));
        return;
      }
  
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        showStatus('Image file is too large. Maximum size is 10MB.', 'error', document.getElementById('imageStatus'));
        return;
      }
  
      uploadedImage = file;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        uploadPreview.src = e.target.result;
        uploadPreview.style.display = 'block';
        uploadPlaceholder.style.display = 'none';
        removeImageBtn.style.display = 'inline-block';
        uploadBox.classList.add('has-image');
      };
      reader.readAsDataURL(file);
  
      generateVariantsBtn.disabled = false;
      validateForm();
    }
  
    removeImageBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      uploadedImage = null;
      generatedVariants = [];
      uploadPreview.style.display = 'none';
      uploadPreview.src = '';
      uploadPlaceholder.style.display = 'block';
      removeImageBtn.style.display = 'none';
      uploadBox.classList.remove('has-image');
      fileInput.value = '';
      generateVariantsBtn.disabled = true;
      variantsSection.classList.add('hidden');
      validateForm();
    });
  
    // ========== PRICE TYPE TOGGLE ==========
    document.querySelectorAll('input[name="priceType"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        if (e.target.value === 'fixed') {
          document.getElementById('priceInputs').classList.remove('hidden');
          document.getElementById('priceRangeInputs').classList.add('hidden');
          priceMinInput.required = false;
          priceMaxInput.required = false;
          priceFixedInput.required = true;
        } else {
          document.getElementById('priceInputs').classList.add('hidden');
          document.getElementById('priceRangeInputs').classList.remove('hidden');
          priceFixedInput.required = false;
          priceMinInput.required = true;
          priceMaxInput.required = true;
        }
        validateForm();
      });
    });
  
    // ========== CHECKBOX STYLING ==========
    document.querySelectorAll('.checkbox-option').forEach(option => {
      const checkbox = option.querySelector('input[type="checkbox"]');
      checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
          option.classList.add('checked');
        } else {
          option.classList.remove('checked');
        }
        updateCostSummary();
      });
    });
  
    // ========== MODEL CHECKBOX STYLING ==========
    [useFluxCheckbox, useDalleCheckbox].forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const parent = checkbox.closest('.model-checkbox');
        if (checkbox.checked) {
          parent.classList.add('checked');
        } else {
          parent.classList.remove('checked');
        }
        
        // Ensure at least one is selected
        if (!useFluxCheckbox.checked && !useDalleCheckbox.checked) {
          checkbox.checked = true;
          parent.classList.add('checked');
        }
      });
    });
  
    // ========== AI ENHANCE (WITH BUSINESS CONTEXT) ==========
    aiEnhanceBtn.addEventListener('click', async () => {
      await fetchAIEnhancements();
    });
  
    async function fetchAIEnhancements() {
      suggestionsDropdown.classList.add('show');
      suggestionsLoading.style.display = 'block';
      suggestionsContent.classList.add('hidden');
  
      try {
        await deductCost(COSTS.AI_IDEAS, 'AI description enhancement');
  
        const productName = productNameInput.value || 'product';
        const currentDescription = productDescriptionInput.value || '';
        
        // Extract business context
        const location = storeInfo.address || businessCase.location || 'South Africa';
        const targetCustomers = businessCase.your_customers || 'general consumers';
        const businessProblem = businessCase.the_challenge || '';
        const solution = businessCase.your_solution || '';
        const whatYouDo = businessCase.what_you_do || '';
        
        const enhancedPrompt = `You are an expert e-commerce copywriter. Enhance this product description using business context.
  
  **Business Context:**
  - Company: ${businessCase.business_name || businessName}
  - What they do: ${whatYouDo}
  - Target customers: ${targetCustomers}
  - Location: ${location}
  - Challenge they solve: ${businessProblem}
  - Their solution: ${solution}
  
  **Product Information:**
  - Product name: ${productName}
  - Current description: ${currentDescription || 'Not provided - create from scratch'}
  
  **Task:** Generate 3 enhanced product descriptions that:
  1. Incorporate the target demographic from business context
  2. Reference the location/region appropriately  
  3. Align with the business's mission and solution
  4. Are SEO-optimized and compelling
  5. Highlight benefits that solve customer problems
  6. Are 2-3 paragraphs long and ready to use
  
  Return ONLY valid JSON:
  {
    "suggestions": [
      {
        "title": "Description Style (e.g., 'Benefit-Focused', 'Storytelling', 'Technical')",
        "description": "Full enhanced product description (2-3 paragraphs)"
      }
    ]
  }`;
  
        const config = await getOpenAIConfig();
        const url = `${config.endpoint}openai/deployments/${config.deployment}/chat/completions?api-version=2025-01-01-preview`;
  
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'api-key': config.apiKey
          },
          body: JSON.stringify({
            messages: [
              {
                role: "system",
                content: "You are an expert e-commerce copywriter. Return valid JSON only."
              },
              {
                role: "user",
                content: enhancedPrompt
              }
            ],
            max_tokens: 1000,
            temperature: 0.7,
            response_format: { type: "json_object" }
          })
        });
  
        if (!response.ok) {
          throw new Error(`AI API error: ${response.status}`);
        }
  
        const data = await response.json();
        const content = data.choices[0].message.content;
        
        let result;
        try {
          result = JSON.parse(content);
        } catch (e) {
          const jsonMatch = content.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            result = JSON.parse(jsonMatch[0]);
          } else {
            throw new Error('Invalid JSON response');
          }
        }
        
        const suggestions = result.suggestions || [];
        
        if (suggestions.length === 0) {
          throw new Error('No suggestions generated');
        }
  
        suggestionsContent.innerHTML = '';
  
        suggestions.forEach((suggestion) => {
          const item = document.createElement('div');
          item.className = 'suggestion-item';
          
          item.innerHTML = `
            <div class="suggestion-item-title">${suggestion.title}</div>
            <div class="suggestion-item-preview">${suggestion.description.substring(0, 150)}...</div>
          `;
          
          item.addEventListener('click', () => {
            document.querySelectorAll('.suggestion-item').forEach(i => 
              i.classList.remove('selected')
            );
            
            item.classList.add('selected');
            productDescriptionInput.value = suggestion.description;
            
            validateForm();
            
            setTimeout(() => {
              suggestionsDropdown.classList.remove('show');
            }, 500);
          });
          
          suggestionsContent.appendChild(item);
        });
        
        suggestionsLoading.style.display = 'none';
        suggestionsContent.classList.remove('hidden');
  
      } catch (error) {
        console.error('Error fetching AI enhancements:', error);
        suggestionsDropdown.classList.remove('show');
        showStatus(error.message, 'error', document.getElementById('imageStatus'));
      }
    }
  
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!suggestionsDropdown.contains(e.target) && e.target !== aiEnhanceBtn && !aiEnhanceBtn.contains(e.target)) {
        suggestionsDropdown.classList.remove('show');
      }
    });
  
    
    // ========== GENERATE IMAGE VARIANTS (WITH PROGRESSIVE LOADING) ==========
generateVariantsBtn.addEventListener('click', async () => {
  await generateImageVariants();
});

async function generateImageVariants() {
  if (!uploadedImage || !aiGenerator) return;

  // Check which models are selected
  const useFlux = useFluxCheckbox.checked;
  const useDalle = useDalleCheckbox.checked;
  
  if (!useFlux && !useDalle) {
    showStatus('Please select at least one AI model', 'error', document.getElementById('imageStatus'));
    return;
  }

  generateVariantsBtn.disabled = true;
  document.getElementById('imageProgress').style.display = 'block';
  document.getElementById('imageStatus').style.display = 'none';
  variantsSection.classList.remove('hidden');
  
  // Clear previous variants
  const variantsGrid = document.getElementById('variantsGrid');
  variantsGrid.innerHTML = '';
  generatedVariants = [];

  try {
    await deductCost(COSTS.IMAGE_VARIANTS, 'Image variant generation');

    const productName = productNameInput.value || 'product';
    const variantTypes = ['front', 'side', 'lifestyle'];
    
    // Get additional context from user input
    const additionalContext = imageContextInput.value.trim();
    
    // Build context-aware prompts using business data
    const location = storeInfo.address || businessCase.location || 'South Africa';
    const targetCustomers = businessCase.your_customers || '';
    const businessDescription = businessCase.what_you_do || '';
    
    const contextualPrompts = {
      front: `Professional product photography of ${productName}, front-facing view, clean background, studio lighting, high detail, commercial style, centered composition. ${additionalContext ? `Additional context: ${additionalContext}` : ''}`,
      
      side: `Professional product photography of ${productName}, 45-degree angle side view, clean background, studio lighting, showing depth and dimension, commercial style. ${additionalContext ? `Additional context: ${additionalContext}` : ''}`,
      
      lifestyle: `Lifestyle product photography of ${productName} in ${location} setting. ${targetCustomers ? `Featuring ${targetCustomers}` : 'Person interacting with product'}. Natural environment, authentic setting, warm natural lighting, relatable scene, professional composition. ${businessDescription ? `Context: ${businessDescription}` : ''}. ${additionalContext ? `Additional: ${additionalContext}` : ''}`
    };
    
    document.getElementById('imageProgressText').textContent = 'Generating image variants with AI...';
    document.getElementById('imageProgressFill').style.width = '10%';

    // ✅ Order models: FLUX first (faster), then DALL-E
    const modelsToUse = [];
    if (useFlux) modelsToUse.push('flux');
    if (useDalle) modelsToUse.push('dalle');
    
    let totalVariants = variantTypes.length * modelsToUse.length;
    let completedVariants = 0;

    let variantIndex = 0;

    // ✅ Generate progressively: show each as it completes
    for (const model of modelsToUse) {
      for (const variantType of variantTypes) {
        // Create card immediately with loading state
        const cardId = `variant_${variantType}_${model}_${Date.now()}`;
        const card = createVariantCard(cardId, variantType, model, 'generating');

        card.dataset.variantIndex = variantIndex; // ✅ Now it works!

        variantsGrid.appendChild(card);
        
        try {
          const prompt = contextualPrompts[variantType];
          
          document.getElementById('imageProgressText').textContent = 
            `Generating ${variantType} with ${model.toUpperCase()}... (${completedVariants + 1}/${totalVariants})`;
          
          // Generate image
          const imageData = await aiGenerator.generateImageWithEdit(
            uploadedImage,
            prompt,
            model
          );
          
          // ✅ Update card immediately when done
          updateVariantCard(cardId, imageData, 'generated');
          
          generatedVariants.push({
            type: `${variantType}_${model}`,
            displayType: variantType,
            model: model,
            imageData: imageData,
            prompt: prompt
          });
          
          completedVariants++;
          const progress = 10 + (completedVariants / totalVariants) * 85;
          document.getElementById('imageProgressFill').style.width = `${progress}%`;
          
          updateSelectedCount();
          
        } catch (error) {
          console.error(`Failed to generate ${variantType} with ${model}:`, error);
          updateVariantCard(cardId, null, 'failed');
        }
        variantIndex++;

      }
    }

    document.getElementById('imageProgressFill').style.width = '100%';
    
    showStatus(
      `Image variants generated!\n${generatedVariants.length} total variants created\nCost: R${COSTS.IMAGE_VARIANTS.toFixed(2)}`,
      'success',
      document.getElementById('imageStatus')
    );

    updateCostSummary();
    validateForm();

  } catch (error) {
    console.error('Error generating variants:', error);
    showStatus(error.message, 'error', document.getElementById('imageStatus'));
  } finally {
    document.getElementById('imageProgress').style.display = 'none';
    generateVariantsBtn.disabled = false;
  }
}

// ========== CREATE VARIANT CARD WITH CHECKBOX ==========
function createVariantCard(cardId, variantType, model, state = 'generating') {
  const card = document.createElement('div');
  card.className = `variant-card ${state}`;
  card.id = cardId;
  card.dataset.selected = 'true'; // ✅ Selected by default
  
  card.innerHTML = `
    <div class="variant-checkbox-container">
      <input 
        type="checkbox" 
        class="variant-checkbox" 
        checked
        ${state === 'generating' ? 'disabled' : ''}
      >
    </div>
    <div class="variant-image-container">
      ${state === 'generating' ? '<div class="variant-spinner"></div>' : ''}
      <img class="variant-image" alt="${variantType} ${model}">
    </div>
    <div class="variant-label">${capitalizeFirst(variantType)} - ${model.toUpperCase()}</div>
    <div class="variant-status">${state === 'generating' ? 'Generating...' : 'Pending'}</div>
  `;
  
  // ✅ Add click handler for checkbox
  const checkbox = card.querySelector('.variant-checkbox');
  checkbox.addEventListener('change', (e) => {
    e.stopPropagation();
    toggleVariantSelection(cardId, checkbox.checked);
  });
  
  // ✅ Click on card to toggle selection (except when generating)
  card.addEventListener('click', () => {
    if (state !== 'generating') {
      checkbox.checked = !checkbox.checked;
      toggleVariantSelection(cardId, checkbox.checked);
    }
  });
  
  return card;
}

// ========== UPDATE VARIANT CARD ==========
function updateVariantCard(cardId, imageData, state) {
  const card = document.getElementById(cardId);
  if (!card) return;
  
  const img = card.querySelector('.variant-image');
  const status = card.querySelector('.variant-status');
  const spinner = card.querySelector('.variant-spinner');
  const checkbox = card.querySelector('.variant-checkbox');
  
  if (spinner) {
    spinner.remove();
  }
  
  card.className = `variant-card ${state}`;
  
  if (state === 'generated' && imageData) {
    const imageDataUrl = imageData.startsWith('http') 
      ? imageData 
      : `data:image/png;base64,${imageData}`;
    
    img.src = imageDataUrl;
    img.style.display = 'block';
    status.textContent = '✓ Generated';
    
    // ✅ Enable checkbox when generated
    checkbox.disabled = false;
    
    // ✅ Apply initial selection state
    if (checkbox.checked) {
      card.classList.add('selected');
    }
    
  } else if (state === 'failed') {
    status.textContent = '✗ Failed';
    card.style.borderColor = '#DC3545';
    card.style.background = '#FFF0F0';
    checkbox.disabled = true;
    checkbox.checked = false;
    card.dataset.selected = 'false';
  }
}


// ========== TOGGLE VARIANT SELECTION ==========
function toggleVariantSelection(cardId, isSelected) {
  const card = document.getElementById(cardId);
  if (!card) return;
  
  card.dataset.selected = isSelected.toString();
  
  if (isSelected) {
    card.classList.add('selected');
    card.classList.remove('unselected');
  } else {
    card.classList.remove('selected');
    card.classList.add('unselected');
  }
  
  updateSelectedCount();
  validateForm();
}

// ========== UPDATE SELECTED COUNT ==========
function updateSelectedCount() {
  const allCards = document.querySelectorAll('.variant-card[data-selected]');
  const selectedCards = document.querySelectorAll('.variant-card[data-selected="true"]');
  
  document.getElementById('selectedCount').textContent = selectedCards.length;
  document.getElementById('totalCount').textContent = allCards.length;
  
  // Show/hide controls
  const controls = document.getElementById('variantsControls');
  if (allCards.length > 0) {
    controls.style.display = 'flex';
  }
}

// ========== SELECT ALL ==========
document.getElementById('selectAllBtn')?.addEventListener('click', () => {
  document.querySelectorAll('.variant-checkbox').forEach(checkbox => {
    if (!checkbox.disabled) {
      checkbox.checked = true;
      const card = checkbox.closest('.variant-card');
      toggleVariantSelection(card.id, true);
    }
  });
});

// ========== DESELECT ALL ==========
document.getElementById('deselectAllBtn')?.addEventListener('click', () => {
  document.querySelectorAll('.variant-checkbox').forEach(checkbox => {
    if (!checkbox.disabled) {
      checkbox.checked = false;
      const card = checkbox.closest('.variant-card');
      toggleVariantSelection(card.id, false);
    }
  });
});

// ========== HELPER: CAPITALIZE FIRST LETTER ==========
function capitalizeFirst(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

// ========== DOWNLOAD SELECTED IMAGES ==========
downloadAllBtn.addEventListener('click', async () => {
  try {
    const selectedCards = document.querySelectorAll('.variant-card[data-selected="true"]');
    
    if (selectedCards.length === 0) {
      showStatus('No images selected', 'error', document.getElementById('imageStatus'));
      return;
    }
    
    const imagesToDownload = [];
    
    // Add original image
    if (uploadedImage) {
      imagesToDownload.push({
        name: `0_original_${productNameInput.value || 'product'}.png`,
        blob: uploadedImage
      });
    }
    
    // Add selected variants
    selectedCards.forEach((card, index) => {
      const variantIndex = parseInt(card.dataset.variantIndex);
      const variant = generatedVariants[variantIndex];
      
      if (variant && variant.imageData) {
        const imageDataUrl = variant.imageData.startsWith('http') 
          ? variant.imageData 
          : `data:image/png;base64,${variant.imageData}`;
        
        imagesToDownload.push({
          name: `${index + 1}_${variant.displayType}_${variant.model}_${productNameInput.value || 'product'}.png`,
          dataUrl: imageDataUrl
        });
      }
    });
    
    showStatus(`Downloading ${imagesToDownload.length} selected images...`, 'info', document.getElementById('imageStatus'));
    
    // Download each image
    for (let i = 0; i < imagesToDownload.length; i++) {
      const img = imagesToDownload[i];
      
      let blob;
      if (img.blob) {
        blob = img.blob;
      } else {
        const response = await fetch(img.dataUrl);
        blob = await response.blob();
      }
      
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = img.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      await new Promise(resolve => setTimeout(resolve, 300));
    }
    
    showStatus(`${imagesToDownload.length} selected images downloaded!`, 'success', document.getElementById('imageStatus'));
    
  } catch (error) {
    console.error('Error downloading images:', error);
    showStatus('Failed to download images', 'error', document.getElementById('imageStatus'));
  }
});


 // ========== UPLOAD ONLY SELECTED IMAGES ==========
async function uploadImagesToCloudinaryAndWordPress() {
  const uploadedImages = [];
  
  // ✅ Always upload original image first
  const originalCloudinaryUrl = await uploadFileToCloudinary(uploadedImage);
  const originalWpImage = await wpAPI.uploadImageFromUrl(
    originalCloudinaryUrl,
    'product-main.png',
    productNameInput.value || 'Product image'
  );
  
  uploadedImages.push({
    cloudinaryUrl: originalCloudinaryUrl,
    wordpressId: originalWpImage.id,
    wordpressUrl: originalWpImage.url
  });
  
  // ✅ Get only selected variants
  const selectedVariants = generatedVariants.filter((variant, index) => {
    const cardId = document.querySelector(`[data-variant-index="${index}"]`)?.id;
    const card = document.getElementById(cardId);
    return card && card.dataset.selected === 'true';
  });
  
  // Upload selected variants
  for (let i = 0; i < selectedVariants.length; i++) {
    const variant = selectedVariants[i];
    const cloudinaryUrl = await uploadBase64ToCloudinary(variant.imageData);
    
    const wpImageName = `product-variant-${i + 1}.png`;
    const wpImage = await wpAPI.uploadImageFromUrl(
      cloudinaryUrl,
      wpImageName,
      `${productNameInput.value || 'Product'} - ${variant.displayType}`
    );
    
    uploadedImages.push({
      cloudinaryUrl: cloudinaryUrl,
      wordpressId: wpImage.id,
      wordpressUrl: wpImage.url
    });
  }
  
  return uploadedImages;
}


  async function uploadBase64ToCloudinary(base64Data) {
    const byteCharacters = atob(base64Data);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
      byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    const blob = new Blob([byteArray], { type: 'image/png' });

    return await uploadFileToCloudinary(blob);
  }

  async function uploadFileToCloudinary(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    formData.append('folder', 'product-images');

    const response = await fetch(
      `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
      {
        method: 'POST',
        body: formData
      }
    );

    if (!response.ok) {
      throw new Error('Failed to upload to Cloudinary');
    }

    const data = await response.json();
    return data.secure_url;
  }

  // ========== DEDUCT COST FROM WALLET ==========
  async function deductCost(amount, description) {
    try {
      const response = await fetch('/api/social-post/post', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          businessId: businessId,
          userEmail: userEmail,
          platforms: [],
          postContent: { text: description },
          totalCost: amount,
          skipPosting: true
        })
      });

      if (!response.ok) {
        const error = await response.json();
        
        if (response.status === 402) {
          throw new Error(
            `Insufficient funds!\n\nRequired: R${amount.toFixed(2)}\nBalance: ${error.formatted_balance}\n\nPlease add credits to continue.`
          );
        }
        
        throw new Error(error.error || 'Payment failed');
      }

      const result = await response.json();
      console.log(`✅ ${description} cost deducted: R${amount.toFixed(2)}`);
      return result;

    } catch (error) {
      throw error;
    }
  }

  // ========== UPDATE COST SUMMARY ==========
  function updateCostSummary() {
    let imagesCost = generatedVariants.length > 0 ? COSTS.IMAGE_VARIANTS : 0;
    let videoCost = generateVideoCheckbox.checked ? COSTS.VIDEO : 0;
    let socialCost = postToSocialsCheckbox.checked ? COSTS.SOCIAL_PER_PLATFORM * 3 : 0;
    
    document.getElementById('costImages').textContent = `R${imagesCost.toFixed(2)}`;
    document.getElementById('costVideo').textContent = `R${videoCost.toFixed(2)}`;
    document.getElementById('costSocial').textContent = `R${socialCost.toFixed(2)}`;
    
    const total = imagesCost + videoCost + socialCost;
    document.getElementById('costTotal').textContent = `R${total.toFixed(2)}`;
  }

  // ========== VALIDATE FORM ==========
function validateForm() {
  const hasName = productNameInput.value.trim().length > 0;
  const hasCategory = productCategorySelect.value !== '';
  const hasDescription = productDescriptionInput.value.trim().length > 20;
  const hasImage = uploadedImage !== null;
  
  // ✅ Check if at least one variant is selected
  const hasSelectedVariants = document.querySelectorAll('.variant-card[data-selected="true"]').length > 0;
  
  const priceType = document.querySelector('input[name="priceType"]:checked').value;
  let hasValidPrice = false;
  
  if (priceType === 'fixed') {
    hasValidPrice = priceFixedInput.value && parseFloat(priceFixedInput.value) > 0;
  } else {
    const min = parseFloat(priceMinInput.value);
    const max = parseFloat(priceMaxInput.value);
    hasValidPrice = min > 0 && max > 0 && max > min;
  }
  
  const isValid = hasName && hasCategory && hasDescription && hasImage && hasSelectedVariants && hasValidPrice;
  
  submitProductBtn.disabled = !isValid;
  
  return isValid;
}


  [productNameInput, productCategorySelect, productDescriptionInput, priceFixedInput, priceMinInput, priceMaxInput].forEach(input => {
    input.addEventListener('input', validateForm);
    input.addEventListener('change', validateForm);
  });

  // ========== SUBMIT PRODUCT ==========
submitProductBtn.addEventListener('click', async () => {
  await submitProduct();
});

async function submitProduct() {
  if (!validateForm()) {
    showStatus('Please fill in all required fields', 'error', document.getElementById('submitStatus'));
    return;
  }

  submitProductBtn.disabled = true;
  document.getElementById('submitProgress').style.display = 'block';
  document.getElementById('submitStatus').style.display = 'none';
  document.getElementById('submitProgressFill').style.width = '10%';

  try {
    // ========== 1. UPLOAD IMAGES TO CLOUDINARY & WORDPRESS ==========
    document.getElementById('submitProgressText').textContent = 'Uploading images to WordPress...';
    document.getElementById('submitProgressFill').style.width = '20%';

    const uploadedImages = await uploadImagesToCloudinaryAndWordPress();
    wordpressImageIds = uploadedImages.map(img => img.wordpressId);

    console.log('✅ Images uploaded. WordPress IDs:', wordpressImageIds);

    document.getElementById('submitProgressFill').style.width = '40%';

    // ========== 2. GENERATE VIDEO (OPTIONAL) ==========
    let videoUrl = null;
    if (generateVideoCheckbox.checked) {
      document.getElementById('submitProgressText').textContent = 'Generating product video...';
      document.getElementById('submitProgressFill').style.width = '50%';
      
      await deductCost(COSTS.VIDEO, 'Product video generation');
      
      // Video generation skipped for now
      console.log('Video generation not yet implemented');
      
      document.getElementById('submitProgressFill').style.width = '60%';
    }

    // ========== 3. PREPARE PRODUCT DATA ==========
    document.getElementById('submitProgressText').textContent = 'Preparing product data...';
    document.getElementById('submitProgressFill').style.width = '70%';

    const priceType = document.querySelector('input[name="priceType"]:checked').value;
    let priceValue, priceText;
    
    if (priceType === 'fixed') {
      priceValue = parseFloat(priceFixedInput.value);
      priceText = `R${priceValue.toFixed(2)}`;
    } else {
      const min = parseFloat(priceMinInput.value);
      const max = parseFloat(priceMaxInput.value);
      priceValue = min;
      priceText = `R${min.toFixed(2)} - R${max.toFixed(2)}`;
    }

    // ========== 4. BUILD WEBHOOK PAYLOAD (WITH IMAGE IDS) ==========
    const webhookPayload = {
      businessId: businessId,
      userEmail: userEmail,
      productData: {
        name: productNameInput.value,
        description: productDescriptionInput.value,
        category: productCategorySelect.options[productCategorySelect.selectedIndex].text,
        categoryId: parseInt(productCategorySelect.value),
        price: priceText,
        priceValue: priceValue,
        priceType: priceType,
        
        // ✅ WordPress Image IDs (for listing creation)
        wordpressImageIds: wordpressImageIds,
        featuredImageId: wordpressImageIds[0],
        galleryImageIds: wordpressImageIds.slice(1),
        
        // ✅ Image URLs (for reference)
        images: uploadedImages.map(img => ({
          cloudinaryUrl: img.cloudinaryUrl,
          wordpressId: img.wordpressId,
          wordpressUrl: img.wordpressUrl
        })),
        
        videoUrl: videoUrl,
        hasVideo: generateVideoCheckbox.checked,
        postedToSocials: postToSocialsCheckbox.checked,
        
        aiModelsUsed: {
          flux: useFluxCheckbox.checked,
          dalle: useDalleCheckbox.checked
        },
        imageContext: imageContextInput.value.trim()
      },
      
      businessContext: {
        businessName: businessCase.business_name,
        location: storeInfo.address,
        targetCustomers: businessCase.your_customers
      },
      
      timestamp: new Date().toISOString(),
      
      generationCosts: {
        aiIdeas: COSTS.AI_IDEAS,
        images: generatedVariants.length > 0 ? COSTS.IMAGE_VARIANTS : 0,
        video: generateVideoCheckbox.checked ? COSTS.VIDEO : 0,
        social: postToSocialsCheckbox.checked ? COSTS.SOCIAL_PER_PLATFORM * 3 : 0,
        total: calculateTotalCost()
      }
    };

    document.getElementById('submitProgressFill').style.width = '80%';

    // ========== 5. POST TO SOCIALS (OPTIONAL) ==========
    if (postToSocialsCheckbox.checked) {
      document.getElementById('submitProgressText').textContent = 'Posting to social media...';
      
      const socialCost = COSTS.SOCIAL_PER_PLATFORM * 3;
      await deductCost(socialCost, 'Social media posting');
      
      // TODO: Call social media posting endpoint
    }

    document.getElementById('submitProgressFill').style.width = '85%';

    // ========== 6. SEND TO WEBHOOK ==========
    document.getElementById('submitProgressText').textContent = 'Sending to webhook...';
    
    // ✅ ADD THESE DEBUG LOGS
    console.log('📤 Sending webhook payload:', JSON.stringify(webhookPayload, null, 2));
    console.log('📤 Payload size:', JSON.stringify(webhookPayload).length, 'bytes');
    console.log('📤 Payload keys:', Object.keys(webhookPayload));
    
    const webhookResponse = await fetch('/api/webhook/product-created', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(webhookPayload)
    });

    console.log('📥 Webhook response status:', webhookResponse.status);
    console.log('📥 Webhook response headers:', Object.fromEntries(webhookResponse.headers.entries()));
    
    const webhookData = await webhookResponse.json().catch(() => ({ error: 'No JSON response' }));
    console.log('📥 Webhook response data:', webhookData);



    if (!webhookResponse.ok) {
      throw new Error('Webhook failed');
    }

    document.getElementById('submitProgressFill').style.width = '90%';

    // ========== 7. LOG TO DATABASE ==========
    document.getElementById('submitProgressText').textContent = 'Saving to database...';
    
    await fetch('/api/products/log', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(webhookPayload)
    });

    document.getElementById('submitProgressFill').style.width = '100%';

    // ========== 8. SUCCESS ==========
    showStatus(
      `Product data sent successfully!\n\n` +
      `Product: ${productNameInput.value}\n` +
      `Images uploaded: ${uploadedImages.length}\n` +
      `WordPress Image IDs: ${wordpressImageIds.join(', ')}\n\n` +
      `Data sent to webhook for listing creation.`,
      'success',
      document.getElementById('submitStatus')
    );

    setTimeout(() => {
      if (confirm('Product data sent successfully! Add another product?')) {
        resetForm();
      } else {
        window.location.href = `/dashboard.html?email=${userEmail}&businessId=${businessId}`;
      }
    }, 5000);

  } catch (error) {
    console.error('Error submitting product:', error);
    showStatus(error.message, 'error', document.getElementById('submitStatus'));
  } finally {
    document.getElementById('submitProgress').style.display = 'none';
    submitProductBtn.disabled = false;
  }
}

//   async function submitProduct() {
//     if (!validateForm()) {
//       showStatus('Please fill in all required fields', 'error', document.getElementById('submitStatus'));
//       return;
//     }

//     submitProductBtn.disabled = true;
//     document.getElementById('submitProgress').style.display = 'block';
//     document.getElementById('submitStatus').style.display = 'none';
//     document.getElementById('submitProgressFill').style.width = '10%';

//     try {
//       document.getElementById('submitProgressText').textContent = 'Uploading images...';
//       document.getElementById('submitProgressFill').style.width = '20%';

//       const uploadedImages = await uploadImagesToCloudinaryAndWordPress();
//       wordpressImageIds = uploadedImages.map(img => img.wordpressId);

//       document.getElementById('submitProgressFill').style.width = '40%';

//       let videoUrl = null;
//       if (generateVideoCheckbox.checked) {
//         document.getElementById('submitProgressText').textContent = 'Generating product video...';
//         document.getElementById('submitProgressFill').style.width = '50%';
        
//         await deductCost(COSTS.VIDEO, 'Product video generation');
        
//         // Video generation skipped for now
//         console.log('Video generation not yet implemented');
        
//         document.getElementById('submitProgressFill').style.width = '70%';
//       }

//       document.getElementById('submitProgressText').textContent = 'Creating product listing...';
//       document.getElementById('submitProgressFill').style.width = '80%';

//       const priceType = document.querySelector('input[name="priceType"]:checked').value;
//       let priceValue, priceText;
      
//       if (priceType === 'fixed') {
//         priceValue = parseFloat(priceFixedInput.value);
//         priceText = `R${priceValue.toFixed(2)}`;
//       } else {
//         const min = parseFloat(priceMinInput.value);
//         const max = parseFloat(priceMaxInput.value);
//         priceValue = min;
//         priceText = `R${min.toFixed(2)} - R${max.toFixed(2)}`;
//       }

//       const listingData = {
//         title: productNameInput.value,
//         content: productDescriptionInput.value,
//         status: 'publish',
//         listing_categories: [parseInt(productCategorySelect.value)],
//         featured_media: wordpressImageIds[0],
//         meta: {
//           price: priceValue,
//           price_type: priceType === 'fixed' ? 'fixed' : 'range',
//           _rtcl_price: priceValue,
//           gallery: wordpressImageIds.slice(1),
//           phone: currentBusiness?.contact_info?.phone || '',
//           email: currentBusiness?.contact_info?.email || '',
//           whatsapp_number: currentBusiness?.contact_info?.whatsapp || '',
//           website: currentBusiness?.website || '',
//         }
//       };

//       const wpListing = await wpAPI.createListing(listingData);

//       document.getElementById('submitProgressFill').style.width = '90%';

//       if (postToSocialsCheckbox.checked) {
//         document.getElementById('submitProgressText').textContent = 'Posting to social media...';
        
//         const socialCost = COSTS.SOCIAL_PER_PLATFORM * 3;
//         await deductCost(socialCost, 'Social media posting');
        
//         // TODO: Call social media posting endpoint
//       }

//       document.getElementById('submitProgressText').textContent = 'Saving to database...';
      
//       const webhookPayload = {
//         businessId: businessId,
//         userEmail: userEmail,
//         productId: wpListing.id,
//         wordpressUrl: wpListing.link,
//         productData: {
//           name: productNameInput.value,
//           description: productDescriptionInput.value,
//           category: productCategorySelect.options[productCategorySelect.selectedIndex].text,
//           categoryId: parseInt(productCategorySelect.value),
//           price: priceText,
//           priceValue: priceValue,
//           priceType: priceType,
//           images: uploadedImages.map(img => ({
//             cloudinaryUrl: img.cloudinaryUrl,
//             wordpressId: img.wordpressId,
//             wordpressUrl: img.wordpressUrl
//           })),
//           videoUrl: videoUrl,
//           hasVideo: generateVideoCheckbox.checked,
//           postedToSocials: postToSocialsCheckbox.checked,
//           aiModelsUsed: {
//             flux: useFluxCheckbox.checked,
//             dalle: useDalleCheckbox.checked
//           },
//           imageContext: imageContextInput.value.trim()
//         },
//         businessContext: {
//           businessName: businessCase.business_name,
//           location: storeInfo.address,
//           targetCustomers: businessCase.your_customers
//         },
//         timestamp: new Date().toISOString(),
//         generationCosts: {
//           aiIdeas: COSTS.AI_IDEAS,
//           images: generatedVariants.length > 0 ? COSTS.IMAGE_VARIANTS : 0,
//           video: generateVideoCheckbox.checked ? COSTS.VIDEO : 0,
//           social: postToSocialsCheckbox.checked ? COSTS.SOCIAL_PER_PLATFORM * 3 : 0,
//           total: calculateTotalCost()
//         }
//       };

//       await fetch('/api/webhook/product-created', {
//         method: 'POST',
//         headers: { 'Content-Type': 'application/json' },
//         body: JSON.stringify(webhookPayload)
//       });

//       await fetch('/api/products/log', {
//         method: 'POST',
//         headers: { 'Content-Type': 'application/json' },
//         body: JSON.stringify(webhookPayload)
//       });

//       document.getElementById('submitProgressFill').style.width = '100%';

//       showStatus(
//         `Product added successfully!\n\nProduct: ${productNameInput.value}\nWordPress ID: ${wpListing.id}\nImages: ${uploadedImages.length} uploaded\n\nView: ${wpListing.link}`,
//         'success',
//         document.getElementById('submitStatus')
//       );

//       setTimeout(() => {
//         if (confirm('Product added successfully! Add another product?')) {
//           resetForm();
//         } else {
//           window.location.href = `/dashboard.html?email=${userEmail}&businessId=${businessId}`;
//         }
//       }, 5000);

//     } catch (error) {
//       console.error('Error submitting product:', error);
//       showStatus(error.message, 'error', document.getElementById('submitStatus'));
//     } finally {
//       document.getElementById('submitProgress').style.display = 'none';
//       submitProductBtn.disabled = false;
//     }
//   }

  // ========== CALCULATE TOTAL COST ==========
  function calculateTotalCost() {
    let total = 0;
    
    if (generatedVariants.length > 0) {
      total += COSTS.IMAGE_VARIANTS;
    }
    
    if (generateVideoCheckbox.checked) {
      total += COSTS.VIDEO;
    }
    
    if (postToSocialsCheckbox.checked) {
      total += COSTS.SOCIAL_PER_PLATFORM * 3;
    }
    
    return total;
  }

  // ========== SHOW STATUS ==========
  function showStatus(message, type, targetElement) {
    targetElement.textContent = message;
    targetElement.className = `status ${type}`;
    targetElement.style.display = 'block';
  }

  // ========== RESET FORM  ==========
// function resetForm() {
//   productNameInput.value = '';
//   productCategorySelect.value = '';
//   productDescriptionInput.value = '';
//   priceFixedInput.value = '';
//   priceMinInput.value = '';
//   priceMaxInput.value = '';
//   imageContextInput.value = '';
  
//   uploadedImage = null;
//   generatedVariants = [];
//   wordpressImageIds = [];
  
//   uploadPreview.style.display = 'none';
//   uploadPreview.src = '';
//   uploadPlaceholder.style.display = 'block';
//   removeImageBtn.style.display = 'none';
//   uploadBox.classList.remove('has-image');
//   fileInput.value = '';
  
//   generateVariantsBtn.disabled = true;
//   variantsSection.classList.add('hidden');
  
//   // ✅ Clear dynamic variants grid
//   const variantsGrid = document.getElementById('variantsGrid');
//   if (variantsGrid) {
//     variantsGrid.innerHTML = '';
//   }
  
//   generateVideoCheckbox.checked = false;
//   postToSocialsCheckbox.checked = false;
  
//   useFluxCheckbox.checked = true;
//   useDalleCheckbox.checked = true;
//   document.getElementById('fluxCheckbox').classList.add('checked');
//   document.getElementById('dalleCheckbox').classList.add('checked');
  
//   document.querySelectorAll('.checkbox-option').forEach(option => {
//     option.classList.remove('checked');
//   });
  
//   suggestionsDropdown.classList.remove('show');
  
//   document.getElementById('submitStatus').style.display = 'none';
//   document.getElementById('imageStatus').style.display = 'none';
  
//   updateCostSummary();
//   validateForm();
// }

  // ========== INITIALIZE ON PAGE LOAD ==========
  document.addEventListener('DOMContentLoaded', async () => {
    await loadBusinessInfo();
    validateForm();
    updateCostSummary();
    
    // Log business context for debugging
    console.log('📊 Business Context:', {
      businessName: businessCase.business_name,
      location: storeInfo.address,
      targetCustomers: businessCase.your_customers,
      whatYouDo: businessCase.what_you_do
    });
  });
</script>
</body>
</html>