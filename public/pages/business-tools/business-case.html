<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Your Business Case | Zuke</title>
  
  <!-- ‚úÖ Use new formStyle.css -->
  <link rel="stylesheet" href="../../css/formStyle.css">
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  
  <style>
    /* ‚úÖ Custom styles specific to business case form */
    .badge {
      display: inline-block;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      margin-left: 8px;
      font-weight: 600;
    }
    
    .badge-guessed {
      background: #fff3cd;
      color: #856404;
    }
    
    .badge-complete {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-needed {
      background: #f8d7da;
      color: #721c24;
    }
    
    textarea.guessed, input.guessed {
      border-color: #ffc107;
      background: #fff9e6;
    }
    
    textarea.needed, input.needed {
      border-color: #dc3545;
      background: #fff5f5;
    }
    
    .ai-suggest-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border: 2px solid #667eea;
      color: #667eea;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      margin-top: 8px;
    }
    
    .ai-suggest-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #667eea25 0%, #764ba225 100%);
      transform: translateY(-1px);
    }
    
    .ai-suggest-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .ai-suggestion-box {
      display: none;
      margin-top: 12px;
      padding: 16px;
      background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
      border: 2px solid #667eea;
      border-radius: 8px;
      animation: slideDown 0.3s ease;
    }
    
    .ai-suggestion-box.show {
      display: block;
    }
    
    .ai-suggestion-text {
      font-size: 14px;
      color: #333;
      line-height: 1.6;
      margin-bottom: 12px;
    }
    
    .ai-suggestion-actions {
      display: flex;
      gap: 10px;
    }
    
    .ai-suggestion-actions button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .use-suggestion-btn {
      background: var(--primary-orange);
      color: white;
    }
    
    .use-suggestion-btn:hover {
      opacity: 0.9;
    }
    
    .dismiss-suggestion-btn {
      background: #e0e0e0;
      color: #666;
    }
    
    .dismiss-suggestion-btn:hover {
      background: #d0d0d0;
    }
    
    .character-count {
      font-size: 12px;
      color: #999;
      text-align: right;
      margin-top: 4px;
    }
    
    .regenerate-btn {
      width: 100%;
      padding: 15px;
      border: 2px solid #ff6b6b;
      background: white;
      color: #ff6b6b;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 12px;
    }

    .regenerate-btn:hover:not(:disabled) {
      background: #ff6b6b;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
    }

    .regenerate-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .regenerate-btn.processing {
      background: #ffd93d;
      border-color: #ffd93d;
      color: #333;
    }

    /* ‚úÖ PHASE NAVIGATION STYLES */
    .phase-stepper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .phase-step {
      flex: 1;
      text-align: center;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .phase-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: #e0e0e0;
      z-index: 0;
    }

    .phase-step.completed:not(:last-child)::after {
      background: var(--primary-orange);
    }

    .phase-step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e0e0e0;
      color: #999;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
      transition: all 0.3s ease;
    }

    .phase-step.active .phase-step-circle {
      background: var(--primary-orange);
      color: white;
      box-shadow: 0 4px 12px rgba(255, 102, 0, 0.3);
      transform: scale(1.1);
    }

    .phase-step.completed .phase-step-circle {
      background: #28a745;
      color: white;
    }

    .phase-step-label {
      font-size: 13px;
      font-weight: 600;
      color: #999;
      transition: color 0.3s ease;
    }

    .phase-step.active .phase-step-label {
      color: var(--primary-orange);
    }

    .phase-step.completed .phase-step-label {
      color: #28a745;
    }

    .phase-step-sublabel {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }

    /* ‚úÖ PHASE CONTENT */
    .phase-content {
      display: none;
    }

    .phase-content.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ‚úÖ PHASE NAVIGATION BUTTONS */
    .phase-navigation {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      flex: 1;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-draft {
      background: white;
      color: var(--primary-orange);
      border: 2px solid var(--primary-orange);
      flex: 1;
    }

    .btn-draft:hover {
      background: #FFF8F0;
    }

    .phase-intro {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border-left: 4px solid var(--primary-orange);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .phase-intro h3 {
      margin: 0 0 10px 0;
      color: var(--dark-neutral);
      font-size: 18px;
    }

    .phase-intro p {
      margin: 0;
      color: #666;
      line-height: 1.6;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- ‚úÖ Header -->
    <div class="header">
      <h1>üìù Complete Your Business Case</h1>
      <p>Take your time building a comprehensive business case. Progress through each phase at your own pace, and save your draft anytime.</p>
    </div>
    
    <!-- ‚úÖ PHASE STEPPER -->
    <div class="phase-stepper">
      <div class="phase-step active" data-phase="1" onclick="goToPhase(1)">
        <div class="phase-step-circle">1</div>
        <div class="phase-step-label">Foundation</div>
        <div class="phase-step-sublabel">Your Business</div>
      </div>
      <div class="phase-step" data-phase="2" onclick="goToPhase(2)">
        <div class="phase-step-circle">2</div>
        <div class="phase-step-label">Market Fit</div>
        <div class="phase-step-sublabel">Problem & Solution</div>
      </div>
      <div class="phase-step" data-phase="3" onclick="goToPhase(3)">
        <div class="phase-step-circle">3</div>
        <div class="phase-step-label">Growth Plan</div>
        <div class="phase-step-sublabel">Strategy & Goals</div>
      </div>
    </div>

    <!-- ‚úÖ Progress Bar -->
    <div class="progress" style="display: block;">
      <p class="progress-text" id="progressText">0% Complete</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progressBar"></div>
      </div>
    </div>
    
    <form id="businessCaseForm">
      
      <!-- ============================================ -->
      <!-- PHASE 1: FOUNDATION -->
      <!-- ============================================ -->
      <div class="phase-content active" id="phase1">
        
        <div class="phase-intro">
          <h3>üè¢ Phase 1: Foundation</h3>
          <p>Let's start with the basics. Tell us about your business, what you do, and why you exist. This forms the foundation of your business case.</p>
        </div>

        <!-- Business Name -->
        <div class="section">
          <div class="section-title">About Your Business</div>
          
          <div class="form-group">
            <label for="businessName">
              Business Name
              <span class="badge badge-complete">‚úì Confirmed</span>
            </label>
            <input type="text" id="businessName" readonly>
            <p class="field-note">This is pulled from your profile and cannot be changed here.</p>
          </div>
          
          <div class="form-group">
            <label for="whatYouDo">
              What does your business do?
              <span class="badge badge-complete" id="whatYouDoBadge">‚úì Complete</span>
            </label>
            <textarea 
              id="whatYouDo" 
              placeholder="Describe your products, services, or what you offer customers..."
              rows="4"
              maxlength="500"
            ></textarea>
            <div class="character-count"><span id="whatYouDoCount">0</span> / 500</div>
            <p class="field-note">Simple explanation: What do you sell or offer? Who benefits from it?</p>
            <button type="button" class="ai-suggest-btn" data-field="whatYouDo">
              <span>‚ú®</span> AI Suggest (R10.00)
            </button>
            <div class="ai-suggestion-box" id="whatYouDoSuggestion"></div>
          </div>

          <div class="form-group">
            <label for="productsServices">
              What specific products or services do you offer?
              <span class="badge badge-needed" id="productsServicesBadge">‚ö†Ô∏è Required</span>
            </label>
            <textarea 
              id="productsServices" 
              placeholder="List your main products/services with brief descriptions..."
              rows="4"
              maxlength="500"
            ></textarea>
            <div class="character-count"><span id="productsServicesCount">0</span> / 500</div>
            <p class="field-note">Be specific: "Organic skincare (face creams, body butters, lip balms)" or "Social media management packages (R2000-R8000/month)"</p>
            <button type="button" class="ai-suggest-btn" data-field="productsServices">
              <span>‚ú®</span> AI Suggest (R10.00)
            </button>
            <div class="ai-suggestion-box" id="productsServicesSuggestion"></div>
          </div>
        </div>

        <!-- Phase 1 Navigation -->
        <div class="section">
          <div class="phase-navigation">
            <button type="button" class="btn btn-draft" onclick="saveDraft()">
              üíæ Save Draft
            </button>
            <button type="button" class="btn btn-primary" onclick="nextPhase()">
              Next: Market Fit ‚Üí
            </button>
          </div>
          <div class="status" id="phase1Status"></div>
        </div>

      </div>

      <!-- ============================================ -->
      <!-- PHASE 2: MARKET FIT -->
      <!-- ============================================ -->
      <div class="phase-content" id="phase2">
        
        <div class="phase-intro">
          <h3>üéØ Phase 2: Market Fit</h3>
          <p>Every great business solves a problem. Help us understand the challenge you're addressing, your solution, and why customers choose you.</p>
        </div>

        <!-- The Challenge -->
        <div class="section">
          <div class="section-title">The Problem You Solve</div>
          
          <div class="form-group">
            <label for="theChallenge">
              What challenge or problem are you addressing?
              <span class="badge badge-guessed" id="theChallengeBadge">‚ö†Ô∏è Please Confirm</span>
            </label>
            <textarea 
              id="theChallenge" 
              placeholder="What pain point, frustration, or need does your business address?"
              rows="4"
              maxlength="500"
            ></textarea>
            <div class="character-count"><span id="theChallengeCount">0</span> / 500</div>
            <p class="field-note">Think: What would happen if your business didn't exist? What problem would remain unsolved?</p>
            <button type="button" class="ai-suggest-btn" data-field="theChallenge">
              <span>‚ú®</span> AI Suggest (R10.00)
            </button>
            <div class="ai-suggestion-box" id="theChallengeSuggestion"></div>
          </div>
          
          <div class="form-group">
            <label for="yourSolution">
              How does your business solve this problem?
              <span class="badge badge-complete" id="yourSolutionBadge">‚úì Complete</span>
            </label>
            <textarea 
              id="yourSolution" 
              placeholder="Explain your approach, method, or unique way of solving the problem..."
              rows="4"
              maxlength="500"
            ></textarea>
            <div class="character-count"><span id="yourSolutionCount">0</span> / 500</div>
            <p class="field-note">What makes your solution work? What's your approach?</p>
            <button type="button" class="ai-suggest-btn" data-field="yourSolution">
              <span>‚ú®</span> AI Suggest (R10.00)
            </button>
            <div class="ai-suggestion-box" id="yourSolutionSuggestion"></div>
          </div>

          <div class="form-group">
            <label for="whyChooseYou">
              Why will people choose your business?
              <span class="badge badge-complete" id="whyChooseYouBadge">‚úì Complete</span>
            </label>
            <textarea 
              id="whyChooseYou" 
              placeholder="What's special, different, or better about your business?"
              rows="4"
              maxlength="500"
            ></textarea>
            <div class="character-count"><span id="whyChooseYouCount">0</span> / 500</div>
            <p class="field-note">Think: Quality, price, convenience, trust, unique features, customer service, local focus, etc.</p>
            <button type="button" class="ai-suggest-btn" data-field="whyChooseYou">
              <span>‚ú®</span> AI Suggest (R10.00)
            </button>
            <div class="ai-suggestion-box" id="whyChooseYouSuggestion"></div>
          </div>
        </div>

        <!-- Your Customers -->
        <div class="section">
          <div class="section-title">Your Target Market</div>
          
          <div class="form-group">
            <label for="yourCustomers">
              Who are your ideal customers?
              <span class="badge badge-guessed" id="yourCustomersBadge">‚ö†Ô∏è Please Confirm</span>
            </label>
            <textarea 
              id="yourCustomers" 
              placeholder="Describe your target audience: age, location, interests, needs..."
              rows="4"
              maxlength="500"
            ></textarea>
            <div class="character-count"><span id="yourCustomersCount">0</span> / 500</div>
            <p class="field-note">Examples: "Young professionals in Cape Town who care about sustainability"</p>
            <button type="button" class="ai-suggest-btn" data-field="yourCustomers">
              <span>‚ú®</span> AI Suggest (R10.00)
            </button>
            <div class="ai-suggestion-box" id="yourCustomersSuggestion"></div>
          </div>

          <div class="form-group">
            <label for="customerProfile">
              Describe your typical customer in detail
              <span class="badge badge-needed" id="customerProfileBadge">‚ö†Ô∏è Required</span>
            </label>
            <textarea 
              id="customerProfile" 
              placeholder="Age range, gender, location, income level, interests, behaviors..."
              rows="4"
              maxlength="500"
            ></textarea>
            <div class="character-count"><span id="customerProfileCount">0</span> / 500</div>
            <p class="field-note">Example: "Women 25-40 in urban areas, eco-conscious, willing to pay premium for quality"</p>
            <button type="button" class="ai-suggest-btn" data-field="customerProfile">
              <span>‚ú®</span> AI Suggest (R10.00)
            </button>
            <div class="ai-suggestion-box" id="customerProfileSuggestion"></div>
          </div>
        </div>

        <!-- Phase 2 Navigation -->
        <div class="section">
          <div class="phase-navigation">
            <button type="button" class="btn btn-secondary" onclick="previousPhase()">
              ‚Üê Back
            </button>
            <button type="button" class="btn btn-draft" onclick="saveDraft()">
              üíæ Save Draft
            </button>
            <button type="button" class="btn btn-primary" onclick="nextPhase()">
              Next: Growth Plan ‚Üí
            </button>
          </div>
          <div class="status" id="phase2Status"></div>
        </div>

      </div>

      <!-- ============================================ -->
      <!-- PHASE 3: GROWTH PLAN -->
      <!-- ============================================ -->
      <div class="phase-content" id="phase3">
        
        <div class="phase-intro">
          <h3>üí∞ Phase 3: Growth Plan</h3>
          <p>Let's map out your business model, revenue strategy, and growth goals. This helps us provide the right tools and support for your journey.</p>
        </div>

        <!-- Revenue Model -->
        <div class="section">
          <div class="section-title">Your Business Model</div>
          
          <div class="form-group">
            <label for="howYouMakeMoney">
              How does your business generate income?
              <span class="badge badge-guessed" id="howYouMakeMoneyBadge">‚ö†Ô∏è Please Confirm</span>
            </label>
            <textarea 
              id="howYouMakeMoney" 
              placeholder="Do you sell products? Charge for services? Subscriptions? Commissions?"
              rows="4"
              maxlength="500"
            ></textarea>
            <div class="character-count"><span id="howYouMakeMoneyCount">0</span> / 500</div>
            <p class="field-note">Examples: "Sell handmade products online", "Charge R500/hour for consulting"</p>
            <button type="button" class="ai-suggest-btn" data-field="howYouMakeMoney">
              <span>‚ú®</span> AI Suggest (R10.00)
            </button>
            <div class="ai-suggestion-box" id="howYouMakeMoneySuggestion"></div>
          </div>
        </div>

        <!-- Growth Goals -->
        <div class="section">
          <div class="section-title">Your Growth Vision</div>
          
          <div class="form-group">
            <label for="growthGoals">
              What are your growth goals for the next 6-12 months?
              <span class="badge badge-needed" id="growthGoalsBadge">‚ö†Ô∏è Required</span>
            </label>
            <textarea 
              id="growthGoals" 
              placeholder="Revenue targets, customer acquisition, new products, expansion plans..."
              rows="4"
              maxlength="500"
            ></textarea>
            <div class="character-count"><span id="growthGoalsCount">0</span> / 500</div>
            <p class="field-note">Examples: "Double monthly revenue to R20k", "Launch 3 new products", "Expand to Johannesburg"</p>
            <button type="button" class="ai-suggest-btn" data-field="growthGoals">
              <span>‚ú®</span> AI Suggest (R10.00)
            </button>
            <div class="ai-suggestion-box" id="growthGoalsSuggestion"></div>
          </div>

          <div class="form-group">
            <label for="howZukeCanHelp">
              What specific support do you need from Zuke?
            </label>
            <textarea 
              id="howZukeCanHelp" 
              placeholder="Marketing? Branding? Automation? Connections? Funding? Be specific..."
              rows="4"
              maxlength="500"
            ></textarea>
            <div class="character-count"><span id="howZukeCanHelpCount">0</span> / 500</div>
            <p class="field-note">This helps us prioritize the right tools and connections for your business.</p>
            <button type="button" class="ai-suggest-btn" data-field="howZukeCanHelp">
              <span>‚ú®</span> AI Suggest (R10.00)
            </button>
            <div class="ai-suggestion-box" id="howZukeCanHelpSuggestion"></div>
          </div>
        </div>

        <!-- Phase 3 Navigation -->
        <div class="section">
          <div class="phase-navigation">
            <button type="button" class="btn btn-secondary" onclick="previousPhase()">
              ‚Üê Back
            </button>
            <button type="button" class="btn btn-draft" onclick="saveDraft()">
              üíæ Save Draft
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              üöÄ Submit Business Case
            </button>
          </div>
          <div class="status" id="phase3Status"></div>
        </div>

      </div>
      
    </form>
    
  </div>

  <script src="/js/dataManager.js"></script>
  
  <script>
    // ========== GLOBAL CONFIGURATION ==========
    let auth0Client = null;
    let currentBusiness = null;
    let openAIConfig = null;
    let businessCaseData = null;
    
    let userEmail = null;
    let businessId = null;
    let currentPhase = 1;
    
    const AI_SUGGESTION_COST = 10.00;
    
    // ‚úÖ PHASE CONFIGURATION
    const PHASES = {
      1: {
        name: 'Foundation',
        fields: ['whatYouDo', 'productsServices']
      },
      2: {
        name: 'Market Fit',
        fields: ['theChallenge', 'yourSolution', 'whyChooseYou', 'yourCustomers', 'customerProfile']
      },
      3: {
        name: 'Growth Plan',
        fields: ['howYouMakeMoney', 'growthGoals', 'howZukeCanHelp']
      }
    };
    
    const formFields = {
      whatYouDo: { required: true, phase: 1 },
      productsServices: { required: true, phase: 1 },
      theChallenge: { required: true, phase: 2 },
      yourSolution: { required: true, phase: 2 },
      whyChooseYou: { required: true, phase: 2 },
      yourCustomers: { required: true, phase: 2 },
      customerProfile: { required: true, phase: 2 },
      howYouMakeMoney: { required: true, phase: 3 },
      growthGoals: { required: true, phase: 3 },
      howZukeCanHelp: { required: false, phase: 3 }
    };
    
    // ========== AUTH0 & OPENAI CONFIG (REUSABLE) ==========
    async function getAuth0Client() {
      if (window.auth0Client) return window.auth0Client;
      
      try {
        const response = await fetch("/auth_config.json");
        const config = await response.json();
        auth0Client = await auth0.createAuth0Client({
          domain: config.domain,
          clientId: config.clientId,
          cacheLocation: 'localstorage',
          useRefreshTokens: true
        });
        window.auth0Client = auth0Client;
        return auth0Client;
      } catch (error) {
        console.error("Error configuring Auth0:", error);
        return null;
      }
    }
    
    async function getOpenAIConfig() {
      if (openAIConfig) return openAIConfig;
      
      try {
        const response = await fetch('/api/get-openai-config');
        if (!response.ok) throw new Error('Failed to get OpenAI config');
        openAIConfig = await response.json();
        return openAIConfig;
      } catch (error) {
        console.error('Error fetching OpenAI config:', error);
        return null;
      }
    }
    
    // ========== CALL AZURE OPENAI (REUSABLE) ==========
    async function callAzureOpenAI(prompt) {
      const config = await getOpenAIConfig();
      if (!config) throw new Error('OpenAI config not available');
    
      const url = `${config.endpoint}openai/deployments/${config.deployment}/chat/completions?api-version=2025-01-01-preview`;
    
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'api-key': config.apiKey
        },
        body: JSON.stringify({
          messages: [
            {
              role: "system",
              content: "You are a business consultant helping African entrepreneurs articulate their business case. Provide clear, concise, professional answers in simple English. Keep responses under 300 words."
            },
            {
              role: "user",
              content: prompt
            }
          ],
          max_tokens: 500,
          temperature: 0.7
        })
      });
    
      if (!response.ok) {
        throw new Error(`OpenAI API error: ${response.status}`);
      }
    
      const data = await response.json();
      return data.choices[0].message.content.trim();
    }
    
    // ========== LOAD BUSINESS DATA FROM LOCALSTORAGE ==========
    async function loadBusinessData() {
      try {
        const auth0 = await getAuth0Client();
        if (!auth0) {
          showStatus('Authentication required. Please log in.', 'error');
          return;
        }
    
        const isAuthenticated = await auth0.isAuthenticated();
        if (!isAuthenticated) {
          showStatus('Please log in to continue.', 'error');
          return;
        }

        const user = await auth0.getUser();
        userEmail = user.email;
        console.log('‚úÖ Authenticated user:', userEmail);

        const cachedBusinessId = localStorage.getItem('selectedBusinessId');
        const cachedBusinessData = localStorage.getItem('selectedBusiness');
        
        if (cachedBusinessId && cachedBusinessData) {
          try {
            currentBusiness = JSON.parse(cachedBusinessData);
            businessId = cachedBusinessId;
            
            businessCaseData = currentBusiness.initial_business_case || {};
            
            console.log('‚úÖ Loaded business from localStorage');
            
            populateForm();
            loadSavedPhase();
            updateProgress();
            updatePhaseCompletion();
            return;
            
          } catch (e) {
            console.error('Error parsing cached business data:', e);
          }
        }

        console.log('üîç Checking for dataManager...');
        
        let retries = 0;
        while (!window.dataManager && retries < 10) {
          console.log(`‚è≥ Waiting for dataManager (attempt ${retries + 1}/10)...`);
          await new Promise(resolve => setTimeout(resolve, 300));
          retries++;
        }
    
        if (!window.dataManager) {
          console.error('‚ùå DataManager not available');
          
          const urlParams = new URLSearchParams(window.location.search);
          businessId = urlParams.get('businessId') || urlParams.get('ID');
          
          if (businessId) {
            console.log('üì° Fetching business data from API...');
            const response = await fetch(
              `/api/business-case/get?businessId=${businessId}&userEmail=${encodeURIComponent(userEmail)}`
            );
            
            if (!response.ok) {
              throw new Error('Failed to load business data from API');
            }
            
            const data = await response.json();
            
            currentBusiness = {
              _id: businessId,
              store_info: {
                name: data.businessInfo?.name || ''
              },
              initial_business_case: data.businessCase || {}
            };
            
            businessCaseData = currentBusiness.initial_business_case;
            console.log('‚úÖ Business data loaded from API');
          } else {
            throw new Error('No business ID found');
          }
        } else {
          console.log('‚úÖ DataManager available');
          currentBusiness = window.dataManager.getSelectedBusinessOrFirst();
          
          if (!currentBusiness) {
            throw new Error('No business selected');
          }

          businessId = currentBusiness._id;
          businessCaseData = currentBusiness.initial_business_case || {};
          
          console.log('‚úÖ Business data loaded from dataManager');
        }
        
        populateForm();
        loadSavedPhase();
        updateProgress();
        updatePhaseCompletion();
        
      } catch (error) {
        console.error('‚ùå Error loading business data:', error);
        showStatusInPhase('Failed to load business information. Please refresh the page.', 'error', currentPhase);
      }
    }
    
    // ========== POPULATE FORM WITH EXISTING DATA ==========
    function populateForm() {
      if (!currentBusiness) {
        console.warn('‚ö†Ô∏è No currentBusiness available');
        return;
      }
      
      const businessName = currentBusiness.store_info?.name || 
                          currentBusiness.marketplace_info?.store_owner_first_name + ' ' + 
                          currentBusiness.marketplace_info?.store_owner_last_name || 
                          '';
      
      document.getElementById('businessName').value = businessName;
      console.log('üìù Business name set:', businessName);
      
      if (!businessCaseData || Object.keys(businessCaseData).length === 0) {
        console.log('‚ÑπÔ∏è No existing business case data to populate');
        return;
      }
      
      const fieldMapping = {
        whatYouDo:                 'what_you_do',
        theChallenge:              'the_challenge',
        yourSolution:              'your_solution',
        whyChooseYou:              'why_people_will_choose_you',
        yourCustomers:             'your_customers',
        howYouMakeMoney:           'how_you_make_money',
        productsServices:          'products_services',
        customerProfile:           'customer_profile',
        growthGoals:               'growth_goals',
        howZukeCanHelp:            'how_zuke_can_help'
      };
      
      let fieldsPopulated = 0;
      
      Object.keys(fieldMapping).forEach(fieldId => {
        const dbField = fieldMapping[fieldId];
        const value = businessCaseData[dbField] || '';
        const element = document.getElementById(fieldId);
        
        if (element && value) {
          element.value = value;
          updateCharCount(fieldId);
          fieldsPopulated++;
          
          const badge = document.getElementById(`${fieldId}Badge`);
          if (badge) {
            const isGuessed = value.includes('(Guessed)');
            
            if (isGuessed) {
              badge.className = 'badge badge-guessed';
              badge.textContent = '‚ö†Ô∏è Please Confirm';
              element.classList.add('guessed');
              element.classList.remove('needed');
            } else if (value.length > 20) {
              badge.className = 'badge badge-complete';
              badge.textContent = '‚úì Complete';
              element.classList.remove('guessed', 'needed');
            } else {
              badge.className = 'badge badge-needed';
              badge.textContent = '‚ö†Ô∏è Required';
              element.classList.add('needed');
              element.classList.remove('guessed');
            }
          }
        } else if (element && !value) {
          const badge = document.getElementById(`${fieldId}Badge`);
          if (badge && formFields[fieldId]?.required) {
            badge.className = 'badge badge-needed';
            badge.textContent = '‚ö†Ô∏è Required';
            element.classList.add('needed');
          }
        }
      });
      
      console.log(`‚úÖ Form populated with ${fieldsPopulated} fields`);
    }
    
    // ========== PHASE NAVIGATION ==========
    function goToPhase(phaseNumber) {
      if (phaseNumber < 1 || phaseNumber > 3) return;
      
      // Hide all phases
      document.querySelectorAll('.phase-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Show target phase
      document.getElementById(`phase${phaseNumber}`).classList.add('active');
      
      // Update stepper
      document.querySelectorAll('.phase-step').forEach(step => {
        step.classList.remove('active');
      });
      document.querySelector(`[data-phase="${phaseNumber}"]`).classList.add('active');
      
      currentPhase = phaseNumber;
      saveCurrentPhase();
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    window.nextPhase = function() {
      // Validate current phase before moving forward
      const phaseFields = PHASES[currentPhase].fields;
      const errors = [];
      
      phaseFields.forEach(fieldId => {
        if (formFields[fieldId]?.required) {
          const field = document.getElementById(fieldId);
          const value = field.value.trim();
          
          if (value.length < 20) {
            errors.push(fieldId);
            field.style.borderColor = '#dc3545';
          }
        }
      });
      
      if (errors.length > 0) {
        showStatusInPhase(
          `‚ö†Ô∏è Please complete all required fields in this phase before continuing.`,
          'error',
          currentPhase
        );
        
        // Scroll to first error
        const firstError = document.getElementById(errors[0]);
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return;
      }
      
      if (currentPhase < 3) {
        goToPhase(currentPhase + 1);
      }
    };
    
    window.previousPhase = function() {
      if (currentPhase > 1) {
        goToPhase(currentPhase - 1);
      }
    };
    
    // ========== SAVE/LOAD PHASE ==========
    function saveCurrentPhase() {
      localStorage.setItem(`businessCase_${businessId}_currentPhase`, currentPhase.toString());
    }
    
    function loadSavedPhase() {
      const savedPhase = localStorage.getItem(`businessCase_${businessId}_currentPhase`);
      if (savedPhase) {
        const phase = parseInt(savedPhase);
        if (phase >= 1 && phase <= 3) {
          goToPhase(phase);
        }
      }
    }
    
    // ========== UPDATE PHASE COMPLETION ==========
    function updatePhaseCompletion() {
      Object.keys(PHASES).forEach(phaseNum => {
        const phase = parseInt(phaseNum);
                const fields = PHASES[phase].fields;
        let allComplete = true;
        
        fields.forEach(fieldId => {
          if (formFields[fieldId]?.required) {
            const field = document.getElementById(fieldId);
            if (!field || field.value.trim().length < 20) {
              allComplete = false;
            }
          }
        });
        
        const stepElement = document.querySelector(`[data-phase="${phase}"]`);
        if (allComplete) {
          stepElement.classList.add('completed');
        } else {
          stepElement.classList.remove('completed');
        }
      });
    }
    
    // ========== UPDATE CHARACTER COUNT ==========
    function updateCharCount(fieldId) {
      const field = document.getElementById(fieldId);
      const counter = document.getElementById(`${fieldId}Count`);
      
      if (field && counter) {
        counter.textContent = field.value.length;
        
        if (field.value.length > 450) {
          counter.style.color = '#dc3545';
        } else if (field.value.length > 400) {
          counter.style.color = '#ffc107';
        } else {
          counter.style.color = '#999';
        }
      }
    }
    
    // ========== CALCULATE PROGRESS ==========
    function updateProgress() {
      const totalFields = Object.keys(formFields).filter(f => formFields[f].required).length;
      let completedFields = 0;
      
      Object.keys(formFields).forEach(fieldId => {
        if (!formFields[fieldId].required) return;
        
        const field = document.getElementById(fieldId);
        if (field && field.value.trim().length > 20) {
          completedFields++;
        }
      });
      
      const progress = Math.round((completedFields / totalFields) * 100);
      
      document.getElementById('progressBar').style.width = `${progress}%`;
      document.getElementById('progressText').textContent = `${progress}% Complete (${completedFields}/${totalFields} fields)`;
      
      updatePhaseCompletion();
    }
    
    // ========== BUILD PROMPT FOR FIELD ==========
    function buildPromptForField(fieldId) {
      const businessName = document.getElementById('businessName').value;
      const businessOverview = businessCaseData?.business_overview || 
                              currentBusiness?.store_info?.description || 
                              currentBusiness?.marketplace_info?.marketplace_description || 
                              document.getElementById('whatYouDo').value || '';
      
      const prompts = {
        whatYouDo: `Business: ${businessName}\n\nBased on available info: ${businessOverview}\n\nWrite a clear, compelling 2-3 sentence description of what this business does and who it serves.`,
        
        theChallenge: `Business: ${businessName}\nWhat they do: ${document.getElementById('whatYouDo').value}\n\nWhat problem or challenge does this business solve for its customers? Write 2-3 sentences explaining the pain point or need they address.`,
        
        yourSolution: `Business: ${businessName}\nProblem: ${document.getElementById('theChallenge').value}\n\nHow does this business solve that problem? What's their approach, method, or unique way of addressing it? Write 2-3 sentences.`,
        
        whyChooseYou: `Business: ${businessName}\nWhat they do: ${document.getElementById('whatYouDo').value}\nSolution: ${document.getElementById('yourSolution').value}\n\nWhat makes this business different or better than alternatives? What's their value proposition? Why would customers choose them? Write 2-3 sentences.`,
        
        yourCustomers: `Business: ${businessName}\nWhat they do: ${document.getElementById('whatYouDo').value}\nValue proposition: ${document.getElementById('whyChooseYou').value}\n\nWho are the ideal customers for this business? Describe the target market: demographics, needs, behaviors, and why they would benefit. Write 2-3 sentences.`,
        
        howYouMakeMoney: `Business: ${businessName}\nWhat they do: ${document.getElementById('whatYouDo').value}\n\nHow does this business generate revenue? What's their business model and monetization strategy? Write 2-3 sentences.`,
        
        productsServices: `Business: ${businessName}\nBusiness overview: ${document.getElementById('whatYouDo').value}\n\nList the specific products or services this business offers. Be detailed and specific about each offering.`,
        
        customerProfile: `Business: ${businessName}\nTarget market: ${document.getElementById('yourCustomers').value}\n\nCreate a detailed customer profile including: age range, gender, location, income level, interests, behaviors, pain points, and buying motivations.`,
        
        growthGoals: `Business: ${businessName}\nWhat they do: ${document.getElementById('whatYouDo').value}\nRevenue model: ${document.getElementById('howYouMakeMoney').value}\n\nSuggest realistic, specific growth goals for this business over the next 6-12 months. Include revenue targets, customer acquisition numbers, new product launches, or market expansion plans.`,
        
        howZukeCanHelp: `Business: ${businessName}\nWhat they do: ${document.getElementById('whatYouDo').value}\nChallenges: ${document.getElementById('theChallenge').value}\nGoals: ${document.getElementById('growthGoals').value}\n\nBased on this business, their challenges, and goals, what specific support could Zuke Marketplace provide? Consider: marketing tools, branding services, automation, partnerships, funding connections, training, etc.`
      };
      
      return prompts[fieldId] || `Improve this answer for ${fieldId}`;
    }
    
    // ========== AI SUGGESTION HANDLER (WITH WALLET DEDUCTION) ==========
    async function handleAISuggestion(fieldId) {
      const button = document.querySelector(`[data-field="${fieldId}"]`);
      const suggestionBox = document.getElementById(`${fieldId}Suggestion`);
      
      button.disabled = true;
      button.innerHTML = '<span class="loading-spinner"></span> Generating...';
      
      try {
        await deductCost(AI_SUGGESTION_COST, `AI Business Case Suggestion: ${fieldId}`);
        
        const prompt = buildPromptForField(fieldId);
        const suggestion = await callAzureOpenAI(prompt);
        
        suggestionBox.innerHTML = `
          <p class="ai-suggestion-text">${suggestion}</p>
          <div class="ai-suggestion-actions">
            <button class="use-suggestion-btn" onclick="useSuggestion('${fieldId}')">
              ‚úì Use This
            </button>
            <button class="dismiss-suggestion-btn" onclick="dismissSuggestion('${fieldId}')">
              ‚úï Dismiss
            </button>
          </div>
        `;
        
        suggestionBox.classList.add('show');
        suggestionBox.dataset.suggestion = suggestion;
        
        showStatusInPhase(`‚úÖ AI suggestion generated! R${AI_SUGGESTION_COST.toFixed(2)} deducted`, 'success', currentPhase);
        
      } catch (error) {
        console.error('AI suggestion error:', error);
        showStatusInPhase(error.message, 'error', currentPhase);
      } finally {
        button.disabled = false;
        button.innerHTML = '<span>‚ú®</span> AI Suggest (R10.00)';
      }
    }
    
    // ========== DEDUCT COST FROM WALLET (REUSABLE PATTERN) ==========
    async function deductCost(amount, description) {
      try {
        const response = await fetch('/api/social-post/post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            businessId: businessId,
            userEmail: userEmail,
            platforms: [],
            postContent: { text: description },
            totalCost: amount,
            skipPosting: true
          })
        });

        if (!response.ok) {
          const error = await response.json();
          
          if (response.status === 402) {
            throw new Error(
              `Insufficient funds!\n\nRequired: R${amount.toFixed(2)}\nBalance: ${error.formatted_balance}\n\nPlease add credits to continue.`
            );
          }
          
          throw new Error(error.error || 'Payment failed');
        }

        const result = await response.json();
        console.log(`‚úÖ ${description} cost deducted: R${amount.toFixed(2)}`);
        return result;

      } catch (error) {
        throw error;
      }
    }
    
    // ========== USE AI SUGGESTION ==========
    window.useSuggestion = function(fieldId) {
      const suggestionBox = document.getElementById(`${fieldId}Suggestion`);
      const field = document.getElementById(fieldId);
      const suggestion = suggestionBox.dataset.suggestion;
      
      if (suggestion) {
        field.value = suggestion;
        updateCharCount(fieldId);
        updateProgress();
        
        field.classList.remove('guessed', 'needed');
        field.style.borderColor = '#28a745';
        
        setTimeout(() => {
          field.style.borderColor = '';
        }, 2000);
        
        const badge = document.getElementById(`${fieldId}Badge`);
        if (badge) {
          badge.className = 'badge badge-complete';
          badge.textContent = '‚úì Complete';
        }
        
        dismissSuggestion(fieldId);
        showStatusInPhase('‚úÖ AI suggestion applied!', 'success', currentPhase);
        
        setTimeout(() => {
          clearPhaseStatus(currentPhase);
        }, 2000);
      }
    };
    
    // ========== DISMISS AI SUGGESTION ==========
    window.dismissSuggestion = function(fieldId) {
      const suggestionBox = document.getElementById(`${fieldId}Suggestion`);
      suggestionBox.classList.remove('show');
    };
    
    // ========== COLLECT FORM DATA ==========
    function collectFormData() {
      return {
        business_name: document.getElementById('businessName').value.trim(),
        what_you_do: document.getElementById('whatYouDo').value.trim(),
        the_challenge: document.getElementById('theChallenge').value.trim(),
        your_solution: document.getElementById('yourSolution').value.trim(),
        why_people_will_choose_you: document.getElementById('whyChooseYou').value.trim(),
        your_customers: document.getElementById('yourCustomers').value.trim(),
        how_you_make_money: document.getElementById('howYouMakeMoney').value.trim(),
        products_services: document.getElementById('productsServices').value.trim(),
        customer_profile: document.getElementById('customerProfile').value.trim(),
        growth_goals: document.getElementById('growthGoals').value.trim(),
        how_zuke_can_help: document.getElementById('howZukeCanHelp').value.trim()
      };
    }
    
    // ========== SAVE DRAFT ==========
    window.saveDraft = async function() {
      try {
        console.log('üíæ Saving draft...');
        
        if (!businessId || !userEmail) {
          console.error('‚ùå Missing businessId or userEmail');
          showStatusInPhase('Cannot save: Missing required information', 'error', currentPhase);
          return;
        }
        
        const formData = collectFormData();
        
        const hasContent = Object.values(formData).some(val => val && val.length > 0);
        if (!hasContent) {
          console.log('‚ö†Ô∏è No content to save yet');
          showStatusInPhase('No content to save yet', 'info', currentPhase);
          return;
        }
        
        const payload = {
          businessId: businessId,
          userEmail: userEmail,
          businessCase: formData,
          isDraft: true,
          currentPhase: currentPhase
        };
        
        console.log('üì§ Sending draft payload');
        
        const response = await fetch('/api/business-case/save-draft', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          console.error('‚ùå Server error:', errorData);
          throw new Error(errorData.error || 'Failed to save draft');
        }
        
        const data = await response.json();
        console.log('‚úÖ Draft saved:', data);
        
        showStatusInPhase('‚úÖ Draft saved successfully', 'success', currentPhase);
        
        setTimeout(() => {
          clearPhaseStatus(currentPhase);
        }, 3000);
        
      } catch (error) {
        console.error('‚ùå Save draft error:', error);
        showStatusInPhase('Failed to save draft: ' + error.message, 'error', currentPhase);
      }
    };
    
    // ========== VALIDATE FORM ==========
    function validateForm() {
      const errors = [];
      
      Object.keys(formFields).forEach(fieldId => {
        if (!formFields[fieldId].required) return;
        
        const field = document.getElementById(fieldId);
        const value = field.value.trim();
        
        if (value.length < 20) {
          const labelText = field.previousElementSibling.textContent.split('\n')[0].trim();
          errors.push(`"${labelText}" needs at least 20 characters`);
          field.style.borderColor = '#dc3545';
        } else {
          field.style.borderColor = '';
        }
      });
      
      return errors;
    }
    
    // ========== SUBMIT FORM ==========
    async function submitForm(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      
      // Validate all phases
      const errors = validateForm();
      
      if (errors.length > 0) {
        showStatusInPhase(
          '‚ùå Please complete all required fields:\n\n' + errors.join('\n'),
          'error',
          3
        );
        
        // Find which phase has errors and go there
        for (let phase = 1; phase <= 3; phase++) {
          const phaseFields = PHASES[phase].fields;
          const phaseHasErrors = phaseFields.some(fieldId => {
            if (!formFields[fieldId]?.required) return false;
            const field = document.getElementById(fieldId);
            return field && field.value.trim().length < 20;
          });
          
          if (phaseHasErrors) {
            goToPhase(phase);
            break;
          }
        }
        
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading-spinner"></span> Submitting...';
      
      try {
        const formData = collectFormData();
        formData.completed_at = new Date().toISOString();
        
        console.log('üì§ Submitting business case...');
        
        const saveResponse = await fetch('/api/business-case/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            businessId: businessId,
            userEmail: userEmail,
            businessCase: formData,
            isDraft: false
          })
        });
        
        if (!saveResponse.ok) {
          const errorData = await saveResponse.json();
          console.error('‚ùå Server error:', errorData);
          throw new Error(errorData.error || 'Failed to save business case');
        }
        
        const saveResult = await saveResponse.json();
        console.log('‚úÖ Business case submitted:', saveResult);
        
        showStatusInPhase(
          'üéâ Business Case Submitted Successfully!\n\n' +
          'Your business profile has been updated. Our team will review your information and unlock relevant features for your business.\n\n' +
          'You will receive an email confirmation shortly.',
          'success',
          3
        );
        
        // Update progress to 100%
        document.getElementById('progressBar').style.width = '100%';
        document.getElementById('progressText').textContent = '100% Complete';
        
        // Mark all phases as completed
        document.querySelectorAll('.phase-step').forEach(step => {
          step.classList.add('completed');
        });
        
        // Clear saved phase
        localStorage.removeItem(`businessCase_${businessId}_currentPhase`);
        
        // Disable form after successful submission
        setTimeout(() => {
          const formElements = document.querySelectorAll('textarea:not([readonly]), button:not(.submit-btn)');
          formElements.forEach(el => el.disabled = true);
          
          submitBtn.textContent = '‚úì Submitted';
          submitBtn.style.background = '#28a745';
          
          // Redirect after 5 seconds
          setTimeout(() => {
            window.location.href = `/pages/business-tools/business-case.html?email=${userEmail}&businessId=${businessId}`;
          }, 5000);
        }, 2000);
        
      } catch (error) {
        console.error('Submit error:', error);
        showStatusInPhase('‚ùå Failed to submit business case. Please try again.', 'error', 3);
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'üöÄ Submit Business Case';
      }
    }
    
    // ========== REGENERATE BUSINESS CASE ==========
    async function regenerateBusinessCase() {
      const regenerateBtn = document.getElementById('regenerateBtn');
      const regenerateInfo = document.getElementById('regenerateInfo');
      const regenerateInfoText = document.getElementById('regenerateInfoText');
      
      const confirmed = confirm(
        'ü§ñ Regenerate Business Case with AI?\n\n' +
        'This will:\n' +
        '‚Ä¢ Send your business data to our AI processing system\n' +
        '‚Ä¢ Generate a fresh business case based on current information\n' +
        '‚Ä¢ Update all fields with AI-generated content\n' +
        '‚Ä¢ This may take 30-60 seconds\n\n' +
        'Your current draft will be overwritten. Continue?'
      );
      
      if (!confirmed) return;
      
      regenerateBtn.disabled = true;
      regenerateBtn.className = 'regenerate-btn processing';
      regenerateBtn.innerHTML = '<span class="loading-spinner"></span> Processing with AI...';
      
      regenerateInfo.style.display = 'block';
      regenerateInfoText.innerHTML = '‚è≥ Sending your business data to AI processing system...';
      
      try {
        console.log('üîÑ Initiating regeneration...');
        
        const response = await fetch('/api/regenerate-business-case', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            businessId: businessId,
            userEmail: userEmail
          })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to regenerate business case');
        }
        
        console.log('‚úÖ Regeneration response:', data);
        
        regenerateInfoText.innerHTML = 
          '‚úÖ <strong>AI Processing Started!</strong><br><br>' +
          `Business: ${data.business_name}<br>` +
          'The AI is now analyzing your business and generating a comprehensive business case.<br><br>' +
          '‚è≥ This typically takes 30-60 seconds. The page will automatically refresh when complete.';
        
        let pollCount = 0;
        const maxPolls = 30;
        
        const pollInterval = setInterval(async () => {
          pollCount++;
          
          try {
            console.log(`üîç Polling for updates (${pollCount}/${maxPolls})...`);
            
            const checkResponse = await fetch(
              `/api/businesses?email=${encodeURIComponent(userEmail)}`
            );
            
            if (checkResponse.ok) {
              const checkData = await checkResponse.json();
              const updatedBusiness = checkData.businesses?.find(b => b._id === businessId);
              
              if (updatedBusiness?.processing_status?.ai_processed) {
                console.log('‚úÖ AI processing complete!');
                clearInterval(pollInterval);
                
                regenerateInfoText.innerHTML = 
                  'üéâ <strong>Business Case Regenerated!</strong><br><br>' +
                  'Your business case has been successfully updated with AI-generated content.<br>' +
                  'The page will refresh in 3 seconds...';
                
                if (window.dataManager) {
                  window.dataManager.clearCache();
                }
                
                setTimeout(() => {
                  window.location.reload();
                }, 3000);
              } else if (pollCount >= maxPolls) {
                clearInterval(pollInterval);
                throw new Error('Processing timeout - please refresh the page in a few moments');
              } else {
                regenerateInfoText.innerHTML = 
                  `‚è≥ AI is processing your business case... (${pollCount * 2}s elapsed)`;
              }
            }
          } catch (pollError) {
            console.error('Polling error:', pollError);
          }
        }, 2000);
        
      } catch (error) {
        console.error('‚ùå Regeneration error:', error);
        
        regenerateBtn.disabled = false;
        regenerateBtn.className = 'regenerate-btn';
        regenerateBtn.innerHTML = 'ü§ñ Regenerate Business Case with AI';
        
        regenerateInfoText.innerHTML = 
          '‚ùå <strong>Error:</strong><br>' + error.message + '<br><br>' +
          'Please try again or contact support if the issue persists.';
        
        setTimeout(() => {
          regenerateInfo.style.display = 'none';
        }, 10000);
      }
    }
    
    // ========== SHOW STATUS IN PHASE (REUSABLE PATTERN) ==========
    function showStatusInPhase(message, type, phase) {
      const statusElement = document.getElementById(`phase${phase}Status`);
      if (statusElement) {
        statusElement.textContent = message;
        statusElement.className = `status ${type}`;
        statusElement.style.display = 'block';
        
        if (type === 'info' || type === 'success') {
          setTimeout(() => {
            statusElement.style.display = 'none';
          }, 5000);
        }
      }
    }
    
    function clearPhaseStatus(phase) {
      const statusElement = document.getElementById(`phase${phase}Status`);
      if (statusElement) {
        statusElement.style.display = 'none';
      }
    }
    
    // ========== UPDATE BADGES ==========
    function updateAllBadges() {
      const allFieldIds = [
        'whatYouDo',
        'theChallenge', 
        'yourSolution',
        'whyChooseYou',
        'yourCustomers',
        'howYouMakeMoney',
        'productsServices',
        'customerProfile',
        'growthGoals',
        'howZukeCanHelp'
      ];
      
      allFieldIds.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const badge = document.getElementById(`${fieldId}Badge`);
        
        if (!field || !badge) return;
        
        const value = field.value.trim();
        const isGuessed = value.includes('(Guessed)');
        
        if (value.length === 0) {
          badge.className = 'badge badge-needed';
          badge.textContent = '‚ö†Ô∏è Required';
          field.classList.add('needed');
        } else if (isGuessed) {
          badge.className = 'badge badge-guessed';
          badge.textContent = '‚ö†Ô∏è Please Confirm';
          field.classList.add('guessed');
        } else if (value.length > 20) {
          badge.className = 'badge badge-complete';
          badge.textContent = '‚úì Complete';
          field.classList.remove('guessed', 'needed');
        } else {
          badge.className = 'badge badge-needed';
          badge.textContent = '‚ö†Ô∏è Too Short';
          field.classList.add('needed');
        }
      });
    }
    
    // ========== EVENT LISTENERS ==========
    
    // Character counters for all textareas
    Object.keys(formFields).forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        field.addEventListener('input', () => {
          updateCharCount(fieldId);
          updateProgress();
          
          // Update badge on input
          const badge = document.getElementById(`${fieldId}Badge`);
          if (badge) {
            const value = field.value.trim();
            
            if (value.length === 0) {
              badge.className = 'badge badge-needed';
              badge.textContent = '‚ö†Ô∏è Required';
              field.classList.add('needed');
            } else if (value.length < 20) {
              badge.className = 'badge badge-guessed';
              badge.textContent = '‚ö†Ô∏è Too Short (min 20)';
              field.classList.add('guessed');
            } else {
              badge.className = 'badge badge-complete';
              badge.textContent = '‚úì Complete';
              field.classList.remove('guessed', 'needed');
            }
          }
          
          if (field.style.borderColor === 'rgb(220, 53, 69)') {
            field.style.borderColor = '';
          }
        });
      }
    });
    
    // AI Suggestion buttons
    document.querySelectorAll('.ai-suggest-btn').forEach(button => {
      button.addEventListener('click', () => {
        const fieldId = button.dataset.field;
        handleAISuggestion(fieldId);
      });
    });
    
    // Form submission
    document.getElementById('businessCaseForm').addEventListener('submit', submitForm);
    
    // Regenerate button
    document.getElementById('regenerateBtn')?.addEventListener('click', regenerateBusinessCase);
    
    // ========== INITIALIZE ON PAGE LOAD ==========
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ Business Case Form Initializing...');
      
      // Load business data from localStorage/Auth0
      await loadBusinessData();
      
      // Initialize character counts
      Object.keys(formFields).forEach(fieldId => {
        updateCharCount(fieldId);
      });

      updateAllBadges();
      
      console.log('‚úÖ Business Case Form Initialized');
      console.log('üìä User:', userEmail);
      console.log('üìä Business ID:', businessId);
      console.log('üìä Current Phase:', currentPhase);
      console.log('üìä Business Case:', businessCaseData);
    });
  </script>
  
</body>
</html>