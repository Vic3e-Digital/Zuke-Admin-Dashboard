<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Lead Generation | Zuke</title>
  <link rel="stylesheet" href="/css/formStyle.css">
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Hanken Grotesk', -apple-system, sans-serif;
      padding: 20px;
      background: #f8f9fa;
    }
    .container { max-width: 600px; margin: 0 auto; }
    
    .section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #2c3e50;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    .required {
      color: #ff6b6b;
      margin-left: 4px;
    }
    
    textarea, input[type="text"], input[type="email"], select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }
    
    input[type="text"], input[type="email"], select {
      min-height: auto;
    }
    
    input:read-only {
      background: #f5f5f5;
      color: #666;
    }
    
    .field-note {
      font-size: 13px;
      color: #666;
      margin-top: 6px;
      font-style: italic;
    }
    
    .prefilled-badge {
      display: inline-block;
      background: #d1fae5;
      color: #065f46;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
    
    .info-badge {
      display: inline-block;
      background: #e0e7ff;
      color: #4f46e5;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
    
    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }
    
    .collapsible-header:hover {
      background: #f0f1f2;
      border-color: var(--primary-orange, #ff6b35);
    }
    
    .collapsible-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }
    
    .collapsible-number {
      width: 28px;
      height: 28px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: #666;
    }
    
    .collapsible-arrow {
      transition: transform 0.2s ease;
      color: #666;
    }
    
    .collapsible-arrow.open {
      transform: rotate(180deg);
    }
    
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .collapsible-content.open {
      max-height: 1000px;
    }
    
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .cost {
      background: #fff3cd;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 600;
    }
    
    .generate-btn {
      width: 100%;
      padding: 15px;
      background: var(--primary-orange, linear-gradient(135deg, #ff6b35 0%, #ff9500 100%));
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .generate-btn:hover:not(:disabled) { opacity: 0.9; }
    
    .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .status {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      display: none;
      white-space: pre-wrap;
      animation: slideIn 0.3s ease;
    }
    
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    .status.loading { background: #e7f3ff; color: #004085; }
    
    .progress {
      display: none;
      margin-top: 15px;
      text-align: center;
    }
    
    .progress-text {
      color: var(--primary-orange, #ff6b35);
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--primary-orange, linear-gradient(90deg, #ff6b35, #ff9500));
      width: 0%;
      transition: width 0.3s ease;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .suggestion-card {
      background: linear-gradient(135deg, rgba(255, 107, 53, 0.08) 0%, rgba(255, 149, 0, 0.08) 100%);
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
    }
    
    .suggestion-card:hover {
      border-color: var(--primary-orange, #ff6b35);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
    }
    
    .suggestion-card.selected {
      border-color: var(--primary-orange, #ff6b35);
      background: linear-gradient(135deg, rgba(255, 107, 53, 0.15) 0%, rgba(255, 149, 0, 0.15) 100%);
    }
    
    .suggestion-card::before {
      content: 'âœ¨';
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 20px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .suggestion-card:hover::before {
      opacity: 1;
    }
    
    .suggestion-title {
      font-weight: 700;
      font-size: 15px;
      color: #2c3e50;
      margin-bottom: 8px;
      line-height: 1.3;
    }
    
    .suggestion-preview {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
    }
    
    .suggestion-badge {
      display: inline-block;
      background: var(--primary-orange, #ff6b35);
      color: white;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      margin-top: 8px;
      font-weight: 600;
    }
    
    .suggestion-card.selected .suggestion-badge {
      background: #10b981;
    }
    
    .suggestion-card.selected .suggestion-badge::before {
      content: 'âœ“ ';
    }

    .example-box {
      background: #f8f9fa;
      border-left: 4px solid var(--primary-orange, #ff6b35);
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 13px;
      color: #666;
    }

    .example-box strong {
      display: block;
      color: #333;
      margin-bottom: 8px;
    }

    .example-box p {
      margin: 4px 0;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- AI SUGGESTIONS -->
    <div class="section" id="suggestionsSection" style="display: none;">
      <div class="section-title">
        ðŸ’¡ AI Target Audience Suggestions for <span id="businessNameInline">Your Business</span>
      </div>
      
      
    </div>

    <form id="leadGenForm">

      <div style="text-align: center; margin-bottom: 24px;">
        <button type="button" id="generateSuggestionsBtn" style="padding: 10px 20px; background: var(--primary-orange, #ff6b35); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px;">
          <span id="btnText">âœ¨ Generate AI Suggestions</span>
          <span id="btnSpinner" style="display: none;"><span class="spinner"></span></span>
          <span style="background: rgba(255, 255, 255, 0.2); padding: 2px 8px; border-radius: 4px; font-size: 12px;">R2.00</span>
        </button>
      </div>
      
      <div id="suggestionsLoading" style="display: none; text-align: center; padding: 20px; color: #666;">
        <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-orange, #ff6b35); border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 10px;">Generating personalized suggestions...</p>
      </div>
      
      <div id="suggestionsContent" style="display: none; margin-bottom: 24px;">
        <div id="suggestionCards">
          <!-- Cards injected here -->
        </div>
        <button type="button" id="refreshSuggestionsBtn" style="padding: 8px 16px; background: var(--primary-orange, #ff6b35); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; margin-top: 12px;">
          ðŸ”„ Get New Suggestions
        </button>
      </div>
      
      <div id="suggestionsError" style="display: none; color: #d9534f; padding: 12px; background: #f8d7da; border-radius: 6px; margin-top: 12px; margin-bottom: 24px;"></div>
      
      <!-- Collapsible Section 1: Your Information -->
      <div class="collapsible-header" onclick="toggleCollapsible('userInfo')">
        <div class="collapsible-title">
          <div class="collapsible-number">1</div>
          <span>Your Information</span>
        </div>
        <svg class="collapsible-arrow" id="userInfoArrow" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </div>
      <div class="collapsible-content" id="userInfo">
        <div class="section">

        <div class="form-group">
          <label>
            Your Name <span class="required">*</span>
            <span class="prefilled-badge" id="userNameBadge" style="display: none;">Auto-filled</span>
          </label>
          <input type="text" id="userName" name="userName" readonly required>
        </div>

        <div class="form-group">
          <label>
            Your Email <span class="required">*</span>
            <span class="prefilled-badge" id="userEmailBadge" style="display: none;">Auto-filled</span>
          </label>
          <input type="email" id="userEmail" name="userEmail" readonly required>
          <p class="field-note">Results will be sent here</p>
        </div>
        </div>
      </div>

      <!-- Collapsible Section 2: Business Information -->
      <div class="collapsible-header" onclick="toggleCollapsible('businessInfo')">
        <div class="collapsible-title">
          <div class="collapsible-number">2</div>
          <span>Business Information</span>
        </div>
        <svg class="collapsible-arrow" id="businessInfoArrow" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </div>
      <div class="collapsible-content" id="businessInfo">
        <div class="section">

        <div class="form-group">
          <label>
            Business Name <span class="required">*</span>
            <span class="prefilled-badge" id="businessNameBadge" style="display: none;">Auto-filled</span>
          </label>
          <input type="text" id="businessName" name="businessName" readonly required>
        </div>

        <div class="form-group">
          <label>
            Business Description <span class="required">*</span>
            <span class="prefilled-badge" id="businessCaseBadge" style="display: none;">Auto-filled</span>
          </label>
          <textarea id="businessCase" name="businessCase" required></textarea>
          <p class="field-note">What your business does and who you serve</p>
        </div>
        </div>
      </div>

      <!-- 3. Target Audience -->
      <div class="section">
        <div class="section-title">3. Target Audience</div>

        <div class="form-group">
          <label>Target Role/Position <span class="required">*</span></label>
          <input type="text" id="targetRole" name="targetRole" placeholder="CEO" required>
          <p class="field-note">Primary job title to target (one role works best)</p>
        </div>

        <div class="form-group">
          <label>Target Country <span class="required">*</span></label>
          <select id="targetCountry" name="targetCountry" required>
            <option value="">Select a country...</option>
            <option value="South Africa" selected>South Africa</option>
            <option value="Nigeria">Nigeria</option>
            <option value="United Kingdom">United Kingdom</option>
            <option value="United States">United States</option>
          </select>
        </div>

        <div class="form-group">
          <label>Target City <span class="info-badge">Optional</span></label>
          <input type="text" id="targetCity" name="targetCity" placeholder="e.g., Cape Town, Lagos, London">
          <p class="field-note">Specific city to narrow down your search</p>
        </div>

        <div class="form-group">
          <label>Search Variants <span class="required">*</span></label>
          <select id="variants" name="variants" required>
            <option value="1">1x - Single Run (R50.00)</option>
            <option value="2">2x - Double Run (R100.00)</option>
            <option value="3" selected>3x - Triple Run (R150.00)</option>
          </select>
          <p class="field-note">Multiple runs with similar searches increase lead coverage. Price scales with runs.</p>
        </div>

        <div class="form-group">
          <label>
            Additional Context <span class="info-badge">Optional</span>
          </label>
          <textarea id="context" name="context" placeholder="E.g., Looking for Series A-C funded startups..." rows="3"></textarea>
          <p class="field-note">
            Funding stage, company size, specific challenges, etc.
            <svg id="exampleInfoIcon" style="width: 16px; height: 16px; display: inline-block; margin-left: 6px; cursor: pointer; vertical-align: middle;" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
          </p>
        </div>

        <div class="form-group">
          <label>
            Product/Service <span class="info-badge">Optional</span>
          </label>
          <select id="productService" name="productService">
            <option value="">Select a product or service...</option>
            <option value="" disabled id="loadingOption" style="display: none;">Loading...</option>
          </select>
          <p class="field-note">Choose which product/service to focus leads on</p>
        </div>

        <div id="exampleTooltip" style="display: none; background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-top: 12px; font-size: 13px; color: #666; animation: slideIn 0.3s ease;">
          <strong style="color: #333; display: block; margin-bottom: 10px;">ðŸ’¡ Example Use Cases:</strong>
          <p style="margin: 6px 0; line-height: 1.6;"><strong>B2B Sales:</strong> "Looking for enterprise clients for our SaaS platform"</p>
          <p style="margin: 6px 0; line-height: 1.6;"><strong>Coaching:</strong> "Seeking C-suite executives for leadership coaching"</p>
          <p style="margin: 6px 0; line-height: 1.6;"><strong>Partnerships:</strong> "Exploring partnerships with fintech companies"</p>
        </div>
      </div>

      <!-- 3. Target Audience -->
      <div class="section">
        <div class="section-title">4. Advanced Options</div>

        <div class="form-group">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="autoEnrich" name="autoEnrich" style="width: auto; margin-right: 10px; cursor: pointer;">
            <span>Automatically enrich leads with additional data</span>
          </label>
          <p class="field-note">Get phone numbers, company size, and other details automatically</p>
        </div>

        <div class="form-group">
          <label style="display: flex; align-items: center; cursor: not-allowed; opacity: 0.6;">
            <input type="checkbox" id="autoEmail" name="autoEmail" disabled style="width: auto; margin-right: 10px; cursor: not-allowed;">
            <span>Automatically send outreach emails <span style="background: #fbbf24; color: #78350f; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-left: 8px;">COMING SOON</span></span>
          </label>
          <p class="field-note">AI-powered personalized emails will be sent to qualified leads</p>
        </div>
      </div>

      <!-- Cost Display -->
      <div class="cost" id="costDisplay">
        Lead Generation Cost: R150.00
      </div>

      <!-- Submit Button -->
      <button type="submit" class="generate-btn" id="submitBtn" disabled>
        âœ¨ Generate Leads
      </button>

      <!-- Progress -->
      <div class="progress" id="progress">
        <p class="progress-text" id="progressText">Processing...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>

      <!-- Status -->
      <div class="status" id="status"></div>
    </form>
  </div>

  <script src="/js/dataManager.js"></script>

  <script>
    // ========== GLOBAL VARIABLES ==========
    let auth0Client = null;
    let currentBusiness = null;
    let currentUser = null;
    let openAIConfig = null;

    const WEBHOOK_URL = '/api/lead-generation/generate';
    const BASE_LEAD_GEN_COST = 50; // R50 per variant

    const form = document.getElementById('leadGenForm');
    const submitBtn = document.getElementById('submitBtn');
    const status = document.getElementById('status');
    const progress = document.getElementById('progress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    // ========== AUTH0 CLIENT ==========
    async function getAuth0Client() {
      if (window.auth0Client) return window.auth0Client;
      
      try {
        const response = await fetch("/auth_config.json");
        const config = await response.json();
        auth0Client = await auth0.createAuth0Client({
          domain: config.domain,
          clientId: config.clientId,
          cacheLocation: 'localstorage',
          useRefreshTokens: true
        });
        window.auth0Client = auth0Client;
        return auth0Client;
      } catch (error) {
        console.error("Error configuring Auth0:", error);
        return null;
      }
    }

    // ========== FETCH OPENAI CONFIG ==========
    async function getOpenAIConfig() {
      if (openAIConfig) return openAIConfig;
      
      try {
        const response = await fetch('/api/get-openai-config');
        if (!response.ok) throw new Error('Failed to get OpenAI config');
        openAIConfig = await response.json();
        return openAIConfig;
      } catch (error) {
        console.error('Error fetching OpenAI config:', error);
        return null;
      }
    }

    // ========== CALL AZURE OPENAI ==========
    async function callAzureOpenAI(prompt) {
      const config = await getOpenAIConfig();
      if (!config) throw new Error('OpenAI config not available');

      const url = `${config.endpoint}openai/deployments/${config.deployment}/chat/completions?api-version=2025-01-01-preview`;

      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'api-key': config.apiKey
        },
        body: JSON.stringify({
          messages: [
            {
              role: "system",
              content: "You are an expert B2B lead generation strategist. You MUST respond with valid JSON only. Generate exactly 3 specific target audience suggestions for LinkedIn lead generation. Return a JSON object with a 'suggestions' array containing 3 objects with 'title', 'targetRole', 'country', and 'context' fields."
            },
            {
              role: "user",
              content: prompt
            }
          ],
          max_tokens: 1000,
          temperature: 0.8,
          top_p: 0.95,
          response_format: { type: "json_object" }
        })
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Azure OpenAI error:', errorText);
        throw new Error(`OpenAI API error: ${response.status}`);
      }

      const data = await response.json();
      return data.choices[0].message.content;
    }

    // ========== FETCH AI SUGGESTIONS ==========
    async function fetchSuggestions() {
      const loadingDiv = document.getElementById('suggestionsLoading');
      const contentDiv = document.getElementById('suggestionsContent');
      const errorDiv = document.getElementById('suggestionsError');
      const cardsContainer = document.getElementById('suggestionCards');

      loadingDiv.style.display = 'block';
      contentDiv.style.display = 'none';
      errorDiv.style.display = 'none';

      try {
        const businessCase = currentBusiness?.initial_business_case || {};
        const storeName = currentBusiness?.store_info?.name || 'Your Business';
        const storeDescription = currentBusiness?.store_info?.description || '';
        
        const businessInfo = `
Business Name: ${storeName}
Description: ${storeDescription}
What We Do: ${businessCase.whatYouDo || 'Not specified'}
Target Audience: ${businessCase.targetAudience || 'Not specified'}
Unique Value: ${businessCase.uniqueValue || 'Not specified'}
Goals: ${businessCase.goals || 'Not specified'}
        `.trim();

        const prompt = `Based on this business information:

${businessInfo}

Generate exactly 3 creative and specific target audience suggestions for LinkedIn lead generation.

Each suggestion should include:
- A catchy title describing the target segment
- ONE primary job role/title to target (NOT multiple roles)
- Recommended country/location from: South Africa, Nigeria, United Kingdom, United States
- Detailed context explaining why this audience is valuable

IMPORTANT: 
- Use only ONE specific job title per suggestion (e.g., "CEO" not "CEO, CTO, Founder")
- Choose countries ONLY from: South Africa, Nigeria, United Kingdom, United States
- Vary the countries across the 3 suggestions

Return ONLY valid JSON in this exact format:
{
  "suggestions": [
    {
      "title": "Segment Name",
      "targetRole": "Single primary job title",
      "country": "South Africa",
      "context": "2-3 sentences explaining why this audience is valuable and how your business can help them."
    }
  ]
}`;

        console.log('ðŸ¤– Calling Azure OpenAI...');
        const response = await callAzureOpenAI(prompt);
        
        let data;
        try {
          data = JSON.parse(response);
        } catch (e) {
          const jsonMatch = response.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            data = JSON.parse(jsonMatch[0]);
          } else {
            throw new Error('Invalid JSON response from AI');
          }
        }

        const suggestions = data.suggestions || [];
        
        if (suggestions.length === 0) {
          throw new Error('No suggestions generated');
        }

        cardsContainer.innerHTML = '';

        suggestions.forEach((suggestion) => {
          const card = document.createElement('div');
          card.className = 'suggestion-card';
          
          card.innerHTML = `
            <div class="suggestion-title">${suggestion.title}</div>
            <div class="suggestion-preview">
              <strong>Target Role:</strong> ${suggestion.targetRole}<br>
              <strong>Location:</strong> ${suggestion.country}<br><br>
              ${suggestion.context}
            </div>
            <span class="suggestion-badge">Click to use</span>
          `;
          
          card.addEventListener('click', () => {
            document.querySelectorAll('.suggestion-card').forEach(c => 
              c.classList.remove('selected')
            );
            
            card.classList.add('selected');
            
            document.getElementById('targetRole').value = suggestion.targetRole;
            document.getElementById('targetCountry').value = suggestion.country;
            document.getElementById('context').value = suggestion.context;
            
            // Update submit button state
            updateSubmitButton();
            
            document.getElementById('targetRole').scrollIntoView({ 
              behavior: 'smooth', 
              block: 'center' 
            });
            
            showStatus('âœ… Target audience applied!', 'info');
            setTimeout(() => {
              status.style.display = 'none';
            }, 3000);
          });
          
          cardsContainer.appendChild(card);
        });
        
        loadingDiv.style.display = 'none';
        contentDiv.style.display = 'block';

      } catch (error) {
        console.error('Error fetching suggestions:', error);
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
        errorDiv.textContent = `âš ï¸ Failed to generate suggestions: ${error.message}`;
      }
    }

    // ========== LOAD USER AND BUSINESS INFO ==========
    async function loadUserAndBusinessInfo() {
      try {
        const auth0 = await getAuth0Client();
        if (!auth0) return;

        const isAuthenticated = await auth0.isAuthenticated();
        if (!isAuthenticated) {
          showStatus('âš ï¸ Please log in to use this feature', 'error');
          return;
        }

        currentUser = await auth0.getUser();
        console.log('ðŸ‘¤ Current user:', currentUser);

        if (currentUser) {
          if (currentUser.name) {
            document.getElementById('userName').value = currentUser.name;
            document.getElementById('userNameBadge').style.display = 'inline-block';
          }

          if (currentUser.email) {
            document.getElementById('userEmail').value = currentUser.email;
            document.getElementById('userEmailBadge').style.display = 'inline-block';
          }
        }

        currentBusiness = window.dataManager?.getSelectedBusinessOrFirst();
        console.log('ðŸ¢ Current business:', currentBusiness);

        if (!currentBusiness) {
          showStatus('âš ï¸ No business selected. Please set up your business first.', 'error');
          submitBtn.disabled = true;
          return;
        }

        const businessName = currentBusiness?.store_info?.name || currentBusiness?.name || 'Your Business';
        document.getElementById('businessNameInline').textContent = businessName;

        if (businessName) {
          document.getElementById('businessName').value = businessName;
          document.getElementById('businessNameBadge').style.display = 'inline-block';
        }

        let businessDescription = '';
        
        console.log('ðŸ“‹ Full business object:', currentBusiness);
        console.log('ðŸ“‹ initial_business_case details:', JSON.stringify(currentBusiness.initial_business_case, null, 2));
        console.log('ðŸ“‹ store_info details:', JSON.stringify(currentBusiness.store_info, null, 2));
        
        // Try multiple sources for business description
        if (currentBusiness.initial_business_case) {
          const bc = currentBusiness.initial_business_case;
          console.log('ðŸ” Checking business case fields:', {
            business_name: bc.business_name,
            what_you_do: bc.what_you_do,
            your_customers: bc.your_customers,
            your_solution: bc.your_solution,
            growth_goals: bc.growth_goals
          });
          
          const parts = [];
          
          // Use underscore field names
          if (bc.business_name) parts.push(`Business: ${bc.business_name}`);
          if (bc.what_you_do) parts.push(`What we do: ${bc.what_you_do}`);
          if (bc.your_customers) parts.push(`Target audience: ${bc.your_customers}`);
          if (bc.your_solution) parts.push(`Our solution: ${bc.your_solution}`);
          if (bc.why_people_will_choose_you) parts.push(`Unique value: ${bc.why_people_will_choose_you}`);
          if (bc.growth_goals) parts.push(`Goals: ${bc.growth_goals}`);
          
          businessDescription = parts.join('. ');
          console.log('âœ… Business description from initial_business_case:', businessDescription);
        }
        
        // Fallback to store_info description
        if (!businessDescription && currentBusiness.store_info?.description) {
          businessDescription = currentBusiness.store_info.description;
          console.log('âœ… Business description from store_info:', businessDescription);
        }
        
        // Fallback to direct description field
        if (!businessDescription && currentBusiness.description) {
          businessDescription = currentBusiness.description;
          console.log('âœ… Business description from direct field:', businessDescription);
        }

        if (businessDescription) {
          document.getElementById('businessCase').value = businessDescription;
          document.getElementById('businessCaseBadge').style.display = 'inline-block';
          console.log('âœ… Business description set in form');
        } else {
          console.warn('âš ï¸ No business description found in any field');
        }

        document.getElementById('suggestionsSection').style.display = 'block';
        
        // Load products/services
        await loadProductsServices();
        
        console.log('âœ… User and business info loaded');

      } catch (error) {
        console.error('Error loading business:', error);
        showStatus('âš ï¸ Error loading business information.', 'error');
      }
    }

    // ========== LOAD PRODUCTS/SERVICES ==========
    async function loadProductsServices() {
      try {
        if (!currentBusiness?._id) return;

        const dropdown = document.getElementById('productService');
        const loadingOption = document.getElementById('loadingOption');
        
        loadingOption.style.display = 'block';
        loadingOption.textContent = 'Loading products & services...';

        const response = await fetch(`/api/products/get-products-services?businessId=${currentBusiness._id}`);
        
        if (!response.ok) {
          throw new Error('Failed to fetch products/services');
        }

        const data = await response.json();
        
        loadingOption.style.display = 'none';

        if (data.success && data.items && data.items.length > 0) {
          data.items.forEach(item => {
            const option = document.createElement('option');
            option.value = JSON.stringify({ id: item.id, name: item.name, type: item.type });
            option.textContent = `${item.name} (${item.type})`;
            dropdown.appendChild(option);
          });
          
          console.log(`âœ… Loaded ${data.items.length} products/services`);
        } else {
          const noItemsOption = document.createElement('option');
          noItemsOption.value = '';
          noItemsOption.textContent = 'No products or services found';
          noItemsOption.disabled = true;
          dropdown.appendChild(noItemsOption);
        }

      } catch (error) {
        console.error('Error loading products/services:', error);
        const errorOption = document.createElement('option');
        errorOption.value = '';
        errorOption.textContent = 'Error loading items';
        errorOption.disabled = true;
        document.getElementById('productService').appendChild(errorOption);
      }
    }

    // ========== FORM SUBMISSION ==========
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Parse product/service if selected
      let selectedProductService = null;
      const productServiceValue = document.getElementById('productService')?.value;
      if (productServiceValue) {
        try {
          selectedProductService = JSON.parse(productServiceValue);
        } catch (e) {
          console.warn('Could not parse product/service selection');
        }
      }

      const data = {
        name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value,
        business: document.getElementById('businessName').value,
        businessId: currentBusiness?._id || `biz-${Date.now()}`,
        businessCase: document.getElementById('businessCase').value,
        targetRole: document.getElementById('targetRole').value,
        country: document.getElementById('targetCountry').value,
        city: document.getElementById('targetCity')?.value || '',
        variants: document.getElementById('variants').value,
        context: document.getElementById('context').value || '',
        autoEnrich: document.getElementById('autoEnrich')?.checked || false,
        productService: selectedProductService
      };

      console.log('ðŸ“‹ Form data:', data);

      if (!data.name || !data.email || !data.business || !data.businessCase || !data.targetRole || !data.country) {
        showStatus('âŒ Please fill in all required fields', 'error');
        return;
      }

      submitBtn.disabled = true;
      progress.style.display = 'block';
      status.style.display = 'none';
      progressFill.style.width = '10%';

      try {
        // Calculate cost based on variants
        const totalCost = BASE_LEAD_GEN_COST * parseInt(data.variants);

        // âœ… STEP 1: Deduct from wallet
        progressText.textContent = 'Checking wallet balance...';
        progressFill.style.width = '30%';

        const walletResponse = await fetch('/api/wallet/deduct', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: data.email,
            amount: totalCost,
            description: `LinkedIn lead generation for ${data.targetRole} in ${data.country}`,
            metadata: {
              feature: 'lead-generation',
              action: 'generate-leads',
              businessId: data.businessId,
              targetRole: data.targetRole,
              country: data.country
            }
          })
        });

        if (!walletResponse.ok) {
          const walletError = await walletResponse.json();
          
          if (walletResponse.status === 402) {
            throw new Error(
              `Insufficient funds!\n\n` +
              `Required: ${walletError.formatted_required || `R${totalCost.toFixed(2)}`}\n` +
              `Balance: ${walletError.formatted_balance}\n\n` +
              `Please add credits or upgrade your plan.`
            );
          }
          
          throw new Error(walletError.error || 'Wallet check failed');
        }

        const walletResult = await walletResponse.json();
        console.log('âœ… Wallet deducted:', walletResult);

        // âœ… STEP 2: Call n8n webhook with POST
        progressText.textContent = 'Generating leads...';
        progressFill.style.width = '60%';

        console.log('ðŸ“¤ Sending to n8n with POST:', WEBHOOK_URL);

        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('n8n error:', errorText);
          throw new Error(`Webhook error: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        console.log('âœ… Response:', result);

        progressFill.style.width = '100%';

        showStatus(
          `âœ… Success! Lead generation completed.\n\n` +
          `ðŸ“Š Total Leads: ${result.data?.totalLeads || 'N/A'}\n` +
          `â­ High-Quality Leads: ${result.data?.highScoringLeads || 'N/A'}\n` +
          `ðŸ“ˆ Average Score: ${result.data?.averageScore || 'N/A'}/10\n\n` +
          `ðŸ”„ Variants Run: ${data.variants}x\n` +
          `ðŸ’° Cost: R${totalCost.toFixed(2)}\n` +
          `ðŸ’³ New Balance: ${walletResult.formatted_balance}\n\n` +
          `ðŸ“§ Detailed report sent to ${data.email}` +
          (result.data?.spreadsheetUrl ? `\n\nðŸ”— View Results: ${result.data.spreadsheetUrl}` : ''),
          'success'
        );

        setTimeout(() => {
          document.getElementById('targetRole').value = '';
          document.getElementById('context').value = '';
          document.getElementById('targetCountry').value = 'South Africa';
          document.getElementById('variants').value = '3';
          
          document.querySelectorAll('.suggestion-card').forEach(c => 
            c.classList.remove('selected')
          );
          
          submitBtn.disabled = false;
        }, 10000);

      } catch (error) {
        console.error('âŒ Error:', error);
        
        if (error.message.includes('Insufficient funds')) {
          showStatus(
            'âŒ Insufficient Funds\n\n' +
            'Please add credits or upgrade your plan to continue.',
            'error'
          );
        } else {
          showStatus(`âŒ Error: ${error.message}`, 'error');
        }
        
        submitBtn.disabled = false;
      } finally {
        progress.style.display = 'none';
      }
    });

    // ========== SHOW STATUS ==========
    function showStatus(message, type) {
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';
      
      // Don't auto-hide success messages, let them stay visible
      if (type === 'error') {
        setTimeout(() => {
          status.style.display = 'none';
        }, 15000);
      }
    }

    // ========== ENABLE/DISABLE SUBMIT ==========
    function updateSubmitButton() {
      const targetRole = document.getElementById('targetRole').value.trim();
      const targetCountry = document.getElementById('targetCountry').value;
      submitBtn.disabled = !(targetRole && targetCountry);
    }

    document.getElementById('targetRole').addEventListener('input', updateSubmitButton);
    document.getElementById('targetCountry').addEventListener('change', updateSubmitButton);

    // Update cost display when variants change
    document.getElementById('variants').addEventListener('change', (e) => {
      const variants = parseInt(e.target.value);
      const totalCost = BASE_LEAD_GEN_COST * variants;
      document.getElementById('costDisplay').textContent = `Lead Generation Cost: R${totalCost.toFixed(2)}`;
    });

    // ========== EVENT LISTENERS ==========
    document.getElementById('exampleInfoIcon')?.addEventListener('click', () => {
      const tooltip = document.getElementById('exampleTooltip');
      if (tooltip) {
        tooltip.style.display = tooltip.style.display === 'none' ? 'block' : 'none';
      }
    });

    document.getElementById('generateSuggestionsBtn').addEventListener('click', async () => {
      // Deduct R2 for AI suggestions
      const btn = document.getElementById('generateSuggestionsBtn');
      const btnText = document.getElementById('btnText');
      const btnSpinner = document.getElementById('btnSpinner');
      
      btn.disabled = true;
      btnText.style.display = 'none';
      btnSpinner.style.display = 'inline-block';
      
      try {
        const walletResponse = await fetch('/api/wallet/deduct', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: currentUser?.email,
            amount: 2,
            description: 'AI Lead Suggestions Generation',
            metadata: {
              feature: 'lead_generation',
              action: 'ai_suggestions',
              businessId: currentBusiness?._id
            }
          })
        });

        if (!walletResponse.ok) {
          const walletError = await walletResponse.json();
          if (walletResponse.status === 400 && walletError.error === 'Insufficient funds') {
            showStatus(`âŒ Insufficient funds! Please add credits to generate AI suggestions.\n\nRequired: R2.00\nBalance: R${(walletError.current_balance || 0).toFixed(2)}`, 'error');
            return;
          }
          throw new Error(walletError.error || 'Payment failed');
        }

        await fetchSuggestions();
      } catch (error) {
        console.error('Error:', error);
        showStatus(`âŒ ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btnText.style.display = 'inline';
        btnSpinner.style.display = 'none';
      }
    });
    
    document.getElementById('refreshSuggestionsBtn')?.addEventListener('click', async () => {
      const btn = document.getElementById('refreshSuggestionsBtn');
      btn.disabled = true;
      
      try {
        const walletResponse = await fetch('/api/wallet/deduct', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: currentUser?.email,
            amount: 2,
            description: 'AI Lead Suggestions Refresh',
            metadata: {
              feature: 'lead_generation',
              action: 'ai_suggestions_refresh',
              businessId: currentBusiness?._id
            }
          })
        });

        if (!walletResponse.ok) {
          const walletError = await walletResponse.json();
          if (walletResponse.status === 400 && walletError.error === 'Insufficient funds') {
            showStatus(`âŒ Insufficient funds! Please add credits to refresh suggestions.\n\nRequired: R2.00\nBalance: R${(walletError.current_balance || 0).toFixed(2)}`, 'error');
            return;
          }
          throw new Error(walletError.error || 'Payment failed');
        }

        await fetchSuggestions();
      } catch (error) {
        console.error('Error:', error);
        showStatus(`âŒ ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    });

    // ========== INITIALIZE ==========
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('ðŸš€ Initializing...');
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'â³ Loading...';
      
      try {
        await loadUserAndBusinessInfo();
        
        if (currentBusiness) {
          submitBtn.textContent = 'âœ¨ Generate Leads';
          updateSubmitButton();
        }
      } catch (error) {
        console.error('âŒ Init error:', error);
        showStatus('âŒ Failed to load. Please refresh.', 'error');
      }
    });

    // ========== COLLAPSIBLE SECTIONS ==========
    function toggleCollapsible(sectionId) {
      const content = document.getElementById(sectionId);
      const arrow = document.getElementById(sectionId + 'Arrow');
      
      if (content.classList.contains('open')) {
        content.classList.remove('open');
        arrow.classList.remove('open');
      } else {
        content.classList.add('open');
        arrow.classList.add('open');
      }
    }

    // ========== LISTEN FOR BUSINESS CHANGES ==========
    if (window.dataManager) {
      window.dataManager.onBusinessChange((business) => {
        console.log('ðŸ”„ Business changed');
        currentBusiness = business;
        loadUserAndBusinessInfo();
      });
    }
    
  </script>
</body>
</html>
