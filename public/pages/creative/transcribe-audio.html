<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Transcriber with Diarization | Zuke</title>
  <link rel="stylesheet" href="../../css/formStyle.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <style>
    /* Additional Audio Transcriber Styles */
    .audio-container {
      display: flex;
      gap: 20px;
    }

    .audio-upload-section, .transcription-section {
      flex: 1;
      min-width: 300px;
    }

    .audio-upload-box {
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      background: var(--light-bg);
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .audio-upload-box:hover {
      border-color: var(--primary-orange);
      background: #FFF8F0;
    }

    .audio-upload-box.has-audio {
      border-color: var(--primary-orange);
      background: #FFF8F0;
    }

    .audio-upload-icon {
      font-size: 32px;
      margin-bottom: 10px;
      opacity: 0.6;
    }

    .audio-player {
      width: 100%;
      margin-top: 15px;
      margin-bottom: 10px;
    }

    .remove-audio-btn {
      background: #DC3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 10px;
      display: none;
    }

    .remove-audio-btn:hover {
      background: #c82333;
    }

    .transcription-preview {
      background: var(--light-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.6;
      color: #333;
    }

    .preview-header {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
    }

    .speaker-segment {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    .speaker-segment:last-child {
      border-bottom: none;
    }

    .speaker-label {
      font-weight: 600;
      color: var(--primary-orange);
      margin-bottom: 4px;
      font-size: 12px;
    }

    .segment-text {
      color: #555;
      margin-left: 10px;
    }

    .progress-section {
      margin-top: 20px;
      padding: 15px;
      background: var(--light-bg);
      border-radius: 8px;
      display: none;
    }

    .progress-bar-container {
      background: #e0e0e0;
      border-radius: 4px;
      height: 8px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      background: var(--primary-orange);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 12px;
      color: #666;
      text-align: center;
    }

    .email-delivery-section {
      background: #f9f9f9;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      display: none;
    }

    .email-delivery-section.show {
      display: block;
    }

    .email-checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      cursor: pointer;
    }

    .email-checkbox-label input[type="checkbox"] {
      cursor: pointer;
    }

    .email-input-section {
      margin-top: 12px;
      display: none;
    }

    .email-input-section.show {
      display: block;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .action-button {
      flex: 1;
      min-width: 150px;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .transcribe-btn {
      background: var(--primary-orange);
      color: white;
    }

    .transcribe-btn:hover:not(:disabled) {
      background: #ff9500;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
    }

    .transcribe-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .copy-btn {
      background: #6c757d;
      color: white;
    }

    .copy-btn:hover {
      background: #5a6268;
    }

    .download-btn {
      background: #28a745;
      color: white;
      position: relative;
    }

    .download-btn:hover {
      background: #218838;
    }

    .download-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      min-width: 150px;
      margin-top: 5px;
    }

    .download-dropdown.show {
      display: block;
    }

    .download-dropdown button {
      display: block;
      width: 100%;
      padding: 10px 15px;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      transition: background 0.2s;
    }

    .download-dropdown button:hover {
      background: #f5f5f5;
    }

    .download-dropdown button:first-child {
      border-radius: 4px 4px 0 0;
    }

    .download-dropdown button:last-child {
      border-radius: 0 0 4px 4px;
    }

    .clear-btn {
      background: #6c757d;
      color: white;
    }

    .clear-btn:hover {
      background: #5a6268;
    }

    .status {
      padding: 12px 15px;
      border-radius: 6px;
      margin-top: 15px;
      display: none;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .file-input {
      display: none;
    }

    .cost-display {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
    }

    .cost-highlight {
      font-weight: 600;
      color: var(--primary-orange);
    }

    @media (max-width: 768px) {
      .audio-container {
        flex-direction: column;
      }

      .audio-upload-section, .transcription-section {
        flex: none;
        width: 100%;
      }

      .button-group {
        flex-direction: column;
      }

      .action-button {
        min-width: auto;
      }

      .audio-file-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 15px;
}

.audio-file-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  background: white;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  font-size: 14px;
}

.audio-file-item .file-icon {
  font-size: 20px;
}

.audio-file-item .file-info {
  flex: 1;
}

.audio-file-item .file-name {
  font-weight: 500;
  color: var(--text-primary);
}

.audio-file-item .file-size {
  font-size: 12px;
  color: #666;
}

.audio-file-item .remove-file-btn {
  background: #dc3545;
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.audio-file-item .remove-file-btn:hover {
  background: #c82333;
}

.file-count-badge {
  display: inline-block;
  background: var(--primary-orange);
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  margin-left: 8px;
}

.transcription-file-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
  background: #f0f0f0;
  border-radius: 6px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: background 0.2s;
}

.transcription-file-header:hover {
  background: #e5e5e5;
}

.transcription-file-header .file-title {
  font-weight: 600;
  color: var(--text-primary);
}

.transcription-file-header .toggle-icon {
  font-size: 12px;
  color: #666;
}

.transcription-file-content {
  display: block;
  max-height: 300px;
  overflow-y: auto;
}

.transcription-file-content.collapsed {
  display: none;
}


    }
  </style>
</head>

<body>
    <div class="container">
      
      <!-- Header -->
      <div class="header">
        <h1>Audio Transcriber</h1>
        <p>Convert audio to text with speaker identification (diarization)</p>
      </div>

      <!-- Info Alert -->
      <div class="info-box" style="background: #e3f2fd; border: 1px solid #90caf9; padding: 12px 15px; border-radius: 6px; margin-bottom: 20px; font-size: 14px; color: #1565c0;">
        <strong>How it works:</strong> Upload an audio file (MP3, WAV, M4A, OGG). Our Azure OpenAI Whisper model will transcribe it with automatic speaker identification. You can preview the results and download in multiple formats.
      </div>

      <!-- Main Content -->
      <div class="audio-container">
        
        <!-- Upload Section -->
        <div class="audio-upload-section">
          <div class="section-title">Upload Audio</div>

          <div class="audio-upload-box" id="audioUploadBox">
            <div class="audio-upload-icon">üéôÔ∏è</div>
            <div style="font-weight: 500; color: var(--text-primary);">Drag & drop your audio file</div>
            <div style="font-size: 12px; color: #666; margin-top: 8px;">or click to select</div>
            <div style="font-size: 11px; color: #999; margin-top: 8px;">Supported: MP3, WAV, M4A, OGG (Max 25MB)</div>
          </div>

          <audio id="audioPlayer" class="audio-player" controls style="display: none;"></audio>
          <button id="removeAudioBtn" class="remove-audio-btn">Remove Audio</button>

          <div class="cost-display" style="margin-top: 20px;">
            <strong>Cost:</strong> <span class="cost-highlight">R15.00</span><br>
            <span style="font-size: 11px; color: #666;">Includes transcription + speaker identification</span>
          </div>
        </div>

        <!-- Transcription Section -->
        <div class="transcription-section">
          <div class="section-title">Transcription Preview</div>

          <div class="transcription-preview" id="transcriptionPreview">
            <div style="color: #999; text-align: center; padding: 20px;">
              Upload an audio file and click transcribe to see the preview here
            </div>
          </div>

          <!-- Progress Section -->
          <div class="progress-section" id="progressSection">
            <div class="progress-bar-container">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Initializing transcription...</div>
          </div>

          <!-- Action Buttons -->
          <div class="button-group" id="actionButtons">
            <button id="transcribeBtn" class="action-button transcribe-btn" disabled>
              Transcribe Audio
            </button>
            <button id="copyBtn" class="action-button copy-btn" style="display: none;">
              üìã Copy to Clipboard
            </button>
            <div style="position: relative; display: none;" id="downloadContainer">
              <button id="downloadBtn" class="action-button download-btn">
                üì• Download
              </button>
              <div id="downloadDropdown" class="download-dropdown">
                <button data-format="txt">üìÑ Plain Text (.txt)</button>
                <button data-format="json">üìã JSON (.json)</button>
              </div>
            </div>
            <button id="clearBtn" class="action-button clear-btn" style="display: none;">
              üóëÔ∏è Clear
            </button>
          </div>

          <!-- Status Messages -->
          <div id="transcriptionStatus" class="status"></div>
        </div>
      </div>

      <input type="file" id="fileInput" class="file-input" accept="audio/*">
    </div>

    <script>
  // ========== CONFIGURATION & STATE ==========
  const COSTS = {
    PER_FILE: 15.00,
    MAX_FILES: 4
  };

  const urlParams = new URLSearchParams(window.location.search);
  let userEmail = urlParams.get('email');
  let businessId = urlParams.get('businessId');
  let businessName = urlParams.get('businessName') || 'My Business';
  
  let auth0Client = null;
  let currentBusiness = null;
  let businessCase = {};
  
  let uploadedAudioFiles = []; // Changed to array
  let currentTranscriptions = null; // Changed to store multiple
  let isTranscribing = false;

  // ========== ELEMENT REFERENCES ==========
  const audioUploadBox = document.getElementById('audioUploadBox');
  const fileInput = document.getElementById('fileInput');
  const transcribeBtn = document.getElementById('transcribeBtn');
  const copyBtn = document.getElementById('copyBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const downloadContainer = document.getElementById('downloadContainer');
  const downloadDropdown = document.getElementById('downloadDropdown');
  const downloadFormatBtns = document.querySelectorAll('#downloadDropdown button');
  const clearBtn = document.getElementById('clearBtn');
  const transcriptionPreview = document.getElementById('transcriptionPreview');
  const progressSection = document.getElementById('progressSection');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const transcriptionStatus = document.getElementById('transcriptionStatus');

  // ========== AUTH0 & BUSINESS INFO (same as before) ==========
  async function getAuth0Client() {
    if (window.auth0Client) {
      console.log('‚úÖ Using global Auth0 client from app.js');
      return window.auth0Client;
    }
    
    if (window.parent && window.parent.auth0Client) {
      console.log('‚úÖ Using parent Auth0 client from app.js');
      return window.parent.auth0Client;
    }
    
    console.warn('‚ö†Ô∏è Global Auth0 client not available. Will use URL parameters for email.');
    return null;
  }

  async function loadBusinessInfo() {
    try {
      if (!businessId && window.parent && window.parent.dataManager) {
        try {
          currentBusiness = window.parent.dataManager.getSelectedBusinessOrFirst();
          if (currentBusiness) {
            businessId = currentBusiness._id;
            businessCase = currentBusiness.initial_business_case || {};
            console.log('‚úÖ Loaded business data from parent dataManager');
          }
        } catch (e) {
          console.warn('Could not access parent dataManager:', e);
        }
      }

      if (!businessId && window.dataManager) {
        try {
          currentBusiness = window.dataManager.getSelectedBusinessOrFirst();
          if (currentBusiness) {
            businessId = currentBusiness._id;
            businessCase = currentBusiness.initial_business_case || {};
            console.log('‚úÖ Loaded business data from own dataManager');
          }
        } catch (e) {
          console.warn('Could not access own dataManager:', e);
        }
      }

      if (!userEmail) {
        const auth0 = await getAuth0Client();
        if (auth0) {
          try {
            const isAuthenticated = await auth0.isAuthenticated();
            if (isAuthenticated) {
              const user = await auth0.getUser();
              if (user && user.email) {
                userEmail = user.email;
                console.log('‚úÖ Got user email from Auth0:', userEmail);
              }
            } else {
              console.warn('‚ö†Ô∏è User not authenticated in Auth0');
            }
          } catch (error) {
            console.error('‚ùå Error getting user from Auth0:', error);
          }
        }
      }

      if (!userEmail || !businessId) {
        console.error('‚ùå Missing required info:', { 
                    userEmail: !!userEmail, 
          businessId: !!businessId,
          fromUrl: { email: urlParams.get('email'), businessId: urlParams.get('businessId') }
        });
        showStatus('Missing user or business information. Please ensure you are logged in and have selected a business.', 'error');
        return;
      }

      console.log('‚úÖ Business info loaded successfully:', { userEmail, businessId });

    } catch (error) {
      console.error('‚ùå Error loading business info:', error);
      showStatus(`Error loading business information: ${error.message}`, 'error');
    }
  }

  // ========== FILE UPLOAD HANDLERS - MULTI-FILE SUPPORT ==========
  audioUploadBox.addEventListener('click', () => {
    fileInput.click();
  });

  fileInput.addEventListener('change', (e) => {
    handleAudioUpload(Array.from(e.target.files));
  });

  audioUploadBox.addEventListener('dragover', (e) => {
    e.preventDefault();
    audioUploadBox.style.borderColor = 'var(--primary-orange)';
    audioUploadBox.style.background = '#FFF8F0';
  });

  audioUploadBox.addEventListener('dragleave', () => {
    if (uploadedAudioFiles.length === 0) {
      audioUploadBox.style.borderColor = 'var(--border-color)';
      audioUploadBox.style.background = 'var(--light-bg)';
    }
  });

  audioUploadBox.addEventListener('drop', (e) => {
    e.preventDefault();
    audioUploadBox.style.borderColor = 'var(--border-color)';
    audioUploadBox.style.background = 'var(--light-bg)';
    handleAudioUpload(Array.from(e.dataTransfer.files));
  });

  // Make file input support multiple files
  fileInput.setAttribute('multiple', 'multiple');

  function handleAudioUpload(files) {
    if (!files || files.length === 0) return;

    const validTypes = ['audio/mpeg', 'audio/wav', 'audio/m4a', 'audio/ogg', 'audio/mp4'];
    const maxSize = 25 * 1024 * 1024;
    
    // Filter valid files
    const validFiles = files.filter(file => {
      if (!validTypes.includes(file.type)) {
        showStatus(`Skipped ${file.name}: Invalid format. Use MP3, WAV, M4A, or OGG`, 'error');
        return false;
      }
      if (file.size > maxSize) {
        showStatus(`Skipped ${file.name}: File too large (max 25MB)`, 'error');
        return false;
      }
      return true;
    });

    if (validFiles.length === 0) {
      return;
    }

    // Check total file count
    if (uploadedAudioFiles.length + validFiles.length > COSTS.MAX_FILES) {
      showStatus(`Maximum ${COSTS.MAX_FILES} files allowed. Please remove some files first.`, 'error');
      return;
    }

    // Add files to the list
    validFiles.forEach(file => {
      uploadedAudioFiles.push(file);
    });

    updateFileList();
    updateCostDisplay();
    transcribeBtn.disabled = false;
    hideStatus();
  }

  function updateFileList() {
    if (uploadedAudioFiles.length === 0) {
      audioUploadBox.innerHTML = `
        <div class="audio-upload-icon">üéôÔ∏è</div>
        <div style="font-weight: 500; color: var(--text-primary);">Drag & drop your audio files</div>
        <div style="font-size: 12px; color: #666; margin-top: 8px;">or click to select (up to ${COSTS.MAX_FILES} files)</div>
        <div style="font-size: 11px; color: #999; margin-top: 8px;">Supported: MP3, WAV, M4A, OGG (Max 25MB each)</div>
      `;
      audioUploadBox.classList.remove('has-audio');
      return;
    }

    audioUploadBox.classList.add('has-audio');
    
    let html = `
      <div style="font-weight: 500; color: var(--text-primary); margin-bottom: 10px;">
        Selected Files <span class="file-count-badge">${uploadedAudioFiles.length}/${COSTS.MAX_FILES}</span>
      </div>
      <div class="audio-file-list">
    `;

    uploadedAudioFiles.forEach((file, index) => {
      const sizeMB = (file.size / 1024 / 1024).toFixed(2);
      html += `
        <div class="audio-file-item">
          <div class="file-icon">üéµ</div>
          <div class="file-info">
            <div class="file-name">${file.name}</div>
            <div class="file-size">${sizeMB} MB</div>
          </div>
          <button class="remove-file-btn" onclick="removeFile(${index})">‚úï</button>
        </div>
      `;
    });

    html += `</div>`;
    
    if (uploadedAudioFiles.length < COSTS.MAX_FILES) {
      html += `
        <div style="font-size: 12px; color: #666; margin-top: 10px; text-align: center;">
          Click to add more files (${COSTS.MAX_FILES - uploadedAudioFiles.length} remaining)
        </div>
      `;
    }

    audioUploadBox.innerHTML = html;
  }

  window.removeFile = function(index) {
    uploadedAudioFiles.splice(index, 1);
    updateFileList();
    updateCostDisplay();
    
    if (uploadedAudioFiles.length === 0) {
      transcribeBtn.disabled = true;
      fileInput.value = '';
    }
  };

  function updateCostDisplay() {
    const costDisplay = document.querySelector('.cost-display');
    if (uploadedAudioFiles.length === 0) {
      costDisplay.innerHTML = `
        <strong>Cost:</strong> <span class="cost-highlight">R${COSTS.PER_FILE.toFixed(2)}</span> per file<br>
        <span style="font-size: 11px; color: #666;">Includes transcription + speaker identification</span>
      `;
    } else {
      const totalCost = COSTS.PER_FILE * uploadedAudioFiles.length;
      costDisplay.innerHTML = `
        <strong>Total Cost:</strong> <span class="cost-highlight">R${totalCost.toFixed(2)}</span><br>
        <span style="font-size: 11px; color: #666;">R${COSTS.PER_FILE.toFixed(2)} √ó ${uploadedAudioFiles.length} file${uploadedAudioFiles.length > 1 ? 's' : ''}</span>
      `;
    }
  }

  function clearAll() {
    uploadedAudioFiles = [];
    currentTranscriptions = null;
    fileInput.value = '';
    transcribeBtn.disabled = true;
    copyBtn.style.display = 'none';
    downloadContainer.style.display = 'none';
    clearBtn.style.display = 'none';
    updateFileList();
    updateCostDisplay();
    transcriptionPreview.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">Upload audio files and click transcribe to see the preview here</div>';
    progressSection.style.display = 'none';
    hideStatus();
  }

  clearBtn.addEventListener('click', clearAll);

  // ========== TRANSCRIBE AUDIO - MULTI-FILE SUPPORT ==========
  transcribeBtn.addEventListener('click', async () => {
    await transcribeAudio();
  });

  async function transcribeAudio() {
    if (uploadedAudioFiles.length === 0 || !userEmail || !businessId) {
      showStatus('Missing required information. Please upload audio files and ensure you are logged in.', 'error');
      return;
    }

    // Calculate total size and estimate
    const totalSize = uploadedAudioFiles.reduce((sum, file) => sum + file.size, 0);
    const totalSizeMB = totalSize / 1024 / 1024;
    const estimatedMinutes = Math.ceil(totalSizeMB * 1);
    
    if (totalSizeMB > 50) {
      const proceed = confirm(
        `‚ö†Ô∏è Large batch detected (${totalSizeMB.toFixed(1)} MB total)\n\n` +
        `Estimated processing time: ${estimatedMinutes}+ minutes\n\n` +
        `Continue?`
      );
      
      if (!proceed) {
        return;
      }
    }

    transcribeBtn.disabled = true;
    isTranscribing = true;
    progressSection.style.display = 'block';
    progressFill.style.width = '0%';
    progressText.textContent = `Initializing batch transcription of ${uploadedAudioFiles.length} file(s)...`;
    hideStatus();

    try {
      const formData = new FormData();
      
      // Append all audio files
      uploadedAudioFiles.forEach((file) => {
        formData.append('audio', file);
      });
      
      formData.append('businessId', businessId);
      formData.append('userEmail', userEmail);

      progressText.textContent = `Uploading ${uploadedAudioFiles.length} file(s) (${totalSizeMB.toFixed(1)} MB)...`;
      progressFill.style.width = '10%';

      // Simulate progress for long-running operations
      const progressInterval = setInterval(() => {
        const currentWidth = parseFloat(progressFill.style.width);
        if (currentWidth < 80) {
          progressFill.style.width = `${currentWidth + 1}%`;
        }
      }, 3000);

      const response = await fetch('/api/audio-transcribe/transcribe', {
        method: 'POST',
        body: formData
      });

      clearInterval(progressInterval);
      progressFill.style.width = '90%';

      if (!response.ok) {
        const error = await response.json();
        if (response.status === 402) {
          throw new Error(`Insufficient funds!\n\nRequired: R${error.required?.toFixed(2)}\nBalance: ${error.formatted_balance}\n\nPlease add credits to continue.`);
        }
        if (response.status === 408) {
          throw new Error(error.error || 'Processing timed out. Please try shorter audio files.');
        }
        throw new Error(error.error || 'Transcription failed');
      }

      const result = await response.json();

      progressFill.style.width = '95%';
      progressText.textContent = 'Formatting results...';

      displayMultiFileTranscription(result);
      currentTranscriptions = result;

      progressFill.style.width = '100%';
      progressText.textContent = 'Complete!';

      setTimeout(() => {
        progressSection.style.display = 'none';
      }, 1500);

      let successMsg = '‚úÖ Batch transcription complete!';
      successMsg += `\nüìÅ Processed: ${result.summary.successful}/${result.summary.total} file(s)`;
      if (result.summary.failed > 0) {
        successMsg += `\n‚ö†Ô∏è Failed: ${result.summary.failed} file(s)`;
      }
      successMsg += `\nüí∞ Cost: R${result.costs.charged.toFixed(2)}`;
      if (result.summary.refunded > 0) {
        successMsg += ` (R${result.summary.refunded.toFixed(2)} refunded)`;
      }
      successMsg += `\nüìä New balance: ${result.formattedBalance || 'N/A'}`;

      showStatus(successMsg, result.summary.failed > 0 ? 'info' : 'success');

      copyBtn.style.display = 'inline-block';
      downloadContainer.style.display = 'inline-block';
      clearBtn.style.display = 'inline-block';

    } catch (error) {
      console.error('Transcription error:', error);
      progressSection.style.display = 'none';
      showStatus(error.message, 'error');
    } finally {
      transcribeBtn.disabled = false;
      isTranscribing = false;
    }
  }

  function displayMultiFileTranscription(result) {
    if (!result.files || result.files.length === 0) {
      transcriptionPreview.innerHTML = '<div style="color: #999; padding: 10px;">No transcription results</div>';
      return;
    }

    let html = `
      <div class="preview-header">
        Transcription Results (${result.summary.successful}/${result.summary.total} files)
      </div>
    `;

    result.files.forEach((file, index) => {
      const fileId = `file-${index}`;
      
      if (file.success) {
        html += `
          <div style="margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden;">
            <div class="transcription-file-header" onclick="toggleFileContent('${fileId}')">
              <div>
                <div class="file-title">üìÑ ${file.fileName}</div>
                <div style="font-size: 11px; color: #666;">
                  ${file.metadata.speakerGroups} speaker segments ‚Ä¢ 
                  ${file.metadata.segmentCount} total segments
                  ${file.metadata.duration ? ` ‚Ä¢ ${Math.round(file.metadata.duration / 60)} min` : ''}
                </div>
              </div>
              <div class="toggle-icon">‚ñº</div>
            </div>
            <div id="${fileId}" class="transcription-file-content">
        `;

        if (file.grouped && Array.isArray(file.grouped)) {
          file.grouped.forEach(group => {
            html += `
              <div class="speaker-segment">
                <div class="speaker-label">${group.speaker}</div>
                <div class="segment-text">${group.text}</div>
              </div>
            `;
          });
        } else if (file.text) {
          html += `<div style="padding: 10px;">${file.text}</div>`;
        }

        html += `
            </div>
          </div>
        `;
      } else {
        html += `
          <div style="margin-bottom: 15px; border: 1px solid #f5c6cb; border-radius: 6px; padding: 10px; background: #f8d7da;">
            <div style="font-weight: 600; color: #721c24;">‚ùå ${file.fileName}</div>
            <div style="font-size: 12px; color: #721c24; margin-top: 5px;">Error: ${file.error}</div>
          </div>
        `;
      }
    });

    transcriptionPreview.innerHTML = html;
  }

  window.toggleFileContent = function(fileId) {
    const content = document.getElementById(fileId);
    const header = content.previousElementSibling;
    const icon = header.querySelector('.toggle-icon');
    
    if (content.classList.contains('collapsed')) {
      content.classList.remove('collapsed');
      icon.textContent = '‚ñº';
    } else {
      content.classList.add('collapsed');
      icon.textContent = '‚ñ∂';
    }
  };

  // ========== COPY TO CLIPBOARD - MULTI-FILE SUPPORT ==========
  copyBtn.addEventListener('click', async () => {
    try {
      let textToCopy = '';
      
      if (currentTranscriptions && currentTranscriptions.files) {
        currentTranscriptions.files.forEach((file, index) => {
          if (file.success) {
            textToCopy += `\n\n========== ${file.fileName} ==========\n\n`;
            
            if (file.grouped && Array.isArray(file.grouped)) {
              textToCopy += file.grouped
                .map(group => `[${group.speaker}]: ${group.text}`)
                .join('\n\n');
            } else if (file.text) {
              textToCopy += file.text;
            }
          }
        });
      }

      if (!textToCopy) {
        throw new Error('No transcription data to copy');
      }

      await navigator.clipboard.writeText(textToCopy.trim());
      showStatus('‚úÖ All transcriptions copied to clipboard!', 'success');
      
      setTimeout(() => {
        hideStatus();
      }, 2000);
    } catch (error) {
      showStatus('Failed to copy to clipboard', 'error');
    }
  });

  // ========== DOWNLOAD MANAGER - MULTI-FILE SUPPORT ==========
  downloadBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    downloadDropdown.classList.toggle('show');
  });

  downloadFormatBtns.forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const format = btn.dataset.format;
      await downloadTranscription(format);
      downloadDropdown.classList.remove('show');
    });
  });

  document.addEventListener('click', () => {
    downloadDropdown.classList.remove('show');
  });

  async function downloadTranscription(format) {
    try {
      showStatus(`‚è≥ Generating ${format.toUpperCase()} file(s)...`, 'info');

      // If multiple files, download each separately
      if (currentTranscriptions && currentTranscriptions.files) {
        for (const file of currentTranscriptions.files) {
          if (!file.success) continue;

          const response = await fetch('/api/audio-transcribe/download', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              format: format,
              transcription: file,
              fileName: file.fileName.replace(/\.[^/.]+$/, '') // Remove extension
            })
          });

          if (!response.ok) {
            throw new Error(`Download failed for ${file.fileName}`);
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = `${file.fileName.replace(/\.[^/.]+$/, '')}.${format}`;
          document.body.appendChild(a);
          a.click();
          
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          // Small delay between downloads
          await new Promise(resolve => setTimeout(resolve, 500));
        }

        showStatus(`‚úÖ ${currentTranscriptions.files.filter(f => f.success).length} ${format.toUpperCase()} file(s) downloaded!`, 'success');
        
        setTimeout(() => {
          hideStatus();
        }, 2000);
      }
    } catch (error) {
      console.error('Download error:', error);
      showStatus(`Failed to download: ${error.message}`, 'error');
    }
  }

  // ========== SHOW/HIDE STATUS ==========
  function showStatus(message, type) {
    transcriptionStatus.textContent = message;
    transcriptionStatus.className = `status ${type}`;
    transcriptionStatus.style.display = 'block';
  }

  function hideStatus() {
    transcriptionStatus.style.display = 'none';
  }

    // ========== INITIALIZE ON PAGE LOAD ==========
  document.addEventListener('DOMContentLoaded', async () => {
    console.log('üéôÔ∏è Audio Transcriber initialized (Multi-file support)');
    await loadBusinessInfo();
    updateCostDisplay();
    
    // If missing info, show helpful message
    if (!userEmail || !businessId) {
      showStatus('‚ö†Ô∏è Please ensure you are logged in and have selected a business to use this feature.', 'error');
    }
  });
</script>
</body>
</html>