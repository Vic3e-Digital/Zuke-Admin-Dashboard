<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Transcriber with Azure AI | Zuke</title>
  <link rel="stylesheet" href="../../css/formStyle.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <style>
    /* Audio Transcriber Styles */
    .audio-container {
      display: flex;
      gap: 20px;
    }

    .audio-upload-section, .transcription-section {
      flex: 1;
      min-width: 300px;
    }

    .audio-upload-box {
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      background: var(--light-bg);
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .audio-upload-box:hover {
      border-color: var(--primary-orange);
      background: #FFF8F0;
    }

    .audio-upload-box.has-audio {
      border-color: var(--primary-orange);
      background: #FFF8F0;
    }

    .audio-upload-icon {
      font-size: 32px;
      margin-bottom: 10px;
      opacity: 0.6;
    }

    .transcription-preview {
      background: var(--light-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.6;
      color: #333;
    }

    .preview-header {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
    }

    .speaker-segment {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    .speaker-segment:last-child {
      border-bottom: none;
    }

    .speaker-label {
      font-weight: 600;
      color: var(--primary-orange);
      margin-bottom: 4px;
      font-size: 12px;
    }

    .segment-text {
      color: #555;
      margin-left: 10px;
    }

    .progress-section {
      margin-top: 20px;
      padding: 15px;
      background: var(--light-bg);
      border-radius: 8px;
      display: none;
    }

    .progress-bar-container {
      background: #e0e0e0;
      border-radius: 4px;
      height: 8px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      background: var(--primary-orange);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 12px;
      color: #666;
      text-align: center;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .action-button {
      flex: 1;
      min-width: 150px;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .transcribe-btn {
      background: var(--primary-orange);
      color: white;
    }

    .transcribe-btn:hover:not(:disabled) {
      background: #ff9500;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
    }

    .transcribe-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .copy-btn {
      background: #6c757d;
      color: white;
    }

    .copy-btn:hover {
      background: #5a6268;
    }

    .clear-btn {
      background: #6c757d;
      color: white;
    }

    .clear-btn:hover {
      background: #5a6268;
    }

    .status {
      padding: 12px 15px;
      border-radius: 6px;
      margin-top: 15px;
      display: none;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .file-input {
      display: none;
    }

    .cost-display {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
    }

    .cost-highlight {
      font-weight: 600;
      color: var(--primary-orange);
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-top: 10px;
      font-size: 14px;
    }

    .file-item .file-icon {
      font-size: 20px;
    }

    .file-item .file-info {
      flex: 1;
    }

    .file-item .file-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    .file-item .file-size {
      font-size: 12px;
      color: #666;
    }

    .file-item .remove-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .file-item .remove-btn:hover {
      background: #c82333;
    }

    @media (max-width: 768px) {
      .audio-container {
        flex-direction: column;
      }

      .audio-upload-section, .transcription-section {
        flex: none;
        width: 100%;
      }

      .button-group {
        flex-direction: column;
      }

      .action-button {
        min-width: auto;
      }
    }
  </style>
</head>

<body>
    <div class="container">
      
      <!-- Header -->
      <div class="header">
        <h1>Audio Transcriber with Azure AI</h1>
        <p>Convert large audio files to text with advanced speech recognition powered by Azure Cognitive Services</p>
      </div>

      <!-- Info Alert -->
      <div class="info-box" style="background: #fff3cd; border: 1px solid #ffc107; padding: 12px 15px; border-radius: 6px; margin-bottom: 20px; font-size: 14px; color: #856404;">
        <strong>üöÄ Powered by Azure AI Speech:</strong> This transcriber uses Microsoft's advanced speech recognition technology and supports audio files up to 500MB. Perfect for long recordings, podcasts, interviews, and more.
      </div>

      <!-- Main Content -->
      <div class="audio-container">
        
        <!-- Upload Section -->
        <div class="audio-upload-section">
          <div class="section-title">Upload Audio File</div>

          <div class="audio-upload-box" id="audioUploadBox">
            <div class="audio-upload-icon">‚òÅÔ∏è</div>
            <div style="font-weight: 500; color: var(--text-primary);">Drag & drop your audio file</div>
            <div style="font-size: 12px; color: #666; margin-top: 8px;">or click to select</div>
            <div style="font-size: 11px; color: #999; margin-top: 8px;">Supported: MP3, WAV, M4A, OGG, FLAC (Max 500MB)</div>
          </div>

          <div id="fileDisplay" style="margin-top: 15px;"></div>

          <!-- Diarization Toggle -->
          <div style="margin-top: 20px; padding: 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" id="diarizationToggle" checked style="width: 18px; height: 18px; cursor: pointer;">
              <label for="diarizationToggle" style="cursor: pointer; font-weight: 500; color: var(--text-primary); flex: 1; margin: 0;">
                Enable Speaker Identification
              </label>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 6px; margin-left: 28px;">
              Automatically identify different speakers in the conversation (+R5.00)
            </div>
          </div>

          <div class="cost-display" style="margin-top: 20px;">
            <strong>Pricing:</strong><br>
            <span class="cost-highlight">R0.50</span> per minute (transcription)<br>
            <span class="cost-highlight">R5.00</span> for speaker identification (if enabled)<br>
            <span style="font-size: 11px; color: #666;">Powered by Azure Cognitive Services</span>
          </div>
        </div>

        <!-- Transcription Section -->
        <div class="transcription-section">
          <div class="section-title">Transcription Preview</div>

          <div class="transcription-preview" id="transcriptionPreview">
            <div style="color: #999; text-align: center; padding: 20px;">
              Upload an audio file and click transcribe to see the preview here
            </div>
          </div>

          <!-- Progress Section -->
          <div class="progress-section" id="progressSection">
            <div class="progress-bar-container">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Initializing transcription...</div>
          </div>

          <!-- Action Buttons -->
          <div class="button-group" id="actionButtons">
            <button id="transcribeBtn" class="action-button transcribe-btn" disabled>
              ‚ö° Transcribe with Azure AI
            </button>
            <button id="copyBtn" class="action-button copy-btn" style="display: none;">
              üìã Copy to Clipboard
            </button>
            <button id="downloadBtn" class="action-button copy-btn" style="display: none;">
              üìÑ Download as Word
            </button>
            <button id="clearBtn" class="action-button clear-btn" style="display: none;">
              üóëÔ∏è Clear
            </button>
          </div>

          <!-- Status Messages -->
          <div id="transcriptionStatus" class="status"></div>
        </div>
      </div>

      <input type="file" id="fileInput" class="file-input" accept="audio/*">
    </div>

    <script>
  // ========== CONFIGURATION & STATE ==========
  const urlParams = new URLSearchParams(window.location.search);
  let userEmail = urlParams.get('email');
  let businessId = urlParams.get('businessId');
  let businessName = urlParams.get('businessName') || 'My Business';
  
  let auth0Client = null;
  let currentBusiness = null;
  let businessCase = {};
  
  let uploadedAudioFile = null;
  let currentTranscription = null;
  let isTranscribing = false;

  // ========== ELEMENT REFERENCES ==========
  const audioUploadBox = document.getElementById('audioUploadBox');
  const fileInput = document.getElementById('fileInput');
  const fileDisplay = document.getElementById('fileDisplay');
  const transcribeBtn = document.getElementById('transcribeBtn');
  const copyBtn = document.getElementById('copyBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const clearBtn = document.getElementById('clearBtn');
  const transcriptionPreview = document.getElementById('transcriptionPreview');
  const progressSection = document.getElementById('progressSection');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const transcriptionStatus = document.getElementById('transcriptionStatus');
  const diarizationToggle = document.getElementById('diarizationToggle');

  // ========== AUTH0 & BUSINESS INFO ==========
  async function getAuth0Client() {
    if (window.auth0Client) {
      console.log('‚úÖ Using global Auth0 client');
      return window.auth0Client;
    }
    
    if (window.parent && window.parent.auth0Client) {
      console.log('‚úÖ Using parent Auth0 client');
      return window.parent.auth0Client;
    }
    
    console.warn('‚ö†Ô∏è Global Auth0 client not available');
    return null;
  }

  async function loadBusinessInfo() {
    try {
      if (!businessId && window.parent && window.parent.dataManager) {
        try {
          currentBusiness = window.parent.dataManager.getSelectedBusinessOrFirst();
          if (currentBusiness) {
            businessId = currentBusiness._id;
            businessCase = currentBusiness.initial_business_case || {};
            console.log('‚úÖ Loaded business from parent');
          }
        } catch (e) {
          console.warn('Could not access parent dataManager');
        }
      }

      if (!userEmail) {
        const auth0 = await getAuth0Client();
        if (auth0) {
          try {
            const isAuthenticated = await auth0.isAuthenticated();
            if (isAuthenticated) {
              const user = await auth0.getUser();
              if (user && user.email) {
                userEmail = user.email;
                console.log('‚úÖ Got user email from Auth0');
              }
            }
          } catch (error) {
            console.error('Error getting user:', error);
          }
        }
      }

      if (!userEmail || !businessId) {
        console.error('Missing required info');
        showStatus('Missing user or business information. Please ensure you are logged in.', 'error');
        return;
      }

      console.log('‚úÖ Business info loaded');
    } catch (error) {
      console.error('Error loading business info:', error);
      showStatus(`Error: ${error.message}`, 'error');
    }
  }

  // ========== FILE UPLOAD HANDLERS ==========
  audioUploadBox.addEventListener('click', () => {
    fileInput.click();
  });

  fileInput.addEventListener('change', (e) => {
    handleAudioUpload(e.target.files[0]);
  });

  audioUploadBox.addEventListener('dragover', (e) => {
    e.preventDefault();
    audioUploadBox.style.borderColor = 'var(--primary-orange)';
    audioUploadBox.style.background = '#FFF8F0';
  });

  audioUploadBox.addEventListener('dragleave', () => {
    if (!uploadedAudioFile) {
      audioUploadBox.style.borderColor = 'var(--border-color)';
      audioUploadBox.style.background = 'var(--light-bg)';
    }
  });

  audioUploadBox.addEventListener('drop', (e) => {
    e.preventDefault();
    audioUploadBox.style.borderColor = 'var(--border-color)';
    audioUploadBox.style.background = 'var(--light-bg)';
    handleAudioUpload(e.dataTransfer.files[0]);
  });

  function handleAudioUpload(file) {
    if (!file) return;

    const validTypes = ['audio/mpeg', 'audio/wav', 'audio/m4a', 'audio/ogg', 'audio/mp4', 'audio/flac'];
    const maxSize = 500 * 1024 * 1024; // 500MB
    
    if (!validTypes.includes(file.type)) {
      showStatus(`Invalid format: ${file.type}. Use MP3, WAV, M4A, OGG, or FLAC`, 'error');
      return;
    }

    if (file.size > maxSize) {
      showStatus(`File too large (${(file.size / 1024 / 1024).toFixed(1)} MB). Maximum 500MB allowed`, 'error');
      return;
    }

    uploadedAudioFile = file;
    updateFileDisplay();
    transcribeBtn.disabled = false;
    hideStatus();
  }

  function updateFileDisplay() {
    if (!uploadedAudioFile) {
      audioUploadBox.classList.remove('has-audio');
      fileDisplay.innerHTML = '';
      return;
    }

    audioUploadBox.classList.add('has-audio');
    const sizeMB = (uploadedAudioFile.size / 1024 / 1024).toFixed(2);
    const estimatedCost = (sizeMB * 0.5).toFixed(2);
    
    fileDisplay.innerHTML = `
      <div class="file-item">
        <div class="file-icon">üéµ</div>
        <div class="file-info">
          <div class="file-name">${uploadedAudioFile.name}</div>
          <div class="file-size">${sizeMB} MB ‚Ä¢ Estimated cost: R${estimatedCost}</div>
        </div>
        <button class="remove-btn" onclick="removeFile()">‚úï</button>
      </div>
    `;
  }

  window.removeFile = function() {
    uploadedAudioFile = null;
    fileInput.value = '';
    updateFileDisplay();
    transcribeBtn.disabled = true;
  };

  function clearAll() {
    uploadedAudioFile = null;
    currentTranscription = null;
    fileInput.value = '';
    transcribeBtn.disabled = true;
    copyBtn.style.display = 'none';
    downloadBtn.style.display = 'none';
    clearBtn.style.display = 'none';
    updateFileDisplay();
    transcriptionPreview.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">Upload an audio file to begin</div>';
    progressSection.style.display = 'none';
    hideStatus();
  }

  clearBtn.addEventListener('click', clearAll);

  // ========== TRANSCRIBE AUDIO WITH AZURE AI ==========
  transcribeBtn.addEventListener('click', async () => {
    await transcribeAudio();
  });

  async function transcribeAudio() {
    if (!uploadedAudioFile || !userEmail || !businessId) {
      showStatus('Missing required information', 'error');
      return;
    }

    transcribeBtn.disabled = true;
    isTranscribing = true;
    progressSection.style.display = 'block';
    progressFill.style.width = '0%';
    progressText.textContent = 'Preparing file for Azure AI Speech...';
    hideStatus();

    try {
      const formData = new FormData();
      formData.append('audio', uploadedAudioFile);
      formData.append('businessId', businessId);
      formData.append('userEmail', userEmail);
      formData.append('diarization', diarizationToggle.checked);

      progressText.textContent = `Uploading ${uploadedAudioFile.name} to Azure...`;
      progressFill.style.width = '15%';

      // Simulate progress
      const progressInterval = setInterval(() => {
        const current = parseFloat(progressFill.style.width);
        if (current < 85) {
          progressFill.style.width = `${current + 2}%`;
        }
      }, 2000);

      const response = await fetch('/api/audio-transcribe/azure', {
        method: 'POST',
        body: formData
      });

      clearInterval(progressInterval);
      progressFill.style.width = '90%';

      if (!response.ok) {
        const error = await response.json();
        if (response.status === 402) {
          throw new Error(`Insufficient credits. Required: R${error.required}, Balance: ${error.balance}`);
        }
        throw new Error(error.error || 'Transcription failed');
      }

      const result = await response.json();
      progressFill.style.width = '98%';
      progressText.textContent = 'Processing results...';

      displayTranscription(result);
      currentTranscription = result;

      progressFill.style.width = '100%';
      progressText.textContent = 'Complete!';

      setTimeout(() => {
        progressSection.style.display = 'none';
      }, 1500);

      let successMsg = '‚úÖ Transcription complete!\n';
      successMsg += `üìÑ File: ${uploadedAudioFile.name}\n`;
      successMsg += `‚è±Ô∏è Duration: ${result.cost?.durationMinutes || 'Unknown'} minutes\n`;
      
      // Show cost breakdown
      if (result.cost?.transcriptionCost !== undefined && result.cost?.diarizationCost !== undefined) {
        successMsg += `üí∞ Cost breakdown:\n`;
        successMsg += `   ‚Ä¢ Transcription: R${result.cost.transcriptionCost.toFixed(2)}\n`;
        if (result.cost.diarizationCost > 0) {
          successMsg += `   ‚Ä¢ Speaker ID: R${result.cost.diarizationCost.toFixed(2)}\n`;
        }
        successMsg += `   ‚Ä¢ Total: R${result.cost?.amount?.toFixed(2) || 'N/A'}\n`;
      } else {
        successMsg += `üí∞ Cost: R${result.cost?.amount?.toFixed(2) || 'N/A'}\n`;
      }
      
      if (result.transcription.speakers && result.transcription.speakers.length > 0) {
        successMsg += `üé§ Speakers detected: ${result.transcription.speakers.length}\n`;
      }
      
      if (result.wallet?.new_balance) {
        successMsg += `üìä New balance: ${result.wallet.new_balance}`;
      }

      showStatus(successMsg, 'success');
      copyBtn.style.display = 'inline-block';
      downloadBtn.style.display = 'inline-block';
      clearBtn.style.display = 'inline-block';

    } catch (error) {
      console.error('Transcription error:', error);
      progressSection.style.display = 'none';
      showStatus(error.message, 'error');
    } finally {
      transcribeBtn.disabled = false;
      isTranscribing = false;
    }
  }

  function displayTranscription(result) {
    if (!result.transcription || !result.transcription.text) {
      transcriptionPreview.innerHTML = '<div style="color: #999; padding: 10px;">No transcription available</div>';
      return;
    }

    let html = '<div class="preview-header">Transcription Results</div>';
    
    if (result.transcription.confidence) {
      html += `<div style="font-size: 12px; color: #666; margin-bottom: 10px;">
        üìä Confidence: ${(parseFloat(result.transcription.confidence) * 100).toFixed(1)}%
      </div>`;
    }

    if (result.transcription.language) {
      html += `<div style="font-size: 12px; color: #666; margin-bottom: 10px;">
        üåç Language: ${result.transcription.language}
      </div>`;
    }

    if (result.transcription.speakers && result.transcription.speakers.length > 0) {
      html += `<div style="font-size: 12px; color: #666; margin-bottom: 10px;">
        üé§ Speakers: ${result.transcription.speakers.join(', ')}
      </div>`;
    }

    // Display with speaker labels if diarization is enabled
    if (diarizationToggle.checked && result.transcription.phrases && result.transcription.phrases.length > 0) {
      html += '<div style="margin-top: 15px;">';
      
      let currentSpeaker = null;
      let speakerText = '';
      
      result.transcription.phrases.forEach(phrase => {
        const speaker = phrase.speaker !== undefined ? `Speaker ${phrase.speaker}` : 'Unknown';
        
        if (currentSpeaker !== speaker && speakerText) {
          html += `<div class="speaker-segment">
            <div class="speaker-label">${currentSpeaker}</div>
            <div class="segment-text">${speakerText}</div>
          </div>`;
          speakerText = '';
        }
        
        currentSpeaker = speaker;
        speakerText += (speakerText ? ' ' : '') + phrase.text;
      });
      
      if (speakerText && currentSpeaker) {
        html += `<div class="speaker-segment">
          <div class="speaker-label">${currentSpeaker}</div>
          <div class="segment-text">${speakerText}</div>
        </div>`;
      }
      
      html += '</div>';
    } else {
      html += `<div style="white-space: pre-wrap; color: #333; margin-top: 15px;">${result.transcription.text}</div>`;
    }
    
    transcriptionPreview.innerHTML = html;
  }

  // ========== COPY TO CLIPBOARD ==========
  copyBtn.addEventListener('click', async () => {
    try {
      if (!currentTranscription || !currentTranscription.transcription || !currentTranscription.transcription.text) {
        throw new Error('No transcription data');
      }

      await navigator.clipboard.writeText(currentTranscription.transcription.text);
      showStatus('‚úÖ Transcription copied to clipboard!', 'success');
      
      setTimeout(() => {
        hideStatus();
      }, 2000);
    } catch (error) {
      showStatus('Failed to copy: ' + error.message, 'error');
    }
  });

  // ========== DOWNLOAD AS WORD ==========
  downloadBtn.addEventListener('click', async () => {
    try {
      if (!currentTranscription || !currentTranscription.transcription) {
        throw new Error('No transcription data');
      }

      downloadBtn.disabled = true;
      showStatus('üìÑ Generating Word document...', 'info');

      const response = await fetch('/api/audio-transcribe/download-word', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          transcription: currentTranscription.transcription,
          fileName: uploadedAudioFile.name,
          metadata: {
            fileName: uploadedAudioFile.name,
            duration: currentTranscription.cost?.durationMinutes,
            language: currentTranscription.transcription.language,
            confidence: currentTranscription.transcription.confidence,
            speakers: currentTranscription.transcription.speakers,
            cost: currentTranscription.cost?.amount?.toFixed(2)
          }
        })
      });

      if (!response.ok) {
        throw new Error('Failed to generate Word document');
      }

      // Download the file
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${uploadedAudioFile.name.replace(/\.[^/.]+$/, '')}_transcription.docx`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);

      showStatus('‚úÖ Word document downloaded successfully!', 'success');
      setTimeout(() => {
        hideStatus();
      }, 2000);

    } catch (error) {
      showStatus('Failed to download: ' + error.message, 'error');
    } finally {
      downloadBtn.disabled = false;
    }
  });

  // ========== SHOW/HIDE STATUS ==========
  function showStatus(message, type) {
    transcriptionStatus.textContent = message;
    transcriptionStatus.className = `status ${type}`;
    transcriptionStatus.style.display = 'block';
  }

  function hideStatus() {
    transcriptionStatus.style.display = 'none';
  }

  // ========== INITIALIZE ON PAGE LOAD ==========
  document.addEventListener('DOMContentLoaded', async () => {
    console.log('üéôÔ∏è Azure AI Speech Transcriber initialized');
    await loadBusinessInfo();
  });
</script>
</body>
</html>
