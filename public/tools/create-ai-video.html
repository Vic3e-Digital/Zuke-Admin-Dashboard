<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generate AI Content</title>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Hanken Grotesk', -apple-system, sans-serif;
      padding: 20px;
      background: #f8f9fa;
    }
    .container { max-width: 600px; margin: 0 auto; }
    
    .section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #2c3e50;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    .radio-group {
      display: flex;
      gap: 16px;
      margin-top: 8px;
    }
    
    .radio-option {
      flex: 1;
      position: relative;
    }
    
    .radio-option input[type="radio"] {
      position: absolute;
      opacity: 0;
    }
    
    .radio-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      border: 2px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }
    
    .radio-option input[type="radio"]:checked + .radio-label {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .radio-label:hover {
      border-color: #667eea;
    }
    
    .radio-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .radio-text {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }
    
    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
    }
    
    select {
      background: white;
      cursor: pointer;
    }
    
    textarea:focus, input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .field-note {
      font-size: 13px;
      color: #666;
      margin-top: 6px;
      font-style: italic;
    }
    
    .platforms {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .platform-btn {
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      font-size: 12px;
    }
    
    .platform-btn:hover:not([disabled]) { border-color: #667eea; }
    
    .platform-btn.selected {
      border-color: #667eea;
      background: #f0f4ff;
      font-weight: 600;
    }
    
    .platform-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .cost {
      background: #fff3cd;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 600;
    }
    
    .generate-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .generate-btn:hover:not(:disabled) { opacity: 0.9; }
    .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .status {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      display: none;
      white-space: pre-wrap;
      animation: slideIn 0.3s ease;
    }
    
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    
    .progress {
      display: none;
      margin-top: 15px;
      text-align: center;
    }
    
    .progress-text {
      color: #667eea;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .preview-section {
      display: none;
      margin-top: 20px;
    }
    
    .preview-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .preview-label {
      font-size: 14px;
      font-weight: 600;
      color: #666;
      margin-bottom: 10px;
    }
    
    .preview-media {
      width: 100%;
      max-height: 400px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .preview-caption {
      color: #333;
      line-height: 1.5;
    }
    
    .suggestion-card {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .suggestion-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }
    
    .suggestion-card.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea25 0%, #764ba225 100%);
    }
    
    .suggestion-card::before {
      content: '✨';
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 20px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .suggestion-card:hover::before {
      opacity: 1;
    }
    
    .suggestion-title {
      font-weight: 700;
      font-size: 15px;
      color: #2c3e50;
      margin-bottom: 8px;
      line-height: 1.3;
    }
    
    .suggestion-preview {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .suggestion-badge {
      display: inline-block;
      background: #667eea;
      color: white;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      margin-top: 8px;
      font-weight: 600;
    }

    .video-fields {
      display: none;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }

    .video-fields.show {
      display: block;
    }

    .duration-buttons {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }

    .duration-btn {
      flex: 1;
      padding: 10px 8px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
    }

    .duration-btn:hover {
      border-color: #667eea;
    }

    .duration-btn.selected {
      border-color: #667eea;
      background: #f0f4ff;
      color: #667eea;
    }

    /* ✅ HIDE IMAGE UPLOAD SECTION */
    .image-upload-section-disabled {
      display: none !important;
    }

    .image-upload-container {
      margin-top: 16px;
      padding: 16px;
      border: 2px dashed #ddd;
      border-radius: 8px;
      text-align: center;
      transition: all 0.2s;
      background: #f8f9fa;
    }

    .image-upload-container:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .image-upload-container input[type="file"] {
      display: none;
    }

    .upload-label {
      display: inline-block;
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: opacity 0.2s;
    }

    .upload-label:hover {
      opacity: 0.9;
    }

    .image-preview {
      margin-top: 12px;
      display: none;
    }

    .image-preview img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
    }

    .remove-image {
      margin-top: 8px;
      padding: 6px 12px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .disclaimer {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 6px;
      padding: 8px 12px;
      margin-top: 12px;
      font-size: 12px;
      color: #856404;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .disclaimer:hover {
      background: #ffe69c;
    }

    .disclaimer-icon {
      font-size: 16px;
      flex-shrink: 0;
    }

    .disclaimer-text {
      font-weight: 600;
    }

    .disclaimer-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.2s ease;
    }

    .disclaimer-modal.show {
      display: flex;
    }

    .disclaimer-modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      margin: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.3s ease;
    }

    .disclaimer-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .disclaimer-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #2c3e50;
    }

    .disclaimer-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .disclaimer-modal-close:hover {
      background: #f0f0f0;
      color: #333;
    }

    .disclaimer-modal-body {
      color: #555;
      line-height: 1.6;
      font-size: 14px;
    }

    .disclaimer-modal-body strong {
      color: #856404;
      display: block;
      margin-bottom: 8px;
    }

    .upload-progress {
      display: none;
      margin-top: 12px;
      text-align: center;
    }

    .upload-progress-text {
      color: #667eea;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .upload-progress-bar {
      width: 100%;
      height: 6px;
      background: #f0f0f0;
      border-radius: 3px;
      overflow: hidden;
    }

    .upload-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .generate-suggestions-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
      margin-bottom: 16px;
    }
    
    .generate-suggestions-btn:hover:not(:disabled) { opacity: 0.9; }
    .generate-suggestions-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .coming-soon-badge {
      display: inline-block;
      background: #ffc107;
      color: #333;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 600;
      margin-left: 8px;
    }

    .webhook-indicator {
      display: inline-block;
      background: #28a745;
      color: white;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 4px;
      margin-left: 8px;
      font-weight: 600;
    }

    .webhook-indicator.video {
      background: #ff6b6b;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 1️⃣ Content Type Selection -->
    <div class="section">
      <div class="section-title">
        1. Choose Content Type
        <span id="webhookIndicator" class="webhook-indicator">🎥 Generate Video</span>
      </div>
      <div class="radio-group">
        <!-- ✅ IMAGE OPTION DISABLED -->
        <div class="radio-option" style="opacity: 0.3; pointer-events: none;">
          <input type="radio" id="typeImage" name="contentType" value="image" disabled>
          <label for="typeImage" class="radio-label">
            <div class="radio-icon">📷</div>
            <div class="radio-text">Image</div>
            <span class="coming-soon-badge" style="margin-top: 8px;">Coming Soon</span>
          </label>
        </div>
        <div class="radio-option">
          <input type="radio" id="typeVideo" name="contentType" value="video" checked>
          <label for="typeVideo" class="radio-label">
            <div class="radio-icon">🎥</div>
            <div class="radio-text">Video</div>
          </label>
        </div>
      </div>
    </div>

    <!-- 2️⃣ AI Suggestions Section -->
    <div class="section">
      <div class="section-title">
        💡 AI Content Suggestions
      </div>
      
      <button id="generateSuggestionsBtn" class="generate-suggestions-btn">
        ✨ Generate AI Suggestions for <span id="businessNameInline">Your Business</span>
      </button>
      
      <div id="suggestionsSection" style="display: none;">
        <div id="suggestionsLoading" style="text-align: center; padding: 20px; color: #666;">
          <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
          <p style="margin-top: 10px;">Generating personalized suggestions...</p>
        </div>
        
        <div id="suggestionsContent" style="display: none;">
            <div id="suggestionCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 12px;">
                <!-- Cards will be injected here -->
              </div>
              <button id="refreshSuggestionsBtn" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                🔄 Get New Suggestions
              </button>
            </div>
            
            <div id="suggestionsError" style="display: none; color: #d9534f; padding: 12px; background: #f8d7da; border-radius: 6px;"></div>
          </div>
        </div>
      
        <!-- 3️⃣ Concept Input -->
        <div class="section">
          <div class="section-title">2. Describe Your Content</div>
          
          <div class="form-group">
            <label for="concept">Content Concept</label>
            <textarea 
              id="concept" 
              placeholder="E.g., A professional African businesswoman in a modern office, smiling confidently..."
              rows="4"
            ></textarea>
            <p class="field-note">Describe what you want to see in your video. Be specific about style, setting, mood, etc.</p>
          </div>
      
          <div class="form-group">
            <label for="caption">Caption (Optional)</label>
            <textarea 
              id="caption" 
              placeholder="Write the caption that will accompany your post..."
              rows="3"
            ></textarea>
            <p class="field-note">Leave blank to have AI generate a caption based on your concept</p>
          </div>
    
          <!-- ✅ VIDEO-SPECIFIC OPTIONS (Always Visible Now) -->
          <div class="video-fields" id="videoOptions" style="display: block;">
            <div class="form-group">
              <label>Video Duration</label>
              <div class="duration-buttons">
                <button type="button" class="duration-btn" data-duration="4">
                  ⚡ 4 seconds<br><small>Ultra Quick</small>
                </button>
                <button type="button" class="duration-btn selected" data-duration="8">
                  🎬 8 seconds<br><small>Recommended</small>
                </button>
                <button type="button" class="duration-btn" data-duration="12">
                  🎥 12 seconds<br><small>Maximum</small>
                </button>
              </div>
              <input type="hidden" id="videoDuration" value="8">
            </div>
    
            <div class="form-group">
              <label for="videoSize">Video Resolution & Aspect Ratio</label>
              <select id="videoSize">
                <option value="720x1280" selected>9:16 - Vertical (720x1280) - Reels, TikTok, Shorts</option>
                <option value="1280x720">16:9 - Horizontal (1280x720) - YouTube</option>
                <option value="720x720">1:1 - Square (720x720) - Feed Posts</option>
              </select>
              <p class="field-note">Maximum resolution: 1280x720 (720p)</p>
            </div>
    
            <div class="form-group">
              <label for="videoStyle">Video Style</label>
              <select id="videoStyle">
                <option value="dynamic">Dynamic - Fast cuts and movement</option>
                <option value="smooth" selected>Smooth - Flowing transitions</option>
                <option value="minimal">Minimal - Simple and clean</option>
                <option value="cinematic">Cinematic - Professional look</option>
              </select>
            </div>
          </div>
    
          <!-- ✅ IMAGE UPLOAD SECTION - COMPLETELY DISABLED -->
          <!-- Keeping the HTML commented out for future re-enabling if needed
          <div class="form-group image-upload-section-disabled" id="imageUploadSection">
            <label for="imageUpload">
              📷 Image to Video (Optional)
              <span class="coming-soon-badge">Coming Soon</span>
            </label>
            <input type="file" id="imageUpload" accept="image/jpeg,image/jpg,image/png" disabled>
            <p class="field-note">This feature will be available soon</p>
          </div>
          -->
        </div>
      
        <!-- 4️⃣ Platform Selection -->
        <!-- <div class="section">
          <div class="section-title">3. Select Platforms</div>
          <div class="platforms">
            <button class="platform-btn" data-platform="facebook" data-cost="10">
              📘<br>Facebook<br><small>R10.00</small>
            </button>
            <button class="platform-btn" data-platform="instagram" data-cost="10">
              📷<br>Instagram<br><small>R10.00</small>
            </button>
            <button class="platform-btn" data-platform="linkedin" data-cost="10">
              💼<br>LinkedIn<br><small>R10.00</small>
            </button>
            <button class="platform-btn" data-platform="youtube" data-cost="10" id="youtubeBtn">
              🎥<br>YouTube<br><small>R10.00</small>
            </button>
          </div>
          
          <div class="cost" id="costDisplay">
            Select platforms to see cost
          </div>
        </div> -->
      
        <!-- 4️⃣ Platform Selection -->
<div class="section">
    <div class="section-title">3. Select Platforms (Optional)</div>
    <p style="font-size: 13px; color: #666; margin-bottom: 16px;">
      Select platforms to automatically post your video, or skip to just generate the video.
    </p>
    <div class="platforms">
      <button class="platform-btn" data-platform="facebook" data-cost="10">
        📘<br>Facebook<br><small>R10.00</small>
      </button>
      <button class="platform-btn" data-platform="instagram" data-cost="10">
        📷<br>Instagram<br><small>R10.00</small>
      </button>
      <button class="platform-btn" data-platform="linkedin" data-cost="10">
        💼<br>LinkedIn<br><small>R10.00</small>
      </button>
      <button class="platform-btn" data-platform="youtube" data-cost="10" id="youtubeBtn">
        🎥<br>YouTube<br><small>R10.00</small>
      </button>
    </div>
    
    <div class="cost" id="costDisplay">
      AI Video Generation: R20.00
    </div>
  </div>
        <!-- 5️⃣ Generate Button -->
<button class="generate-btn" id="generateBtn" disabled>
    <span id="generateBtnText">Generate Video</span>
  </button>
      
        <!-- Progress -->
        <div class="progress" id="progress">
          <p class="progress-text" id="progressText">Generating video with AI...</p>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>
      
        <!-- Status Messages -->
        <div class="status" id="status"></div>
      
        <!-- Preview Section -->
        <div class="preview-section" id="previewSection">
          <div class="section">
            <div class="section-title">Generated Video Preview</div>
            <div class="preview-card">
              <div class="preview-label">Media</div>
              <video id="previewVideo" class="preview-media" controls style="display: none;"></video>
              
              <div class="preview-label" style="margin-top: 20px;">Caption</div>
              <p class="preview-caption" id="previewCaption">—</p>
              
              <div class="preview-label" style="margin-top: 20px;">Platforms</div>
              <p class="preview-caption" id="previewPlatforms">—</p>
            </div>
          </div>
        </div>
      </div>
    
    <script src="/js/dataManager.js"></script>
    
    <script>
    // ========== GLOBAL VARIABLES ==========
    let auth0Client = null;
    let currentBusiness = null;
    let openAIConfig = null;
    let selectedPlatforms = [];
    let uploadedImageUrl = null; // Keep for future use, but won't be used currently
    
    const urlParams = new URLSearchParams(window.location.search);
    const userEmail = urlParams.get('email');
    const businessId = urlParams.get('businessId');
    const businessName = urlParams.get('businessName');
    
    // ✅ Only using VIDEO webhook since image is disabled
    const WEBHOOKS = {
      video: 'https://aigents.southafricanorth.azurecontainer.io/webhook/ai-video-generation-form'
    };
    
    // ✅ CLOUDINARY CONFIG (Disabled for now but kept for future)
    const CLOUDINARY_UPLOAD_PRESET = 'n8n-ai-preset';
    const CLOUDINARY_CLOUD_NAME = 'vic-3e';
    
    const generateBtn = document.getElementById('generateBtn');
    const costDisplay = document.getElementById('costDisplay');
    const status = document.getElementById('status');
    const progress = document.getElementById('progress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const previewSection = document.getElementById('previewSection');
    const youtubeBtn = document.getElementById('youtubeBtn');
    const webhookIndicator = document.getElementById('webhookIndicator');
    
    // ✅ HELPER: Get current webhook URL (always video now)
    function getCurrentWebhook() {
      return WEBHOOKS.video;
    }
    
    // ✅ HELPER: Update webhook indicator (always video now)
    function updateWebhookIndicator() {
      webhookIndicator.textContent = '🎥 Video Webhook';
      webhookIndicator.className = 'webhook-indicator video';
    }
    
    // ========== AUTH0 CLIENT ==========
    async function getAuth0Client() {
      if (window.auth0Client) return window.auth0Client;
      
      try {
        const response = await fetch("/auth_config.json");
        const config = await response.json();
        auth0Client = await auth0.createAuth0Client({
          domain: config.domain,
          clientId: config.clientId,
          cacheLocation: 'localstorage',
          useRefreshTokens: true
        });
        window.auth0Client = auth0Client;
        return auth0Client;
      } catch (error) {
        console.error("Error configuring Auth0:", error);
        return null;
      }
    }
    
    // ========== FETCH OPENAI CONFIG FROM BACKEND ==========
    async function getOpenAIConfig() {
      if (openAIConfig) return openAIConfig;
      
      try {
        const response = await fetch('/api/get-openai-config');
        if (!response.ok) throw new Error('Failed to get OpenAI config');
        openAIConfig = await response.json();
        return openAIConfig;
      } catch (error) {
        console.error('Error fetching OpenAI config:', error);
        return null;
      }
    }
    
    // ========== CALL AZURE OPENAI ==========
    async function callAzureOpenAI(prompt) {
      const config = await getOpenAIConfig();
      if (!config) throw new Error('OpenAI config not available');
    
      const url = `${config.endpoint}openai/deployments/${config.deployment}/chat/completions?api-version=2025-01-01-preview`;
    
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'api-key': config.apiKey
        },
        body: JSON.stringify({
          messages: [
            {
              role: "system",
              content: "You are a practical video content creator. You MUST respond with valid JSON only. Generate exactly 3 simple, achievable video concepts that focus on speaking to camera, narration with B-roll footage, or straightforward demonstrations. Each suggestion should be easy to film with basic equipment. Return a JSON object with a 'suggestions' array containing 3 objects with 'title', 'concept', and 'caption' fields."
            },
            {
              role: "user",
              content: prompt
            }
          ],
          max_tokens: 800,
          temperature: 0.8,
          top_p: 0.95,
          response_format: { type: "json_object" }
        })
      });
    
      if (!response.ok) {
        const errorText = await response.text();
        console.error('Azure OpenAI error:', errorText);
        throw new Error(`OpenAI API error: ${response.status}`);
      }
    
      const data = await response.json();
      return data.choices[0].message.content;
    }
    
    // ========== LOAD BUSINESS INFO ==========
    async function loadBusinessInfo() {
      const auth0 = await getAuth0Client();
      if (!auth0) return;
    
      try {
        const isAuthenticated = await auth0.isAuthenticated();
        if (!isAuthenticated) {
          console.warn('User not authenticated');
          return;
        }
    
        currentBusiness = window.dataManager?.getSelectedBusinessOrFirst();
        
        if (!currentBusiness) {
          console.warn('No business found in cache');
          return;
        }
    
        const businessName = currentBusiness?.store_info?.name || 'Your Business';
        document.getElementById('businessNameInline').textContent = businessName;
    
      } catch (error) {
        console.error('Error loading business:', error);
      }
    }
    
    // ========== FETCH AI SUGGESTIONS (VIDEO ONLY) ==========
    async function fetchSuggestions() {
      const loadingDiv = document.getElementById('suggestionsLoading');
      const contentDiv = document.getElementById('suggestionsContent');
      const errorDiv = document.getElementById('suggestionsError');
      const cardsContainer = document.getElementById('suggestionCards');
      const suggestionsSection = document.getElementById('suggestionsSection');
    
      suggestionsSection.style.display = 'block';
      loadingDiv.style.display = 'block';
      contentDiv.style.display = 'none';
      errorDiv.style.display = 'none';
    
      try {
        const businessCase = currentBusiness?.initial_business_case || {};
        const businessInfo = JSON.stringify(businessCase, null, 2);
    
        // ✅ Always generate VIDEO suggestions now
        const prompt = `Based on this business information:

${businessInfo}

Generate exactly 3 simple, practical video concepts (MAXIMUM 8 SECONDS each) that are easy to create with basic equipment.

Focus on simple formats:
- Speaking directly to camera (talking head style)
- Narration with B-roll footage (voice-over with relevant visuals)
- Simple demonstrations or tutorials
- Behind-the-scenes content
- Quick tips or explanations

Keep it simple and achievable:
- No complex editing or special effects needed
- Can be filmed with a phone or basic camera
- Clear, straightforward content
- Professional but approachable tone

Return ONLY valid JSON in this exact format:
{
  "suggestions": [
    {
      "title": "Simple Video Concept (Max 8 sec)",
      "concept": "Clear description of the video concept. Specify if it's speaking to camera, narration with B-roll, or simple demonstration. Include basic shot description and what the person should say or do.",
      "caption": "Professional caption with relevant hashtags and clear call-to-action. Keep it business-focused and informative."
    }
  ]
}

Make each suggestion practical, professional, and easy to execute with basic equipment.`;
    
        console.log('🤖 Calling Azure OpenAI for video suggestions...');
        const response = await callAzureOpenAI(prompt);
        
        let data;
        try {
          data = JSON.parse(response);
        } catch (e) {
          const jsonMatch = response.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            data = JSON.parse(jsonMatch[0]);
          } else {
            throw new Error('Invalid JSON response from AI');
          }
        }
    
        const suggestions = data.suggestions || [];
        
        if (suggestions.length === 0) {
          throw new Error('No suggestions generated');
        }
    
        cardsContainer.innerHTML = '';
    
        suggestions.forEach((suggestion, index) => {
          const card = document.createElement('div');
          card.className = 'suggestion-card';
          
          // ✅ Always show video badge
          const badge = '<span style="background: #ff6b6b; color: white; font-size: 10px; padding: 2px 6px; border-radius: 3px; margin-right: 6px;">📹 Simple</span>';
          
          card.innerHTML = `
            ${badge}<div class="suggestion-title">${suggestion.title}</div>
            <div class="suggestion-preview">${suggestion.concept}</div>
            <span class="suggestion-badge">Click to use</span>
          `;
          
          card.addEventListener('click', () => {
            document.querySelectorAll('.suggestion-card').forEach(c => 
              c.classList.remove('selected')
            );
            
            card.classList.add('selected');
            
            document.getElementById('concept').value = suggestion.concept;
            document.getElementById('caption').value = suggestion.caption;
            
            updateGenerateButton();
            
            document.getElementById('concept').scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
        
        showStatus('✅ Suggestion applied! Review and select platforms below.', 'info');
        setTimeout(() => {
          status.style.display = 'none';
        }, 3000);
      });
      
      cardsContainer.appendChild(card);
    });
    
    loadingDiv.style.display = 'none';
    contentDiv.style.display = 'block';

  } catch (error) {
    console.error('Error fetching suggestions:', error);
    loadingDiv.style.display = 'none';
    errorDiv.style.display = 'block';
    errorDiv.textContent = '⚠️ Failed to generate suggestions. Please try again.';
  }
}

// ========== CLOUDINARY UPLOAD FUNCTION (Disabled but kept for future) ==========
async function uploadToCloudinary(file, onProgress) {
  return new Promise((resolve, reject) => {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    formData.append('folder', 'ai-content-uploads');
    
    const xhr = new XMLHttpRequest();
    
    xhr.upload.addEventListener('progress', (e) => {
      if (e.lengthComputable && onProgress) {
        const percentComplete = Math.round((e.loaded / e.total) * 100);
        onProgress(percentComplete);
      }
    });
    
    xhr.addEventListener('load', () => {
      if (xhr.status === 200) {
        try {
          const response = JSON.parse(xhr.responseText);
          console.log('Cloudinary response:', response);
          resolve(response.secure_url);
        } catch (error) {
          reject(new Error('Failed to parse Cloudinary response'));
        }
      } else {
        try {
          const error = JSON.parse(xhr.responseText);
          reject(new Error(error.error?.message || 'Upload failed'));
        } catch {
          reject(new Error(`Upload failed with status ${xhr.status}`));
        }
      }
    });
    
    xhr.addEventListener('error', () => {
      reject(new Error('Network error during upload'));
    });
    
    xhr.addEventListener('timeout', () => {
      reject(new Error('Upload timed out'));
    });
    
    const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
    xhr.open('POST', url);
    xhr.timeout = 30000;
    xhr.send(formData);
  });
}

// ========== GENERATE REQUEST ID ==========
function generateRequestId() {
  const timestamp = Date.now();
  const random = Math.random().toString(36).substring(2, 15);
  return `gen_${timestamp}_${random}`;
}

// ========== SETUP VIDEO DURATION BUTTONS ==========
function setupVideoDurationButtons() {
  document.querySelectorAll('.duration-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('videoDuration').value = btn.dataset.duration;
    });
  });
}

// ========== INITIALIZE ON PAGE LOAD ==========
document.addEventListener('DOMContentLoaded', () => {
  loadBusinessInfo();
  setupVideoDurationButtons();
  updateWebhookIndicator();
  updateCost(); // ✅ Add this to show initial cost
  updateGenerateButtonText(); // ✅ Add this to show initial button text

  // ✅ Generate Suggestions Button Handler
  const generateSuggestionsBtn = document.getElementById('generateSuggestionsBtn');
  if (generateSuggestionsBtn) {
    generateSuggestionsBtn.addEventListener('click', async () => {
      if (!currentBusiness) {
        showStatus('⚠️ Please wait while business information loads...', 'info');
        await loadBusinessInfo();
        if (!currentBusiness) {
          showStatus('❌ Could not load business information', 'error');
          return;
        }
      }
      await fetchSuggestions();
    });
  }

  // Refresh Suggestions Button
  const refreshBtn = document.getElementById('refreshSuggestionsBtn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', fetchSuggestions);
  }

  // ✅ IMAGE UPLOAD HANDLERS REMOVED - Feature disabled
  // All image upload related code has been removed
});

// ✅ CONTENT TYPE CHANGES - Removed since only video is available
// No need for radio button change handler since image option is disabled

// ========== CONCEPT INPUT ==========
document.getElementById('concept').addEventListener('input', updateGenerateButton);

// ========== PLATFORM SELECTION ==========
document.querySelectorAll('.platform-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    if (btn.disabled) return;
    
    btn.classList.toggle('selected');
    const platform = btn.dataset.platform;
    
    if (selectedPlatforms.includes(platform)) {
      selectedPlatforms = selectedPlatforms.filter(p => p !== platform);
    } else {
      selectedPlatforms.push(platform);
    }
    
    updateCost();
    updateGenerateButton();
    updateGenerateButtonText(); // ✅ Add this line

  });
});


// ========== UPDATE COST (Modified to show generation cost always) ==========
function updateCost() {
  let postingCost = 0;
  selectedPlatforms.forEach(platform => {
    const btn = document.querySelector(`[data-platform="${platform}"]`);
    if (btn) postingCost += parseInt(btn.dataset.cost);
  });
  
  const generationCost = 20;
  const total = generationCost + postingCost;
  
  // ✅ Always show cost, even with 0 platforms
  if (selectedPlatforms.length > 0) {
    costDisplay.innerHTML = `AI Video Generation: R${generationCost.toFixed(2)} + Posting: R${postingCost.toFixed(2)}<br><strong>Total: R${total.toFixed(2)}</strong>`;
  } else {
    // ✅ Show generation-only cost
    costDisplay.innerHTML = `AI Video Generation: R${generationCost.toFixed(2)}<br><strong>Total: R${total.toFixed(2)}</strong><br><small style="color: #666;">Video will be generated but not posted</small>`;
  }
}

// ========== UPDATE GENERATE BUTTON (Modified to not require platforms) ==========
function updateGenerateButton() {
  const concept = document.getElementById('concept').value.trim();
  // ✅ Only require concept, platforms are optional
  const isValid = concept.length > 10;
  generateBtn.disabled = !isValid;
}

// ========== ✅ GENERATE BUTTON CLICK - VIDEO ONLY ==========
generateBtn.addEventListener('click', async () => {
  const contentType = 'video'; // ✅ Always video now
  const concept = document.getElementById('concept').value.trim();
  const caption = document.getElementById('caption').value.trim();

  if (!concept) return;  // ✅ Only check concept, allow empty platforms

  generateBtn.disabled = true;
  progress.style.display = 'block';
  status.style.display = 'none';
  previewSection.style.display = 'none';
  progressFill.style.width = '20%';

  try {
    const generationCost = 20;
    let postingCost = 0;
    selectedPlatforms.forEach(platform => {
      const btn = document.querySelector(`[data-platform="${platform}"]`);
      if (btn) postingCost += parseInt(btn.dataset.cost);
    });
    const totalCost = generationCost + postingCost;

    progressText.textContent = 'Processing request...';
    progressFill.style.width = '30%';

    // ✅ BUILD VIDEO POST CONTENT
    const postContent = {
      text: concept,
      caption: caption || '',
      contentType: 'video'
    };

    // ✅ Add video-specific fields
    const durationEl = document.getElementById('videoDuration');
    const sizeEl = document.getElementById('videoSize');
    const styleEl = document.getElementById('videoStyle');
    
    if (!durationEl || !sizeEl) {
      throw new Error('Video options not found. Please refresh the page.');
    }
    
    postContent.duration = parseInt(durationEl.value);
    postContent.resolution = sizeEl.value;
    postContent.style = styleEl?.value || 'smooth';
    
    // ✅ No image upload for now - feature disabled
    // if (uploadedImageUrl) {
    //   postContent.inputImage = uploadedImageUrl;
    // }
    
    console.log(`🎥 Video request: ${postContent.duration}s, ${postContent.resolution}, ${postContent.style}`);

    // ✅ PAYLOAD
    const payload = {
      businessId: businessId,
      userEmail: userEmail,
      platforms: selectedPlatforms,
      postContent: postContent,
      totalCost: totalCost
    };

    // ✅ GET WEBHOOK URL (always video)
    const webhookUrl = getCurrentWebhook();
    console.log(`📤 Sending to video webhook:`, webhookUrl);
    console.log('Payload:', payload);

    progressText.textContent = 'Generating AI video...';
    progressFill.style.width = '60%';

    // ✅ Call social-post endpoint
    const response = await fetch('/api/social-post/post', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const result = await response.json();
    console.log('✅ API response:', result);

    if (!response.ok) {
      if (response.status === 402) {
        throw new Error(
          `Insufficient funds!\n\n` +
          `Required: ${result.formatted_required || `R${totalCost.toFixed(2)}`}\n` +
          `Balance: ${result.formatted_balance}\n\n` +
          `Please add credits or upgrade.`
        );
      }
      
      throw new Error(result.error || 'Failed to generate video');
    }

    progressFill.style.width = '100%';

    if (result.success) {
  if (result.n8nResponse?.mediaUrl || result.n8nResponse?.media_url) {
    showPreview(
      result.n8nResponse.mediaUrl || result.n8nResponse.media_url, 
      result.n8nResponse.caption || result.n8nResponse.generated_caption || caption,
      selectedPlatforms
    );
  }

  // ✅ Updated success message for async processing
  let message = `✅ Video generation request submitted successfully!\n\n` +
                `⏳ Your video is being processed...\n\n` +
                `📧 You'll receive an email with your video in the next 5-10 minutes.\n\n` +
                `Details:\n` +
                `Duration: ${postContent.duration}s\n` +
                `Resolution: ${postContent.resolution}\n` +
                `Style: ${postContent.style}\n`;
  
  if (selectedPlatforms.length > 0) {
    message += `Platforms: ${selectedPlatforms.join(', ')} (will auto-post)\n`;
  } else {
    message += `Platforms: None (video only)\n`;
  }
  
  message += `\nCost: ${result.formatted_cost}\n` +
             `New Balance: ${result.formatted_balance}`;
  
  if (result.token_refresh_warnings && result.token_refresh_warnings.length > 0) {
    message += '\n\n⚠️ Warnings:\n' + result.token_refresh_warnings.join('\n');
  }

  showStatus(message, 'success');
  
  // ✅ Longer timeout since user needs to read the processing info
  setTimeout(() => resetForm(), 10000); // 10 seconds instead of 8

    } else {
      throw new Error(result.error || result.message || 'Generation failed');
    }

  } catch (error) {
    console.error('Error:', error);
    
    // Enhanced error handling
    if (error.message.includes('Insufficient funds')) {
      showStatus(
        '❌ Insufficient Funds\n\n' +
        'Please add credits or upgrade your plan to continue.',
        'error'
      );
    } else if (
      error.message.includes('token expired') || 
      error.message.includes('reconnect') ||
      error.message.includes('Token refresh failed') ||
      error.message.includes('authentication')
    ) {
      showStatus(
        '❌ Authentication Error\n\n' + 
        error.message + '\n\n' +
        '👉 Go to Settings → Social Media to reconnect the affected platform(s).',
        'error'
      );
    } else {
      showStatus('❌ ' + error.message, 'error');
    }
  } finally {
    progress.style.display = 'none';
    generateBtn.disabled = false;
  }
});

// ========== UPDATE GENERATE BUTTON TEXT BASED ON PLATFORMS ==========
function updateGenerateButtonText() {
  const btnText = document.getElementById('generateBtnText');
  if (selectedPlatforms.length > 0) {
    btnText.textContent = 'Generate & Publish Video';
  } else {
    btnText.textContent = 'Generate Video (No Posting)';
  }
}

// ========== SHOW PREVIEW (VIDEO ONLY) ==========
function showPreview(mediaUrl, caption, platforms) {
  const previewVideo = document.getElementById('previewVideo');
  const previewCaption = document.getElementById('previewCaption');
  const previewPlatforms = document.getElementById('previewPlatforms');

  previewVideo.src = mediaUrl;
  previewVideo.style.display = 'block';

  previewCaption.textContent = caption;
  previewPlatforms.textContent = platforms.map(p => 
    p.charAt(0).toUpperCase() + p.slice(1)
  ).join(', ');
  
  previewSection.style.display = 'block';
}

// ========== SHOW STATUS ==========
function showStatus(message, type) {
  status.textContent = message;
  status.className = `status ${type}`;
  status.style.display = 'block';
}

// ========== RESET FORM ==========
function resetForm() {
  document.getElementById('concept').value = '';
  document.getElementById('caption').value = '';
  selectedPlatforms = [];
  uploadedImageUrl = null; // Keep for future use
  
  document.querySelectorAll('.platform-btn').forEach(btn => 
    btn.classList.remove('selected')
  );
  
  document.querySelectorAll('.suggestion-card').forEach(card => 
    card.classList.remove('selected')
  );
  
  progressFill.style.width = '0%';
  previewSection.style.display = 'none';
  updateCost();
  updateGenerateButton();
}
</script>
</body>
</html>