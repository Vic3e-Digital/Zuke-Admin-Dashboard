<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generate AI Videos with Veo 3.1</title>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Hanken Grotesk', -apple-system, sans-serif;
      padding: 20px;
      background: #f8f9fa;
    }
    .container { max-width: 700px; margin: 0 auto; }
    
    .section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    /* Model Selection */
    .model-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .model-option {
      position: relative;
    }
    
    .model-option input[type="radio"] {
      position: absolute;
      opacity: 0;
    }
    
    .model-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      border: 2px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
      text-align: center;
    }
    
    .model-option input[type="radio"]:checked + .model-label {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .model-label:hover {
      border-color: #667eea;
    }
    
    .model-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .model-name {
      font-size: 15px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 4px;
    }
    
    .model-desc {
      font-size: 12px;
      color: #666;
    }
    
    .model-badge {
      display: inline-block;
      background: #667eea;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 6px;
    }
    
    /* Creation Mode Toggle */
    .creation-mode {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .mode-option {
      position: relative;
    }
    
    .mode-option input[type="radio"] {
      position: absolute;
      opacity: 0;
    }
    
    .mode-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      border: 2px solid #ddd;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
    }
    
    .mode-option input[type="radio"]:checked + .mode-label {
      border-color: #667eea;
      background: #f0f4ff;
      color: #667eea;
    }
    
    .mode-label:hover {
      border-color: #667eea;
    }
    
    /* Image Upload Box */
    .upload-box {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      background: #fafafa;
      margin-bottom: 20px;
      transition: all 0.2s;
    }
    
    .upload-box:hover { 
      border-color: #667eea; 
      background: #f0f4ff;
    }
    
    .upload-box.dragover { 
      border-color: #667eea; 
      background: #f0f4ff; 
    }
    
    .upload-box.has-image {
      padding: 15px;
    }
    
    .upload-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin-top: 10px;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .upload-info {
      margin-top: 10px;
      font-size: 13px;
      color: #666;
    }
    
    .remove-image-btn {
      margin-top: 10px;
      padding: 6px 12px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }
    
    .remove-image-btn:hover {
      background: #c82333;
    }
    
    /* Duration Selection */
    .duration-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .duration-btn {
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
    }
    
    .duration-btn:hover {
      border-color: #667eea;
    }
    
    .duration-btn.selected {
      border-color: #667eea;
      background: #f0f4ff;
      color: #667eea;
    }
    
    /* Quick Ideas Buttons */
    .quick-ideas {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .idea-btn {
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      font-weight: 600;
      text-align: left;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .idea-btn:hover {
      border-color: #667eea;
      background: #f0f4ff;
      transform: translateY(-2px);
    }
    
    .idea-btn.active {
      border-color: #667eea;
      background: #f0f4ff;
      color: #667eea;
    }
    
    .ai-ideas-btn {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border: 2px solid #667eea;
      color: #667eea;
      justify-content: center;
    }
    
    .ai-ideas-btn:hover {
      background: linear-gradient(135deg, #667eea25 0%, #764ba225 100%);
    }
    
    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      resize: vertical;
      min-height: 100px;
      font-size: 14px;
    }
    
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }
    
    textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .field-note {
      font-size: 13px;
      color: #666;
      margin-top: 6px;
      font-style: italic;
    }
    
    /* AI Suggestions */
    .suggestion-card {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      margin-bottom: 12px;
    }
    
    .suggestion-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }
    
    .suggestion-card.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea25 0%, #764ba225 100%);
    }
    
    .suggestion-title {
      font-weight: 700;
      font-size: 15px;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    
    .suggestion-preview {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
    }
    
    .suggestion-badge {
      display: inline-block;
      background: #667eea;
      color: white;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      margin-top: 8px;
      font-weight: 600;
    }
    
    /* Video Preview */
    .video-preview-container {
      display: none;
      margin-top: 20px;
      text-align: center;
    }
    
    .video-preview-container.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    .preview-video {
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      margin-bottom: 16px;
    }
    
    .preview-cost-notice {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
    }
    
    .preview-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .preview-actions button, .preview-actions a {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    
    .regenerate-btn {
      background: #6c757d;
      color: white;
    }
    
    .regenerate-btn:hover {
      background: #5a6268;
    }
    
    .discard-btn {
      background: #dc3545;
      color: white;
    }
    
    .discard-btn:hover {
      background: #c82333;
    }
    
    .download-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      text-decoration: none;
    }
    
    .download-btn:hover {
      opacity: 0.9;
    }
    
    .use-video-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      flex: 1;
      max-width: 250px;
    }
    
    .use-video-btn:hover {
      opacity: 0.9;
    }
    
    /* Platforms */
    .platforms {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .platform-btn {
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      font-size: 12px;
    }
    
    .platform-btn:hover:not([disabled]) { border-color: #667eea; }
    
    .platform-btn.selected {
      border-color: #667eea;
      background: #f0f4ff;
      font-weight: 600;
    }
    
    .platform-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .cost {
      background: #fff3cd;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 600;
    }
    
    .generate-btn, .publish-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .generate-btn:hover:not(:disabled), 
    .publish-btn:hover:not(:disabled) { 
      opacity: 0.9; 
    }
    
    .generate-btn:disabled, 
    .publish-btn:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
    }
    
    .status {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      display: none;
      white-space: pre-wrap;
      animation: slideIn 0.3s ease;
    }
    
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    
    .progress {
      display: none;
      margin-top: 15px;
      text-align: center;
    }
    
    .progress-text {
      color: #667eea;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none !important;
    }
    
    .info-badge {
      display: inline-block;
      background: #e7f3ff;
      color: #0d47a1;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 1️⃣ Model Selection -->
    <!-- <div class="section">
      <div class="section-title">
        <span>🎬</span> 1. Choose Veo Model
      </div>
      <div class="model-selector">
        <div class="model-option">
          <input type="radio" id="modelVeo31" name="veoModel" value="veo-3.1-generate-preview" checked>
          <label for="modelVeo31" class="model-label">
            <div class="model-icon">⚡</div>
            <div class="model-name">Veo 3.1</div>
            <div class="model-desc">Latest & Best</div>
            <span class="model-badge">Recommended</span>
          </label>
        </div>
        <div class="model-option">
          <input type="radio" id="modelVeo31Fast" name="veoModel" value="veo-3.1-fast-generate-preview">
          <label for="modelVeo31Fast" class="model-label">
            <div class="model-icon">🚀</div>
            <div class="model-name">Veo 3.1 Fast</div>
            <div class="model-desc">Faster Generation</div>
            <span class="model-badge">Quick</span>
          </label>
        </div>
      </div>
    </div> -->
<!-- 1️⃣ Model Selection -->
<div class="section">
  <div class="section-title">
    <span>🎬</span> 1. Choose Veo Model
  </div>
  
 
  <!-- Model Selection -->
  <div class="model-selector">
    <div class="model-option">
      <input type="radio" id="modelVeo31" name="veoModel" value="veo-3.1" checked>
      <label for="modelVeo31" class="model-label">
        <div class="model-icon">⚡</div>
        <div class="model-name">Veo 3.1</div>
        <div class="model-desc">Latest & Best</div>
        <span class="model-badge">Recommended</span>
      </label>
    </div>
    <div class="model-option">
      <input type="radio" id="modelVeo31Fast" name="veoModel" value="veo-3.1-fast">
      <label for="modelVeo31Fast" class="model-label">
        <div class="model-icon">🚀</div>
        <div class="model-name">Veo 3.1 Fast</div>
        <div class="model-desc">Faster Generation</div>
        <span class="model-badge">Quick</span>
      </label>
    </div>
    <div class="model-option">
      <input type="radio" id="modelVeo30" name="veoModel" value="veo-3.0">
      <label for="modelVeo30" class="model-label">
        <div class="model-icon">🎥</div>
        <div class="model-name">Veo 3.0</div>
        <div class="model-desc">Stable Version</div>
      </label>
    </div>
    <div class="model-option">
      <input type="radio" id="modelVeo30Fast" name="veoModel" value="veo-3.0-fast">
      <label for="modelVeo30Fast" class="model-label">
        <div class="model-icon">⚡</div>
        <div class="model-name">Veo 3.0 Fast</div>
        <div class="model-desc">Quick & Stable</div>
      </label>
    </div>
  </div>
</div>

    <!-- API Provider Selection -->
<div class="section">
  <div class="section-title">
    <span>🔧</span> API Provider
  </div>
  <div class="creation-mode">
    <div class="mode-option">
      <input type="radio" id="providerVertex" name="apiProvider" value="vertex-ai" checked>
      <label for="providerVertex" class="mode-label">
        <span>☁️</span> Vertex AI (Recommended)
      </label>
    </div>
    <div class="mode-option">
      <input type="radio" id="providerGemini" name="apiProvider" value="gemini-api">
      <label for="providerGemini" class="mode-label">
        <span>💎</span> Gemini API
      </label>
    </div>
  </div>
  <p class="field-note">Vertex AI provides better rate limits and reliability for production use.</p>
</div>

    <!-- 2️⃣ Creation Mode -->
    <div class="section">
      <div class="section-title">
        <span>🎥</span> 2. Creation Mode
      </div>
      <div class="creation-mode">
        <div class="mode-option">
          <input type="radio" id="modeTextToVideo" name="creationMode" value="text-to-video" checked>
          <label for="modeTextToVideo" class="mode-label">
            <span>✍️</span> Text to Video
          </label>
        </div>
        <div class="mode-option">
          <input type="radio" id="modeImageToVideo" name="creationMode" value="image-to-video">
          <label for="modeImageToVideo" class="mode-label">
            <span>🖼️</span> Image to Video
          </label>
        </div>
      </div>

      <!-- Image Upload (shown only in image-to-video mode) -->
      <div id="imageUploadSection" class="hidden">
        <label>Upload Initial Frame</label>
        <div class="upload-box" id="uploadBox">
          <div id="uploadPlaceholder">
            <div style="font-size: 40px; margin-bottom: 10px;">🖼️</div>
            <p style="font-weight: 600; margin-bottom: 5px;">Click or drag image here</p>
            <p style="color: #999; font-size: 13px;">JPG, PNG (max 20MB)</p>
          </div>
          <img id="uploadPreview" class="upload-preview" alt="Upload preview">
          <div id="uploadInfo" class="upload-info" style="display: none;"></div>
          <button id="removeImageBtn" class="remove-image-btn" style="display: none;">Remove Image</button>
        </div>
        <input type="file" id="fileInput" accept="image/*" style="display: none;">
        <p class="field-note">This image will be used as the first frame of your video</p>
      </div>
    </div>

    <!-- 3️⃣ Video Settings -->
    <div class="section">
      <div class="section-title">
        <span>⚙️</span> 3. Video Settings
      </div>
      
      <div class="form-group">
        <label>Duration</label>
        <div class="duration-selector">
            <button class="duration-btn" data-duration="4">
                4 seconds<br><small>Quick</small>
              </button>
              <button class="duration-btn" data-duration="6">
                6 seconds<br><small>Standard</small>
              </button>
              <button class="duration-btn selected" data-duration="8">
                8 seconds<br><small>Max Length</small>
              </button>
            </div>
          </div>
    
          <div class="form-group">
            <label for="aspectRatio">Aspect Ratio</label>
            <select id="aspectRatio">
              <option value="16:9" selected>16:9 - Widescreen (YouTube, Facebook)</option>
              <option value="9:16">9:16 - Vertical (Instagram, TikTok)</option>
            </select>
          </div>
    
          <div class="form-group">
            <label for="resolution">Resolution</label>
            <select id="resolution">
              <option value="720p" selected>720p HD</option>
              <option value="1080p">1080p Full HD (8s only, 16:9 only)</option>
            </select>
            <p class="field-note">1080p is only available for 8-second videos in 16:9 aspect ratio</p>
          </div>
        </div>
    
        <!-- 4️⃣ Quick Ideas & Concept -->
        <div class="section">
          <div class="section-title">
            <span>💡</span> 4. Video Concept
          </div>
          
          <!-- Quick Idea Buttons -->
          <div class="quick-ideas">
            <button class="idea-btn" data-idea="cinematic">
              🎬 Cinematic Shot
            </button>
            <button class="idea-btn" data-idea="product">
              📦 Product Demo
            </button>
            <button class="idea-btn" data-idea="nature">
              🌿 Nature Scene
            </button>
            <button class="idea-btn" data-idea="dialogue">
              💬 With Dialogue
            </button>
            <button class="idea-btn ai-ideas-btn" id="aiIdeasBtn">
              ✨ Get AI-Powered Ideas
            </button>
          </div>
    
          <!-- AI Suggestions (shown when clicked) -->
          <div id="suggestionsSection" class="hidden" style="margin-bottom: 20px;">
            <div id="suggestionsLoading" style="text-align: center; padding: 20px; color: #666;">
              <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
              <p style="margin-top: 10px;">Generating AI video ideas for <span id="businessNameDisplay">your business</span>...</p>
            </div>
            
            <div id="suggestionsContent" class="hidden">
              <div id="suggestionCards">
                <!-- Cards will be injected here -->
              </div>
              <button id="refreshSuggestionsBtn" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-top: 10px;">
                🔄 Get New Ideas
              </button>
            </div>
            
            <div id="suggestionsError" class="hidden" style="color: #d9534f; padding: 12px; background: #f8d7da; border-radius: 6px;"></div>
          </div>
    
          <!-- Video Description Input -->
          <div class="form-group">
            <label for="videoPrompt">
              <span id="promptLabel">Video Description *</span>
              <span class="info-badge">Include audio cues</span>
            </label>
            <textarea 
              id="videoPrompt" 
              placeholder="E.g., A wide shot of a misty forest. Two hikers push through ferns. Close-up: Fresh claw marks on a tree. Man: (Hand on knife) 'That's no ordinary bear.' Woman: (Fearful) 'Then what is it?' Rough bark, snapping twigs, footsteps on damp earth."
              rows="5"
            ></textarea>
            <p class="field-note">
              <strong>Pro Tips:</strong><br>
              • Use quotes for dialogue: "This must be it," he murmured<br>
              • Describe sound effects: (tires screeching, engine roaring)<br>
              • Set the scene: lighting, camera angles, mood<br>
              • Be specific about actions and movements
            </p>
          </div>
    
          <div class="form-group">
            <label for="negativePrompt">Negative Prompt (Optional)</label>
            <textarea 
              id="negativePrompt" 
              placeholder="E.g., cartoon, low quality, blurry, distorted faces..."
              rows="2"
            ></textarea>
            <p class="field-note">Describe what you DON'T want to see (avoid using "no" or "don't")</p>
          </div>
    
          <div class="form-group">
            <label for="caption">Social Media Caption (Optional)</label>
            <textarea 
              id="caption" 
              placeholder="Write the caption for your post... (leave blank for AI-generated caption)"
              rows="3"
            ></textarea>
            <p class="field-note">Will be auto-generated if left empty</p>
          </div>
    
          <!-- Generation Cost Notice -->
          <div style="background: #e7f3ff; border: 1px solid #2196F3; color: #0d47a1; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; text-align: center;">
            <strong>💰 Generation Cost: R80.00</strong> per video preview<br>
            <small>Videos include native audio generation</small>
          </div>
    
          <button class="generate-btn" id="generateBtn" disabled>
            ✨ Generate Video Preview (R80.00)
          </button>
    
          <!-- Progress -->
          <div class="progress" id="progress">
            <p class="progress-text" id="progressText">Generating video with AI...</p>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>
    
          <!-- Status Messages -->
          <div class="status" id="status"></div>
    
          <!-- Video Preview -->
          <div class="video-preview-container" id="videoPreviewContainer">
            <div class="preview-cost-notice">
              ✅ Video preview generated! Review below and decide.
            </div>
            <video id="previewVideo" class="preview-video" controls></video>
            <div class="preview-actions">
              <button class="discard-btn" id="discardBtn">
                🗑️ Discard
              </button>
              <button class="regenerate-btn" id="regenerateBtn">
                🔄 Regenerate (R80.00)
              </button>
              <a class="download-btn" id="downloadBtn" download="veo-generated-video.mp4" style="display: none;">
                ⬇️ Download
              </a>
              <button class="use-video-btn" id="useVideoBtn">
                ✓ Use This Video
              </button>
            </div>
          </div>
        </div>
    
        <!-- 5️⃣ Platform Selection (Hidden until video approved) -->
        <div class="section hidden" id="platformSection">
          <div class="section-title">
            <span>📱</span> 5. Select Platforms & Publish
          </div>
          
          <div class="platforms">
            <button class="platform-btn" data-platform="facebook" data-cost="10">
              📘<br>Facebook<br><small>R10.00</small>
            </button>
            <button class="platform-btn" data-platform="instagram" data-cost="10">
              📷<br>Instagram<br><small>R10.00</small>
            </button>
            <button class="platform-btn" data-platform="youtube" data-cost="10">
              🎥<br>YouTube<br><small>R10.00</small>
            </button>
            <button class="platform-btn" data-platform="linkedin" data-cost="10">
                💼<br>LinkedIn<br><small>R10.00</small>
              </button>
          </div>
          
          <div class="cost" id="costDisplay">
            Select platforms to see cost
          </div>
    
          <button class="publish-btn" id="publishBtn" disabled>
            📤 Publish to Selected Platforms
          </button>
    
          <div class="status" id="publishStatus"></div>
        </div>
      </div>
    
      <script src="/js/dataManager.js"></script>
    
      <script>
        // ========== GLOBAL VARIABLES ==========
        let auth0Client = null;
        let currentBusiness = null;
        let openAIConfig = null;
        let geminiConfig = null;
        let selectedPlatforms = [];
        let generatedVideoBlob = null;
        let generatedVideoUrl = null;
        let generatedCaption = null;
        let uploadedImageFile = null;
        let selectedDuration = 8;
        let currentProvider = null;


    
        const urlParams = new URLSearchParams(window.location.search);
        const userEmail = urlParams.get('email');
        const businessId = urlParams.get('businessId');
        const businessName = urlParams.get('businessName');
    
        // Cloudinary config
        const CLOUDINARY_UPLOAD_PRESET = 'n8n-ai-preset';
        const CLOUDINARY_CLOUD_NAME = 'vic-3e';
    
        const GENERATION_COST = 80; // R80.00 per video preview
    
        // Quick idea templates
        const ideaTemplates = {
          cinematic: "A cinematic dolly shot tracking through a modern office space at golden hour. Natural light streams through floor-to-ceiling windows. A confident professional walks through the frame. Ambient office sounds, footsteps, keyboard clicks in the distance. Professional, warm, aspirational mood.",
          product: "Studio shot with clean white background. Product slowly rotates on a turntable, professional lighting highlighting key features. Smooth, elegant movement. Subtle ambient sound, soft product placement sound. High-end commercial style.",
          nature: "Aerial drone shot pulling back from a serene mountain lake at sunrise. Mist rolling over the water, golden light breaking through. Birds chirping, gentle water sounds, peaceful morning ambiance. Breathtaking, tranquil, cinematic nature scene.",
          dialogue: "Medium shot of two people in conversation. Person 1: 'This changes everything.' Person 2: 'Are you sure about this?' Naturalistic lighting, subtle background ambiance, realistic dialogue delivery. Dramatic, tension-filled mood."
        };
    
        const generateBtn = document.getElementById('generateBtn');
        const regenerateBtn = document.getElementById('regenerateBtn');
        const discardBtn = document.getElementById('discardBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const useVideoBtn = document.getElementById('useVideoBtn');
        const publishBtn = document.getElementById('publishBtn');
        const costDisplay = document.getElementById('costDisplay');
        const status = document.getElementById('status');
        const publishStatus = document.getElementById('publishStatus');
        const progress = document.getElementById('progress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const videoPreviewContainer = document.getElementById('videoPreviewContainer');
        const previewVideo = document.getElementById('previewVideo');
        const platformSection = document.getElementById('platformSection');
        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('fileInput');
        const uploadPreview = document.getElementById('uploadPreview');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const uploadInfo = document.getElementById('uploadInfo');
        const removeImageBtn = document.getElementById('removeImageBtn');
        const imageUploadSection = document.getElementById('imageUploadSection');
        const promptLabel = document.getElementById('promptLabel');
    
        // ========== AUTH0 CLIENT ==========
        async function getAuth0Client() {
          if (window.auth0Client) return window.auth0Client;
          
          try {
            const response = await fetch("/auth_config.json");
            const config = await response.json();
            auth0Client = await auth0.createAuth0Client({
              domain: config.domain,
              clientId: config.clientId,
              cacheLocation: 'localstorage',
              useRefreshTokens: true
            });
            window.auth0Client = auth0Client;
            return auth0Client;
          } catch (error) {
            console.error("Error configuring Auth0:", error);
            return null;
          }
        }
    
        // ========== FETCH OPENAI CONFIG FROM BACKEND ==========
        async function getOpenAIConfig() {
          if (openAIConfig) return openAIConfig;
          
          try {
            const response = await fetch('/api/get-openai-config');
            if (!response.ok) throw new Error('Failed to get OpenAI config');
            openAIConfig = await response.json();
            return openAIConfig;
          } catch (error) {
            console.error('Error fetching OpenAI config:', error);
            return null;
          }
        }
    
        // // ========== FETCH GEMINI API KEY ==========
        // async function getGeminiConfig() {
        //   if (geminiConfig) return geminiConfig;
          
        //   try {
        //     const response = await fetch('/api/get-gemini-config');
        //     if (!response.ok) throw new Error('Failed to get Gemini config');
        //     geminiConfig = await response.json();
        //     return geminiConfig;
        //   } catch (error) {
        //     console.error('Error fetching Gemini config:', error);
        //     return null;
        //   }
        // }
    
        // ========== CALL AZURE OPENAI FOR SUGGESTIONS ==========
        async function callAzureOpenAI(prompt) {
          const config = await getOpenAIConfig();
          if (!config) throw new Error('OpenAI config not available');
    
          const url = `${config.endpoint}openai/deployments/${config.deployment}/chat/completions?api-version=2025-01-01-preview`;
    
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'api-key': config.apiKey
            },
            body: JSON.stringify({
              messages: [
                {
                  role: "system",
                  content: "You are a video content strategist specializing in Veo AI video generation. You MUST respond with valid JSON only. Generate exactly 3 detailed video prompts optimized for AI video generation with audio. Include camera movements, dialogue (in quotes), sound effects (in parentheses), and specific visual details. Return a JSON object with a 'suggestions' array containing 3 objects with 'title', 'concept', and 'caption' fields."
                },
                {
                  role: "user",
                  content: prompt
                }
              ],
              max_tokens: 1000,
              temperature: 0.8,
              top_p: 0.95,
              response_format: { type: "json_object" }
            })
          });
    
          if (!response.ok) {
            const errorText = await response.text();
            console.error('Azure OpenAI error:', errorText);
            throw new Error(`OpenAI API error: ${response.status}`);
          }
    
          const data = await response.json();
          return data.choices[0].message.content;
        }
    
        // In your HTML file - Replace the Veo functions

// ========== GENERATE VIDEO WITH VEO ==========
// async function generateVideoWithVeo(prompt, model, negativePrompt = null, imageFile = null) {
//   const requestBody = {
//     businessId: businessId,
//     userEmail: userEmail,
//     model: model,
//     prompt: prompt,
//     config: {
//       aspectRatio: document.getElementById('aspectRatio').value,
//       resolution: document.getElementById('resolution').value,
//       durationSeconds: selectedDuration.toString(),
//       numberOfVideos: 1
//     }
//   };

//   if (negativePrompt && negativePrompt.trim()) {
//     requestBody.negativePrompt = negativePrompt.trim();
//   }

//   if (imageFile) {
//     const imageBase64 = await fileToBase64(imageFile);
//     requestBody.image = {
//       imageBytes: imageBase64.split(',')[1],
//       mimeType: imageFile.type 
//     };
//   }

//   console.log('🎬 Generating video with Veo:', model);
//   console.log('📦 Request body:', requestBody);

//   // ✅ Call YOUR backend API
//   const response = await fetch('/api/veo/generate', {
//     method: 'POST',
//     headers: { 'Content-Type': 'application/json' },
//     body: JSON.stringify(requestBody)
//   });

//   if (!response.ok) {
//     const errorData = await response.json();
    
//     if (response.status === 402) {
//       throw new Error(
//         `Insufficient funds!\n\n` +
//         `Required: ${errorData.formatted_required}\n` +
//         `Balance: ${errorData.formatted_balance}\n\n` +
//         `Please add credits to continue.`
//       );
//     }
    
//     throw new Error(errorData.error || 'Video generation failed');
//   }

//   const data = await response.json();
//   console.log('✅ Backend response:', data);
//   return data.operationName;
// }


// ========== GENERATE VIDEO WITH VERTEX AI OR GEMINI ==========
async function generateVideoWithVeo(prompt, model, negativePrompt = null, imageFile = null) {
  const apiProvider = document.querySelector('input[name="apiProvider"]:checked').value;
  
  const requestBody = {
    businessId: businessId,
    userEmail: userEmail,
    model: model,
    prompt: prompt,
    config: {
      aspectRatio: document.getElementById('aspectRatio').value,
      resolution: document.getElementById('resolution').value,
      durationSeconds: selectedDuration.toString(),
      numberOfVideos: 1
    }
  };

  if (negativePrompt && negativePrompt.trim()) {
    requestBody.negativePrompt = negativePrompt.trim();
  }

  if (imageFile) {
    const imageBase64 = await fileToBase64(imageFile);
    requestBody.image = {
      imageBytes: imageBase64.split(',')[1],
      mimeType: imageFile.type 
    };
  }

  console.log('🎬 Generating video with:', apiProvider);
  console.log('📦 Request body:', requestBody);

  // ✅ Choose API endpoint based on provider
  const endpoint = apiProvider === 'vertex-ai' ? '/api/veo-vertex/generate' : '/api/veo/generate';

  const response = await fetch(endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(requestBody)
  });

  if (!response.ok) {
    const errorData = await response.json();
    
    if (response.status === 402) {
      throw new Error(
        `Insufficient funds!\n\n` +
        `Required: ${errorData.formatted_required}\n` +
        `Balance: ${errorData.formatted_balance}\n\n` +
        `Please add credits to continue.`
      );
    }
    
    throw new Error(errorData.error || 'Video generation failed');
  }

  const data = await response.json();
  console.log('✅ Backend response:', data);
  return data.operationName;
}

  
    // ========== POLL VIDEO GENERATION STATUS (WITH DETAILED LOGGING) ==========
async function pollVideoGeneration(operationName, provider) {
  let attempts = 0;
  const maxAttempts = 60;
  
  const apiProvider = provider || currentProvider || 'vertex-ai';
  
  console.log('🔍 ========== STARTING VIDEO POLLING ==========');
  console.log('📍 Operation Name:', operationName);
  console.log('🔧 Provider:', apiProvider);
  console.log('📡 Endpoint:', apiProvider === 'vertex-ai' ? '/api/veo-vertex/check-status' : '/api/veo/check-status');
  
  const endpoint = apiProvider === 'vertex-ai' ? '/api/veo-vertex/check-status' : '/api/veo/check-status';
  
  while (attempts < maxAttempts) {
    await new Promise(resolve => setTimeout(resolve, 10000));
    
    attempts++;
    progressText.textContent = `Generating video... (${attempts * 10}s elapsed)`;
    
    try {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ operationName })
      });

      if (!response.ok) {
        throw new Error('Failed to check video status');
      }

      const data = await response.json();
      
      console.log(`\n📊 ========== POLL ATTEMPT ${attempts} ==========`);
      console.log('Raw response:', JSON.stringify(data, null, 2));
      console.log('✓ done:', data.done);
      console.log('✓ hasResponse:', !!data.response);
      console.log('✓ hasError:', !!data.error);
      
      if (data.done) {
        console.log('\n🎉 ========== VIDEO GENERATION COMPLETE! ==========');
        
        // Check for errors
        if (data.error) {
          console.error('❌ Operation error:', JSON.stringify(data.error, null, 2));
          throw new Error(data.error.message || 'Video generation failed');
        }
        
        // Log complete response structure
        console.log('📦 Full response object:', data.response);
        console.log('📦 Response type:', data.response?.['@type']);
        
        // ✅ HANDLE DIFFERENT RESPONSE STRUCTURES
        let videoSample = null;
        
        if (apiProvider === 'vertex-ai') {
          console.log('\n🔵 ========== VERTEX AI RESPONSE ==========');
          console.log('Response keys:', Object.keys(data.response || {}));
          
          const videos = data.response?.videos;
          console.log('✓ videos array exists:', !!videos);
          console.log('✓ videos array length:', videos?.length);
          
          if (!videos || videos.length === 0) {
            console.error('❌ No videos in Vertex AI response');
            console.error('📦 Full data:', JSON.stringify(data, null, 2));
            throw new Error('No videos generated');
          }
          
          const firstVideo = videos[0];
          console.log('\n📹 ========== FIRST VIDEO OBJECT ==========');
          console.log('Video keys:', Object.keys(firstVideo));
          console.log('✓ Has gcsUri:', !!firstVideo.gcsUri);
          console.log('✓ Has bytesBase64Encoded:', !!firstVideo.bytesBase64Encoded);
          console.log('✓ mimeType:', firstVideo.mimeType);
          
          if (firstVideo.gcsUri) {
            console.log('📹 GCS URI:', firstVideo.gcsUri);
          }
          
          if (firstVideo.bytesBase64Encoded) {
            console.log('📹 Base64 length:', firstVideo.bytesBase64Encoded.length, 'characters');
            console.log('📹 Estimated size:', (firstVideo.bytesBase64Encoded.length * 0.75 / 1024 / 1024).toFixed(2), 'MB');
          }
          
          // Convert to common format
          videoSample = {
            video: {
              gcsUri: firstVideo.gcsUri,
              bytesBase64Encoded: firstVideo.bytesBase64Encoded,
              mimeType: firstVideo.mimeType || 'video/mp4'
            }
          };
          
          console.log('\n✅ Video sample created:', {
            hasGcsUri: !!videoSample.video.gcsUri,
            hasBase64: !!videoSample.video.bytesBase64Encoded,
            mimeType: videoSample.video.mimeType
          });
          
        } else {
          console.log('\n💎 ========== GEMINI API RESPONSE ==========');
          console.log('Response keys:', Object.keys(data.response || {}));
          
          const videoResponse = data.response?.generateVideoResponse;
          console.log('✓ generateVideoResponse exists:', !!videoResponse);
          
          if (!videoResponse) {
            console.error('❌ No generateVideoResponse');
            console.error('📦 Full data:', JSON.stringify(data, null, 2));
            throw new Error('Invalid response structure from Gemini API');
          }
          
          const generatedSamples = videoResponse.generatedSamples;
          console.log('✓ generatedSamples exists:', !!generatedSamples);
          console.log('✓ generatedSamples length:', generatedSamples?.length);
          
          if (!generatedSamples || generatedSamples.length === 0) {
            console.error('❌ No generatedSamples');
            console.error('📦 Full data:', JSON.stringify(data, null, 2));
            throw new Error('No video samples generated');
          }
          
          videoSample = generatedSamples[0];
          console.log('\n📹 ========== FIRST SAMPLE OBJECT ==========');
          console.log('Sample keys:', Object.keys(videoSample));
          console.log('✓ Has video:', !!videoSample.video);
          console.log('✓ Video URI:', videoSample.video?.uri);
          console.log('✓ Video keys:', videoSample.video ? Object.keys(videoSample.video) : 'N/A');
        }
        
        if (!videoSample.video) {
          console.error('❌ No video data in sample');
          console.error('📦 videoSample:', JSON.stringify(videoSample, null, 2));
          throw new Error('Video data not found in response');
        }
        
        console.log('\n✅ ========== RETURNING VIDEO SAMPLE ==========');
        console.log('Final video sample:', JSON.stringify(videoSample, null, 2));
        
        return videoSample;
      }
      
      const progressPercent = Math.min(50 + (attempts * 2), 90);
      progressFill.style.width = `${progressPercent}%`;
      
    } catch (error) {
      console.error('❌ Poll error:', error);
      throw error;
    }
  }
  
  throw new Error('Video generation timed out after 10 minutes');
}

// ========== DOWNLOAD VIDEO FROM API (WITH DETAILED LOGGING) ==========
async function downloadVideoFromGemini(videoFile) {
  console.log('\n⬇️ ========== DOWNLOADING VIDEO ==========');
  
  const apiProvider = currentProvider || 'vertex-ai';
  console.log('🔧 Provider:', apiProvider);
  console.log('📦 Received videoFile object:', JSON.stringify(videoFile, null, 2));
  console.log('✓ Has gcsUri:', !!videoFile.gcsUri);
  console.log('✓ Has bytesBase64Encoded:', !!videoFile.bytesBase64Encoded);
  console.log('✓ Has uri:', !!videoFile.uri);
  console.log('✓ mimeType:', videoFile.mimeType);
  
  // ✅ Check if video is already base64 - decode directly!
  if (videoFile.bytesBase64Encoded) {
    console.log('📦 Video is Base64 encoded');
    console.log('📊 Base64 string length:', videoFile.bytesBase64Encoded.length);
    console.log('📊 Estimated decoded size:', (videoFile.bytesBase64Encoded.length * 0.75 / 1024 / 1024).toFixed(2), 'MB');
    console.log('🔄 Decoding base64 to binary...');
    
    try {
      // Decode base64 string to binary
      const binaryString = atob(videoFile.bytesBase64Encoded);
      console.log('✓ Decoded to binary string, length:', binaryString.length);
      
      const bytes = new Uint8Array(binaryString.length);
      
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      
      console.log('✓ Converted to byte array, length:', bytes.length);
      
      // Create blob from binary data
      const blob = new Blob([bytes], { type: videoFile.mimeType || 'video/mp4' });
      
      console.log('✅ Blob created successfully!');
      console.log('📊 Blob size:', blob.size, 'bytes');
      console.log('📊 Blob size:', (blob.size / 1024 / 1024).toFixed(2), 'MB');
      console.log('📊 Blob type:', blob.type);
      
      return blob;
      
    } catch (error) {
      console.error('❌ Base64 decode error:', error);
      console.error('Error stack:', error.stack);
      throw new Error('Failed to decode base64 video: ' + error.message);
    }
  }
  
  // ✅ If not base64, download from server
  console.log('🌐 Video requires server download (GCS URI or regular URI)');
  
  const endpoint = apiProvider === 'vertex-ai' ? '/api/veo-vertex/download' : '/api/veo/download';
  console.log('📡 Using endpoint:', endpoint);
  
  const response = await fetch(endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ videoFile })
  });

  console.log('📡 Server response status:', response.status);
  console.log('📡 Server response headers:', Object.fromEntries(response.headers.entries()));

  if (!response.ok) {
    const errorText = await response.text();
    console.error('❌ Download error response:', errorText);
    throw new Error('Failed to download video: ' + response.status);
  }

  const blob = await response.blob();
  console.log('✅ Video downloaded from server');
  console.log('📊 Blob size:', blob.size, 'bytes');
  console.log('📊 Blob size:', (blob.size / 1024 / 1024).toFixed(2), 'MB');
  console.log('📊 Blob type:', blob.type);
  
  return blob;
}

    // ========== UPLOAD VIDEO TO CLOUDINARY ==========
    async function uploadVideoToCloudinary(videoBlob) {
      const formData = new FormData();
      formData.append('file', videoBlob, 'veo-generated-video.mp4');
      formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
      formData.append('folder', 'ai-generated-videos');
      formData.append('resource_type', 'video');

      const response = await fetch(
        `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/video/upload`,
        {
          method: 'POST',
          body: formData
        }
      );

      if (!response.ok) {
        throw new Error('Failed to upload video to Cloudinary');
      }

      const data = await response.json();
      return data.secure_url;
    }

    // ========== GENERATE CAPTION WITH AI ==========
    async function generateCaption(videoPrompt) {
      const config = await getOpenAIConfig();
      if (!config) return '';

      const url = `${config.endpoint}openai/deployments/${config.deployment}/chat/completions?api-version=2025-01-01-preview`;

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'api-key': config.apiKey
          },
          body: JSON.stringify({
            messages: [
              {
                role: "system",
                content: "You are a social media expert. Create engaging, concise captions for video posts. Include relevant emojis and 3-5 hashtags."
              },
              {
                role: "user",
                content: `Create a compelling social media caption for this video: ${videoPrompt}`
              }
            ],
            max_tokens: 200,
            temperature: 0.7
          })
        });

        if (!response.ok) return '';

        const data = await response.json();
        return data.choices[0].message.content.trim();
      } catch (error) {
        console.error('Caption generation error:', error);
        return '';
      }
    }

    // ========== FILE TO BASE64 ==========
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ========== LOAD BUSINESS INFO ==========
    async function loadBusinessInfo() {
      const auth0 = await getAuth0Client();
      if (!auth0) return;

      try {
        const isAuthenticated = await auth0.isAuthenticated();
        if (!isAuthenticated) {
          console.warn('User not authenticated');
          return;
        }

        currentBusiness = window.dataManager?.getSelectedBusinessOrFirst();
        
        if (!currentBusiness) {
          console.warn('No business found in cache');
          return;
        }

        const businessName = currentBusiness?.store_info?.name || 'Your Business';
        document.getElementById('businessNameDisplay').textContent = businessName;

      } catch (error) {
        console.error('Error loading business:', error);
      }
    }

    // ========== FETCH AI SUGGESTIONS ==========
    async function fetchSuggestions() {
      const loadingDiv = document.getElementById('suggestionsLoading');
      const contentDiv = document.getElementById('suggestionsContent');
      const errorDiv = document.getElementById('suggestionsError');
      const cardsContainer = document.getElementById('suggestionCards');
      const suggestionsSection = document.getElementById('suggestionsSection');

      suggestionsSection.classList.remove('hidden');
      loadingDiv.style.display = 'block';
      contentDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');

      try {
        if (!currentBusiness) {
          await loadBusinessInfo();
          if (!currentBusiness) {
            throw new Error('Business information not available');
          }
        }

        const businessCase = currentBusiness?.initial_business_case || {};
        const businessInfo = JSON.stringify(businessCase, null, 2);

        const prompt = `Based on this business information:

${businessInfo}

Generate exactly 3 creative video prompts optimized for Veo AI video generation (8 seconds max).

Each video should include:
- Specific camera movements (dolly, tracking, aerial, etc.)
- Dialogue in quotes: "spoken words"
- Sound effects in parentheses: (footsteps, wind, ambient noise)
- Visual details: lighting, composition, mood
- Action and movement

Return ONLY valid JSON in this exact format:
{
  "suggestions": [
    {
      "title": "Video Concept Title",
      "concept": "Detailed Veo prompt with camera movements, dialogue in quotes, sound effects in parentheses, visual style, and specific actions (3-4 sentences)",
      "caption": "Ready-to-use engaging social media caption with emojis and relevant hashtags"
    }
  ]
}

Make each suggestion cinematic, specific, and optimized for 8-second AI video generation with audio.`;

        console.log('🤖 Calling Azure OpenAI for video suggestions...');
        const response = await callAzureOpenAI(prompt);
        
        let data;
        try {
          data = JSON.parse(response);
        } catch (e) {
          const jsonMatch = response.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            data = JSON.parse(jsonMatch[0]);
          } else {
            throw new Error('Invalid JSON response from AI');
          }
        }

        const suggestions = data.suggestions || [];
        
        if (suggestions.length === 0) {
          throw new Error('No suggestions generated');
        }

        cardsContainer.innerHTML = '';

        suggestions.forEach((suggestion, index) => {
          const card = document.createElement('div');
          card.className = 'suggestion-card';
          
          card.innerHTML = `
            <div class="suggestion-title">${suggestion.title}</div>
            <div class="suggestion-preview">${suggestion.concept}</div>
            <span class="suggestion-badge">Click to use</span>
          `;
          
          card.addEventListener('click', () => {
            document.querySelectorAll('.suggestion-card').forEach(c => 
              c.classList.remove('selected')
            );
            
            card.classList.add('selected');
            
            document.getElementById('videoPrompt').value = suggestion.concept;
            document.getElementById('caption').value = suggestion.caption;
            
            // Clear any selected quick ideas
            document.querySelectorAll('.idea-btn').forEach(btn => 
              btn.classList.remove('active')
            );
            
            updateGenerateButton();
            
            document.getElementById('videoPrompt').scrollIntoView({ 
              behavior: 'smooth', 
              block: 'center' 
            });
            
            showStatus('✅ AI suggestion applied! Review and click Generate.', 'info');
            setTimeout(() => {
              status.style.display = 'none';
            }, 3000);
          });
          
          cardsContainer.appendChild(card);
        });
        
        loadingDiv.style.display = 'none';
        contentDiv.classList.remove('hidden');

      } catch (error) {
        console.error('Error fetching suggestions:', error);
        loadingDiv.style.display = 'none';
        errorDiv.classList.remove('hidden');
        errorDiv.textContent = '⚠️ ' + error.message;
      }
    }

    // ========== UPDATE GENERATE BUTTON ==========
    function updateGenerateButton() {
      const videoPrompt = document.getElementById('videoPrompt').value.trim();
      const creationMode = document.querySelector('input[name="creationMode"]:checked').value;
      
      let isValid = videoPrompt.length > 20;
      
      // In image-to-video mode, also require uploaded image
      if (creationMode === 'image-to-video') {
        isValid = isValid && uploadedImageFile !== null;
      }
      
      generateBtn.disabled = !isValid;
    }

    // ========== UPDATE PUBLISH BUTTON ==========
    function updatePublishButton() {
      const hasVideo = generatedVideoBlob || generatedVideoUrl;
      const hasPlatforms = selectedPlatforms.length > 0;
      const isValid = hasVideo && hasPlatforms;
      
      publishBtn.disabled = !isValid;
      
      console.log('Publish button state:', { hasVideo, hasPlatforms, isValid });
    }

    // ========== UPDATE COST ==========
    function updateCost() {
      let postingCost = 0;
      selectedPlatforms.forEach(platform => {
        const btn = document.querySelector(`[data-platform="${platform}"]`);
        if (btn) postingCost += parseInt(btn.dataset.cost);
      });
      
      if (selectedPlatforms.length > 0) {
        costDisplay.textContent = `Total Posting Cost: R${postingCost.toFixed(2)}`;
      } else {
        costDisplay.textContent = 'Select platforms to see cost';
      }
    }

    // ========== SHOW STATUS ==========
    function showStatus(message, type, targetElement = status) {
      targetElement.textContent = message;
      targetElement.className = `status ${type}`;
      targetElement.style.display = 'block';
    }

    // ========== VALIDATE RESOLUTION SETTINGS ==========
    function validateResolutionSettings() {
      const resolution = document.getElementById('resolution').value;
      const aspectRatio = document.getElementById('aspectRatio').value;
      const duration = selectedDuration;

      // 1080p restrictions
      if (resolution === '1080p') {
        if (duration !== 8) {
          showStatus('⚠️ 1080p requires 8-second duration. Adjusting...', 'info');
          selectedDuration = 8;
          document.querySelectorAll('.duration-btn').forEach(btn => {
            btn.classList.toggle('selected', btn.dataset.duration === '8');
          });
        }
        if (aspectRatio !== '16:9') {
          showStatus('⚠️ 1080p requires 16:9 aspect ratio. Adjusting...', 'info');
          document.getElementById('aspectRatio').value = '16:9';
        }
        setTimeout(() => status.style.display = 'none', 3000);
      }
    }

    // ========== GENERATE VIDEO ==========
    async function generateVideo() {
      const videoPrompt = document.getElementById('videoPrompt').value.trim();
      const negativePrompt = document.getElementById('negativePrompt').value.trim();
      const selectedModel = document.querySelector('input[name="veoModel"]:checked').value;
      const creationMode = document.querySelector('input[name="creationMode"]:checked').value;

      const selectedProvider = document.querySelector('input[name="apiProvider"]:checked').value;


      if (!videoPrompt) {
        showStatus('❌ Please describe the video you want to generate', 'error');
        return;
      }

      if (creationMode === 'image-to-video' && !uploadedImageFile) {
        showStatus('❌ Please upload an initial frame image', 'error');
        return;
      }

      // Validate settings
      validateResolutionSettings();

      generateBtn.disabled = true;
      progress.style.display = 'block';
      status.style.display = 'none';
      videoPreviewContainer.classList.remove('show');
      platformSection.classList.add('hidden');
      progressFill.style.width = '10%';

      currentProvider = selectedProvider;
      

      try {
        // Step 1: Deduct generation cost from wallet
        progressText.textContent = 'Checking wallet balance...';
        progressFill.style.width = '20%';

        // await deductGenerationCost();

        // Step 2: Start video generation
        progressText.textContent = creationMode === 'image-to-video' 
          ? 'Starting image-to-video generation...' 
          : 'Starting video generation...';
        progressFill.style.width = '30%';

        const operationName = await generateVideoWithVeo(
          videoPrompt,
          selectedModel,
          negativePrompt,
          creationMode === 'image-to-video' ? uploadedImageFile : null
        );

        // Step 3: Poll for completion
        progressText.textContent = 'Generating video with AI... This may take a few minutes.';
        progressFill.style.width = '50%';

        const videoResult = await pollVideoGeneration(operationName, currentProvider); // ✅ Pass provider


        // const videoResult = await pollVideoGeneration(operationName);

        // Step 4: Download the video
        progressText.textContent = 'Downloading generated video...';
        progressFill.style.width = '90%';

        const videoBlob = await downloadVideoFromGemini(videoResult.video);
        generatedVideoBlob = videoBlob;

        progressText.textContent = 'Generating caption...';
        progressFill.style.width = '95%';

        // Generate caption if not provided
        let caption = document.getElementById('caption').value.trim();
        if (!caption) {
          caption = await generateCaption(videoPrompt);
          document.getElementById('caption').value = caption;
        }
        generatedCaption = caption;

        progressFill.style.width = '100%';

        // Show preview
        const videoUrl = URL.createObjectURL(videoBlob);
        previewVideo.src = videoUrl;
        
        // Setup download button
        downloadBtn.href = videoUrl;
        downloadBtn.download = `veo-generated-${Date.now()}.mp4`;
        downloadBtn.style.display = 'inline-flex';
        
        videoPreviewContainer.classList.add('show');

        showStatus(
          `✅ Video generated! (R${GENERATION_COST.toFixed(2)} deducted)\n\n` +
          `Duration: ${selectedDuration}s\n` +
          `Resolution: ${document.getElementById('resolution').value}\n` +
          `Aspect Ratio: ${document.getElementById('aspectRatio').value}\n\n` +
          'Review the video and choose an action below.',
          'success'
        );

        // ✨ AUTO-SCROLL TO PREVIEW
        setTimeout(() => {
          const previewTop = videoPreviewContainer.getBoundingClientRect().top + window.pageYOffset;
          const offset = 80;
          
          window.scrollTo({
            top: previewTop - offset,
            behavior: 'smooth'
          });
        }, 300);

      } catch (error) {
        console.error('Error generating video:', error);
        showStatus('❌ ' + error.message, 'error');
      } finally {
        progress.style.display = 'none';
        generateBtn.disabled = false;
      }
    }

    // ========== UPLOAD TO CLOUDINARY (only when approved) ==========
    async function uploadApprovedVideo() {
      if (!generatedVideoBlob) {
        throw new Error('No video to upload');
      }

      showStatus('📤 Uploading approved video to cloud storage...', 'info', publishStatus);

      const videoUrl = await uploadVideoToCloudinary(generatedVideoBlob);
      generatedVideoUrl = videoUrl;
      
      console.log('✅ Video uploaded to Cloudinary:', videoUrl);
      return videoUrl;
    }

    // ========== PUBLISH TO SOCIAL MEDIA ==========
    async function publishToSocials() {
      if (!generatedVideoBlob || selectedPlatforms.length === 0) return;

      publishBtn.disabled = true;
      publishStatus.style.display = 'none';

      try {
        // Upload to Cloudinary now that user approved
        if (!generatedVideoUrl) {
          await uploadApprovedVideo();
        }

        const caption = document.getElementById('caption').value.trim() || generatedCaption;

        // Calculate posting cost
        let postingCost = 0;
        selectedPlatforms.forEach(platform => {
          const btn = document.querySelector(`[data-platform="${platform}"]`);
          if (btn) postingCost += parseInt(btn.dataset.cost);
        });

        showStatus('📤 Publishing to social media...', 'info', publishStatus);

        const response = await fetch('/api/social-post/post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            businessId: businessId,
            userEmail: userEmail,
            platforms: selectedPlatforms,
            postContent: {
              text: caption,
              video: generatedVideoUrl,
              contentType: 'video'
            },
            totalCost: postingCost
          })
        });

        const result = await response.json();

        if (result.success) {
          showStatus(
            `✅ Video posted successfully!\n\n` +
            `Platforms: ${selectedPlatforms.join(', ')}\n` +
            `Posting Cost: ${result.formatted_cost}\n` +
            `New Balance: ${result.formatted_balance}`,
            'success',
            publishStatus
          );
          
          setTimeout(() => resetForm(), 6000);
        } else if (response.status === 402) {
          throw new Error(
            `Insufficient funds!\n\n` +
            `Required: ${result.formatted_required}\n` +
            `Balance: ${result.formatted_balance}\n\n` +
            `Please add credits to continue.`
          );
        } else {
          throw new Error(result.error || 'Failed to publish video');
        }

      } catch (error) {
        console.error('Error publishing:', error);
        
        if (error.message.includes('token expired') || error.message.includes('reconnect')) {
          showStatus(
            '❌ Authentication Error\n\n' + 
            error.message + '\n\n' +
            '👉 Go to Settings → Social Media to reconnect the affected platform(s).',
            'error',
            publishStatus
          );
        } else {
          showStatus('❌ ' + error.message, 'error', publishStatus);
        }
      } finally {
        publishBtn.disabled = false;
      }
    }

    // ========== IMAGE UPLOAD HANDLERS ==========
    uploadBox.addEventListener('click', () => {
      if (!uploadedImageFile) {
        fileInput.click();
      }
    });

    fileInput.addEventListener('change', (e) => {
      handleFileUpload(e.target.files[0]);
    });
    
    uploadBox.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadBox.classList.add('dragover');
    });
    
    uploadBox.addEventListener('dragleave', () => {
      uploadBox.classList.remove('dragover');
    });
    
    uploadBox.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadBox.classList.remove('dragover');
      handleFileUpload(e.dataTransfer.files[0]);
    });

    function handleFileUpload(file) {
      if (!file || !file.type.startsWith('image/')) {
        showStatus('Please select an image file', 'error');
        return;
      }

      const maxSize = 20 * 1024 * 1024; // 20MB
      if (file.size > maxSize) {
        showStatus('Image file is too large. Maximum size is 20MB.', 'error');
        return;
      }

      uploadedImageFile = file;
      
      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        uploadPreview.src = e.target.result;
        uploadPreview.style.display = 'block';
        uploadPlaceholder.style.display = 'none';
        removeImageBtn.style.display = 'inline-block';
      };
      reader.readAsDataURL(file);

      // Show file info
      const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
      uploadInfo.textContent = `📁 ${file.name} (${sizeMB} MB)`;
      uploadInfo.style.display = 'block';
      uploadBox.classList.add('has-image');

      updateGenerateButton();
    }

    removeImageBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      uploadedImageFile = null;
      uploadPreview.style.display = 'none';
      uploadPreview.src = '';
      uploadPlaceholder.style.display = 'block';
      uploadInfo.style.display = 'none';
      removeImageBtn.style.display = 'none';
      uploadBox.classList.remove('has-image');
      fileInput.value = '';
      updateGenerateButton();
    });

    // ========== RESET FORM ==========
    function resetForm() {
      document.getElementById('videoPrompt').value = '';
      document.getElementById('negativePrompt').value = '';
      document.getElementById('caption').value = '';
      generatedVideoBlob = null;
      generatedVideoUrl = null;
      generatedCaption = null;
      uploadedImageFile = null;
      selectedPlatforms = [];
      
      // Reset upload
      uploadPreview.style.display = 'none';
      uploadPreview.src = '';
      uploadPlaceholder.style.display = 'block';
      uploadInfo.style.display = 'none';
      removeImageBtn.style.display = 'none';
      uploadBox.classList.remove('has-image');
      fileInput.value = '';
      
      // Reset download button
      downloadBtn.style.display = 'none';
      downloadBtn.href = '';
      
      // Reset platforms
      document.querySelectorAll('.platform-btn').forEach(btn => 
        btn.classList.remove('selected')
      );
      
      // Reset suggestions
      document.querySelectorAll('.suggestion-card').forEach(card => 
        card.classList.remove('selected')
      );
      
      // Reset quick ideas
      document.querySelectorAll('.idea-btn').forEach(btn => 
        btn.classList.remove('active')
      );
      
      // Reset sections
      videoPreviewContainer.classList.remove('show');
      platformSection.classList.add('hidden');
      document.getElementById('suggestionsSection').classList.add('hidden');
      
      progressFill.style.width = '0%';
      publishStatus.style.display = 'none';
      
      updateCost();
      updateGenerateButton();
      updatePublishButton();
    }

    // ========== EVENT LISTENERS ==========
    
    // Creation mode change
    document.querySelectorAll('input[name="creationMode"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        if (e.target.value === 'image-to-video') {
          imageUploadSection.classList.remove('hidden');
          promptLabel.innerHTML = 'Video Description * <span class="info-badge">Animate the image</span>';
          document.getElementById('videoPrompt').placeholder = 'E.g., The camera slowly zooms into the image. Gentle wind rustles leaves. Ambient nature sounds. Warm golden hour lighting. Cinematic and serene mood.';
        } else {
          imageUploadSection.classList.add('hidden');
          promptLabel.innerHTML = 'Video Description * <span class="info-badge">Include audio cues</span>';
          document.getElementById('videoPrompt').placeholder = 'E.g., A wide shot of a misty forest. Two hikers push through ferns. Close-up: Fresh claw marks on a tree. Man: (Hand on knife) \'That\'s no ordinary bear.\' Woman: (Fearful) \'Then what is it?\' Rough bark, snapping twigs, footsteps on damp earth.';
          
          // Clear uploaded image when switching back
          if (uploadedImageFile) {
            removeImageBtn.click();
          }
        }
        updateGenerateButton();
      });
    });

    // Duration buttons
    document.querySelectorAll('.duration-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedDuration = parseInt(btn.dataset.duration);
        validateResolutionSettings();
      });
    });

    // Resolution change
    document.getElementById('resolution').addEventListener('change', validateResolutionSettings);
    document.getElementById('aspectRatio').addEventListener('change', validateResolutionSettings);

    // Video prompt input
    document.getElementById('videoPrompt').addEventListener('input', updateGenerateButton);

    // Quick idea buttons
    document.querySelectorAll('.idea-btn:not(.ai-ideas-btn)').forEach(btn => {
      btn.addEventListener('click', () => {
        const idea = btn.dataset.idea;
        const template = ideaTemplates[idea];
        
        // Toggle active state
        document.querySelectorAll('.idea-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Clear AI suggestions selection
        document.querySelectorAll('.suggestion-card').forEach(c => 
          c.classList.remove('selected')
        );
        
        // Set the template
        document.getElementById('videoPrompt').value = template;
        updateGenerateButton();
        
        showStatus('✅ Idea template applied! Customize if needed.', 'info');
        setTimeout(() => {
          status.style.display = 'none';
        }, 2000);
      });
    });

    // AI Ideas button
    document.getElementById('aiIdeasBtn').addEventListener('click', async () => {
      fetchSuggestions();
    });

    // Refresh suggestions button
    document.getElementById('refreshSuggestionsBtn').addEventListener('click', fetchSuggestions);

    // Generate button
    generateBtn.addEventListener('click', generateVideo);

    // Regenerate button
    regenerateBtn.addEventListener('click', generateVideo);

    // Discard button
    discardBtn.addEventListener('click', () => {
      generatedVideoBlob = null;
      generatedVideoUrl = null;
      
      // Revoke the blob URL to free memory
      if (previewVideo.src.startsWith('blob:')) {
        URL.revokeObjectURL(previewVideo.src);
      }
      previewVideo.src = '';
      
      videoPreviewContainer.classList.remove('show');
      downloadBtn.style.display = 'none';
      downloadBtn.href = '';
      
      showStatus('🗑️ Video discarded. Generate a new one when ready.', 'info');
      setTimeout(() => {
        status.style.display = 'none';
      }, 3000);
    });

    // Use video button
    useVideoBtn.addEventListener('click', () => {
      platformSection.classList.remove('hidden');
      
      setTimeout(() => {
        platformSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
      
      showStatus('✅ Video approved! Select platforms and publish below.', 'success');
      setTimeout(() => {
        status.style.display = 'none';
      }, 3000);
      
      updatePublishButton();
    });

    // Platform selection
    document.querySelectorAll('.platform-btn:not([disabled])').forEach(btn => {
      btn.addEventListener('click', () => {
        btn.classList.toggle('selected');
        const platform = btn.dataset.platform;
        
        if (selectedPlatforms.includes(platform)) {
          selectedPlatforms = selectedPlatforms.filter(p => p !== platform);
        } else {
          selectedPlatforms.push(platform);
        }
        
        updateCost();
        updatePublishButton();
      });
    });

    // Publish button
    publishBtn.addEventListener('click', publishToSocials);

    // ========== INITIALIZE ON PAGE LOAD ==========
    document.addEventListener('DOMContentLoaded', () => {
      loadBusinessInfo();
      updateGenerateButton();
      updatePublishButton();
      updateCost();
    });
  </script>
</body>
</html>